<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>Class: LogDaily [Rails Application Documentation]</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <link href='.././rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Class</span>
          LogDaily
        </h1>
        <ol class='paths'>
          <li>
            <a href="../files/app/models/logging/log_daily_rb.html">app/models/logging/log_daily.rb</a>
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong><a href="LoggingModel.html">LoggingModel</a></strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            <p>
            A nugget of information derived from the master log (<a
            href="DataObjectLog.html">DataObjectLog</a>), intended to be optimized for
            data reporting purposes and not necessarily normalized for performance
            reasons.
            </p>
            <p>
            There are a number of pieces of data that we track for each <a
            href="LogDaily.html">LogDaily</a>. These are subject to change. For now, we
            include them all here.
            </p>
            <p>
            For performance reasons (or if these defaults conflict with other
            LogDailies we wish to create), we will likely remove some of these
            associations / validations.
            </p>
            <p>
            All <a href="LogDaily.html">LogDaily</a> classes should implement a few
            common class methods.
            </p>
            <p>
            <a href="LogDaily.html#M000403">LogDaily#mine</a> RANGE
            </p>
            <pre>go and mine data for a range and save the log objects</pre>
            <p>
            <a href="LogDaily.html#M000403">LogDaily#mine</a>
            </p>
            <pre>go and mine ALL data (no range given) and save the log objects</pre>
            <p>
            <a href="LogDaily.html#M000404">LogDaily#mine_data</a> RANGE
            </p>
            <pre>returns objects to save (fetches the data used by #mine)</pre>
            <p>
            <a href="LogDaily.html#M000404">LogDaily#mine_data</a>
            </p>
            <pre>returns objects to save (fetches the data used by #mine_all)</pre>
            <p>
            <a href="LogDaily.html#M000405">LogDaily#grand_totals</a>
            </p>
            <pre>returns the sum of the LogDaily#total for all records</pre>
            <p>
            <a href="LogDaily.html#M000405">LogDaily#grand_totals</a> RANGE
            </p>
            <pre>returns the sum of the LogDaily#total for a given range of records</pre>
            <p>
            <a href="LogDaily.html#M000394">LogDaily#unique_data</a>
            </p>
            <pre>returns the value of the LogDaily#unique_data_column ... LogDails objects all have a&#x000A;column with some kindof unique data that we're logging&#x000A;&#x000A;IMPORTANT: this currently assumes that we only have 1 column of unique data&#x000A;           which we're logging and we'll display.  this should be refactored&#x000A;           to handle any arbitrary number of columns and any arbitrary number&#x000A;           of views of this data.  Needs to be simpler but also more flexible.</pre>
            <p>
            <a href="LogDaily.html#M000400">LogDaily#create_table</a>
            </p>
            <pre>intended to be called within the context of an ActiveRecord::Migration, this should&#x000A;properly create a LogDaily table with the default columns.  it should take a block&#x000A;with the usual |t| parameter for defining any additional columns</pre>
            <p>
            Primary Maintainers
            </p>
            <ul>
            <li>Preston Lee <preston.lee@openrain.com>
            
            </li>
            <li>Remi Taylor <remi.taylor@openrain.com>
            
            </li>
            </ul>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public class</h3>
            <ol>
              <li><a href="#M000400">create_table</a></li>
              <li><a href="#M000401">drop_table</a></li>
              <li><a href="#M000402">find_or_paginate</a></li>
              <li><a href="#M000405">grand_totals</a></li>
              <li><a href="#M000403">mine</a></li>
              <li><a href="#M000404">mine_data</a></li>
              <li><a href="#M000397">path</a></li>
              <li><a href="#M000398">report_classes</a></li>
              <li><a href="#M000399">report_name</a></li>
              <li><a href="#M000393">set_mine_data_options</a></li>
              <li><a href="#M000392">set_unique_data_column</a></li>
              <li><a href="#M000396">unique_data_name</a></li>
            </ol>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000394">unique_data</a></li>
              <li><a href="#M000395">unique_data_to_s</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='constants-list'>
              <h2>Constants</h2>
              <div class='name-list'>
                <table summary='Constants'>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>DEFAULT_PER_PAGE</td>
                    <td>=</td>
                    <td class='context-item-value'>10 unless defined? DEFAULT_PER_PAGE</td>
                    <td>&nbsp;</td>
                    <td class='context-item-desc'>
                      
                      default :per_page argument for pagination
                    </td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='attribute-list'>
              <h2 class='section-bar'>Attributes</h2>
              <div class='name-list'>
                <table>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>percentage</td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'>
                      
                      if <a href="LogDaily.html#M000405">grand_totals</a> is called with
                      :include_percentage => true, <a
                      href="LogDaily.html#M000405">grand_totals</a> will set this column on all
                      returned objects using using total / the total of all objects (ungrouped)
                    </td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public class methods</h2>
              <div class='public-class method' id='method-M000400'>
                <a name='M000400'>      </a>
                <div class='synopsis'>
                  <span class='name'>create_table</span>
                  <span class='arguments'>(migration) {|t| ...}</span>
                </div>
                <div class='description'>
                  <p>
                  Helpers for migrations for creating new <a
                  href="LogDaily.html">LogDaily</a> models ###
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000400-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000400-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 188</span>&#x000A;188:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">create_table</span>(<span class="ruby-identifier">migration</span>)&#x000A;189:     <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">create_table</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">table_name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>&#x000A;190:       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> <span class="ruby-identifier">:data_type_id</span>, <span class="ruby-identifier">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>&#x000A;191:       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> <span class="ruby-identifier">:total</span>, <span class="ruby-identifier">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>&#x000A;192:       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> <span class="ruby-identifier">:agent_id</span>, <span class="ruby-identifier">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>&#x000A;193:       <span class="ruby-identifier">t</span>.<span class="ruby-identifier">date</span>    <span class="ruby-identifier">:day</span>, <span class="ruby-identifier">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>&#x000A;194: &#x000A;195:       <span class="ruby-keyword kw">unless</span> [ <span class="ruby-identifier">:data_type_id</span>, <span class="ruby-identifier">:total</span>, <span class="ruby-identifier">:agent_id</span>, <span class="ruby-identifier">:day</span> ].<span class="ruby-identifier">include?</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_column</span>.<span class="ruby-identifier">to_sym</span>&#x000A;196:         <span class="ruby-identifier">t</span>.<span class="ruby-identifier">column</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_column_info</span>[<span class="ruby-identifier">:name</span>], <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_column_info</span>[<span class="ruby-identifier">:type</span>], <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_column_info</span>[<span class="ruby-identifier">:options</span>]&#x000A;197:       <span class="ruby-keyword kw">end</span>&#x000A;198: &#x000A;199:       <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>&#x000A;200:     <span class="ruby-keyword kw">end</span>&#x000A;201:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000401'>
                <a name='M000401'>      </a>
                <div class='synopsis'>
                  <span class='name'>drop_table</span>
                  <span class='arguments'>(migration)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000401-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000401-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 203</span>&#x000A;203:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">drop_table</span>(<span class="ruby-identifier">migration</span>)&#x000A;204:     <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">drop_table</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">table_name</span>.<span class="ruby-identifier">to_sym</span>&#x000A;205:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000402'>
                <a name='M000402'>      </a>
                <div class='synopsis'>
                  <span class='name'>find_or_paginate</span>
                  <span class='arguments'>(first_argument, options = {})</span>
                </div>
                <div class='description'>
                  <p>
                  will run a find or a paginate call depending on whether pagination options
                  are included in the options passed. it&#8217;ll also set :per_page to a
                  default if it&#8217;s unset (and if :page is set) so you don&#8217;t have
                  to always pass :per_page in
                  </p>
                  <p>
                  if :page => :all or :page => &#8216;all&#8217;, pagination will NOT be used
                  </p>
                  <p>
                  TODO move this onto <a href="ActiveRecord/Base.html">ActiveRecord::Base</a>
                  so all models get it?
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000402-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000402-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 214</span>&#x000A;214:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_or_paginate</span> <span class="ruby-identifier">first_argument</span>, <span class="ruby-identifier">options</span> = {}&#x000A;215:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-identifier">:page</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:page</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'all'</span>&#x000A;216:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:per_page</span>] = <span class="ruby-constant">DEFAULT_PER_PAGE</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-identifier">:per_page</span>&#x000A;217:       <span class="ruby-identifier">paginate</span> <span class="ruby-identifier">first_argument</span>, <span class="ruby-identifier">options</span>&#x000A;218:     <span class="ruby-keyword kw">else</span>&#x000A;219:       <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:page</span>&#x000A;220:       <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:per_page</span>&#x000A;221:       <span class="ruby-identifier">find</span> <span class="ruby-identifier">first_argument</span>, <span class="ruby-identifier">options</span>&#x000A;222:     <span class="ruby-keyword kw">end</span>&#x000A;223:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000405'>
                <a name='M000405'>      </a>
                <div class='synopsis'>
                  <span class='name'>grand_totals</span>
                  <span class='arguments'>(date_range = nil, additional_options = {})</span>
                </div>
                <div class='description'>
                  <p>
                  Usage:
                  </p>
                  <pre>grand_totals :options =&gt; value&#x000A;grand_totals &lt;Date&gt;..&lt;Date&gt;, :options =&gt; value</pre>
                  <p>
                  see log_daily_spec for usage.
                  </p>
                  <p>
                  you can pass in options and they will override the options passed to find,
                  except for :conditions (you need to pass :override_conditions for that)
                  </p>
                  <p>
                  please pass your :conditions in as [&#8220;sql string with :keys&#8221;,
                  {:keys => &#8216;value&#8217;}] or they will explode :P
                  </p>
                  <p>
                  there are a few &#8216;special&#8217; options:
                  </p>
                  <pre>:agent =&gt; 5               # filter the results to just those for Agent with id 5&#x000A;:agent =&gt; Agent.find(5)   # filter the results to just those for Agent with id 5&#x000A;&#x000A;:include_percentage =&gt; true   # will add a .percentage to each item for the percentage its .total&#x000A;                              # represents out of ALL of the .total's for the query&#x000A;&#x000A;:override_conditions =&gt; true  # the :conditions passed will override all other :conditions</pre>
                  <p>
                  TODO test (spec) that :conditions work as expected, with and without
                  :override_conditions
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000405-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000405-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 278</span>&#x000A;278:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">grand_totals</span> <span class="ruby-identifier">date_range</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">additional_options</span> = {}&#x000A;279:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">date_range</span>.<span class="ruby-identifier">is_a?</span><span class="ruby-constant">Hash</span>&#x000A;280:       <span class="ruby-identifier">additional_options</span> = <span class="ruby-identifier">date_range</span>&#x000A;281:       <span class="ruby-identifier">date_range</span>         = <span class="ruby-keyword kw">nil</span>&#x000A;282:     <span class="ruby-keyword kw">end</span>&#x000A;283:     &#x000A;284:     <span class="ruby-identifier">agent_id</span>            = <span class="ruby-identifier">additional_options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:agent</span>&#x000A;285:     <span class="ruby-identifier">include_percentage</span>  = <span class="ruby-identifier">additional_options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:include_percentage</span>&#x000A;286:     <span class="ruby-identifier">override_conditions</span> = <span class="ruby-identifier">additional_options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:override_conditions</span>&#x000A;287: &#x000A;288:     <span class="ruby-identifier">conditions_sql</span>      = []&#x000A;289:     <span class="ruby-identifier">conditions_values</span>   = {}&#x000A;290: &#x000A;291:     <span class="ruby-comment cmt"># create the default #find options</span>&#x000A;292:     <span class="ruby-identifier">options</span> = { &#x000A;293:       <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;count(*) as count, sum(total) as total, agent_id, #{ self.unique_data_column }&quot;</span>, &#x000A;294:       <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{ self.unique_data_column }&quot;</span>,&#x000A;295:       <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;sum(total) DESC, #{ self.unique_data_column }&quot;</span>&#x000A;296:     }&#x000A;297: &#x000A;298:     <span class="ruby-comment cmt"># filter by date, if a date_range was passed in</span>&#x000A;299:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">date_range</span>&#x000A;300:       <span class="ruby-identifier">conditions_sql</span> <span class="ruby-operator">+=</span> [<span class="ruby-value str">&quot;day &gt;= :start_date&quot;</span>, <span class="ruby-value str">&quot;day &lt;= :end_date&quot;</span>]&#x000A;301:       <span class="ruby-identifier">conditions_values</span>.<span class="ruby-identifier">merge!</span>({ <span class="ruby-identifier">:start_date</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">date_range</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">:end_date</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">date_range</span>.<span class="ruby-identifier">last</span> })&#x000A;302:     <span class="ruby-keyword kw">end</span>&#x000A;303: &#x000A;304:     <span class="ruby-comment cmt"># filter by agent, if an agent was passed in</span>&#x000A;305:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">agent_id</span>&#x000A;306:       <span class="ruby-identifier">agent_id</span> = <span class="ruby-identifier">agent_id</span>.<span class="ruby-identifier">id</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">agent_id</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Agent</span> <span class="ruby-comment cmt"># we allow a Fixnum (id) or an Agent object</span>&#x000A;307:       <span class="ruby-identifier">conditions_sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;agent_id = :agent_id&quot;</span>&#x000A;308:       <span class="ruby-identifier">conditions_values</span>.<span class="ruby-identifier">merge!</span>({ <span class="ruby-identifier">:agent_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">agent_id</span> })&#x000A;309:     <span class="ruby-keyword kw">end</span>&#x000A;310: &#x000A;311:     <span class="ruby-comment cmt"># if :conditions were passed in and we're not overriding all of the conditions, add the conditions ( assuming [&quot;&quot;,{}] format )</span>&#x000A;312:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">additional_options</span>[<span class="ruby-identifier">:conditions</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">override_conditions</span>&#x000A;313:       <span class="ruby-identifier">conditions</span> = <span class="ruby-identifier">additional_options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:conditions</span>&#x000A;314:       <span class="ruby-identifier">conditions_sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">first</span>       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">empty?</span>&#x000A;315:       <span class="ruby-identifier">conditions_values</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">empty?</span>&#x000A;316:     <span class="ruby-keyword kw">end</span>&#x000A;317: &#x000A;318:     <span class="ruby-comment cmt"># build final :conditions to pass to #find</span>&#x000A;319:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">additional_options</span>[<span class="ruby-identifier">:conditions</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">override_conditions</span>&#x000A;320:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:conditions</span>] = [ <span class="ruby-identifier">conditions_sql</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' AND '</span>), <span class="ruby-identifier">conditions_values</span> ] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">conditions_sql</span>.<span class="ruby-identifier">empty?</span>&#x000A;321:     <span class="ruby-keyword kw">end</span>&#x000A;322: &#x000A;323:     <span class="ruby-comment cmt"># merge in the rest of the options</span>&#x000A;324:     <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">additional_options</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">additional_options</span>.<span class="ruby-identifier">empty?</span>&#x000A;325: &#x000A;326:     <span class="ruby-identifier">results</span> = <span class="ruby-identifier">find_or_paginate</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">options</span>&#x000A;327: &#x000A;328:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">include_percentage</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span>&#x000A;329:       <span class="ruby-comment cmt"># tweak options to get the total</span>&#x000A;330:       <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:group</span>&#x000A;331:       <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:page</span>&#x000A;332:       <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:per_page</span>&#x000A;333:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:select</span>] = <span class="ruby-value str">'sum(total) as total'</span>&#x000A;334: &#x000A;335:       <span class="ruby-comment cmt"># get the total</span>&#x000A;336:       <span class="ruby-identifier">total</span> = <span class="ruby-identifier">find</span>( <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">options</span> ).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">total</span>.<span class="ruby-identifier">to_f</span>&#x000A;337: &#x000A;338:       <span class="ruby-identifier">results</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">result</span><span class="ruby-operator">|</span>&#x000A;339:         <span class="ruby-identifier">result</span>.<span class="ruby-identifier">percentage</span> = ( <span class="ruby-identifier">result</span>.<span class="ruby-identifier">total</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">total</span> ) <span class="ruby-operator">*</span> <span class="ruby-value">100</span>&#x000A;340:       <span class="ruby-keyword kw">end</span>&#x000A;341:     <span class="ruby-keyword kw">end</span>&#x000A;342: &#x000A;343:     <span class="ruby-identifier">results</span>&#x000A;344:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000403'>
                <a name='M000403'>      </a>
                <div class='synopsis'>
                  <span class='name'>mine</span>
                  <span class='arguments'>(date_range = nil, additional_options = {})</span>
                </div>
                <div class='description'>
                  <p>
                  mine a date range
                  </p>
                  <p>
                  returns [(total number of items found),(number successfully mined),(number
                  skipped)]
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000403-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000403-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 230</span>&#x000A;230:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">mine</span> <span class="ruby-identifier">date_range</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">additional_options</span> = {}&#x000A;231:     <span class="ruby-identifier">data</span> = <span class="ruby-identifier">mine_data</span>(<span class="ruby-identifier">date_range</span>, <span class="ruby-identifier">additional_options</span>)&#x000A;232:     <span class="ruby-identifier">skipped</span> = <span class="ruby-value">0</span>&#x000A;233:     <span class="ruby-identifier">created</span> = <span class="ruby-value">0</span>&#x000A;234:     <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">log</span><span class="ruby-operator">|</span>&#x000A;235:       <span class="ruby-keyword kw">begin</span>&#x000A;236:         <span class="ruby-identifier">object</span> = <span class="ruby-identifier">create</span> <span class="ruby-identifier">log</span>.<span class="ruby-identifier">attributes</span> <span class="ruby-comment cmt"># ActiveRecord validation errors are silenced</span>&#x000A;237:         (<span class="ruby-identifier">object</span>.<span class="ruby-identifier">new_record?</span>) <span class="ruby-operator">?</span> (<span class="ruby-identifier">skipped</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">:</span> (<span class="ruby-identifier">created</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>)&#x000A;238:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">StatementInvalid</span> <span class="ruby-comment cmt"># Mysql::Error exceptions caught here, wrapped in StatementInvalid</span>&#x000A;239:         <span class="ruby-identifier">skipped</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>&#x000A;240:       <span class="ruby-keyword kw">end</span>&#x000A;241:     <span class="ruby-keyword kw">end</span>&#x000A;242:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">length</span>, <span class="ruby-identifier">created</span>, <span class="ruby-identifier">skipped</span>&#x000A;243:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000404'>
                <a name='M000404'>      </a>
                <div class='synopsis'>
                  <span class='name'>mine_data</span>
                  <span class='arguments'>(date_range = nil, additional_options = {})</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000404-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000404-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 245</span>&#x000A;245:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">mine_data</span> <span class="ruby-identifier">date_range</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">additional_options</span> = {}&#x000A;246:     <span class="ruby-identifier">options</span> = { <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;count(*) AS total, agent_id, data_type_id, DATE(data_object_logs.created_at) AS day, #{ self.unique_data_column }&quot;</span>, &#x000A;247:       <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;agent_id, data_type_id, #{ self.unique_data_column }, DATE(data_object_logs.created_at)&quot;</span> }&#x000A;248:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:conditions</span>] = [<span class="ruby-value str">&quot;DATE(data_object_logs.created_at) &gt;= ? AND DATE(data_object_logs.created_at) &lt;= ?&quot;</span>, <span class="ruby-identifier">date_range</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">date_range</span>.<span class="ruby-identifier">last</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">date_range</span>&#x000A;249:     <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">mine_data_options</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">mine_data_options</span>&#x000A;250:     <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">additional_options</span>     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">additional_options</span>&#x000A;251:     <span class="ruby-constant">DataObjectLog</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">options</span>&#x000A;252:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000397'>
                <a name='M000397'>      </a>
                <div class='synopsis'>
                  <span class='name'>path</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  a pretty URL path that this class is associated with &#8230; eg.
                  StateLogDaily.path => &#8216;states&#8217;
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000397-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000397-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 166</span>&#x000A;166:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">path</span>&#x000A;167:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/LogDaily$/</span>,<span class="ruby-value str">''</span>).<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">pluralize</span>&#x000A;168:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000398'>
                <a name='M000398'>      </a>
                <div class='synopsis'>
                  <span class='name'>report_classes</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  returns the *<a href="LogDaily.html">LogDaily</a> classes
                  </p>
                  <p>
                  this is currently updated <b>MANUALLY</b>
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000398-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000398-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 173</span>&#x000A;173:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">report_classes</span>&#x000A;174:     <span class="ruby-comment cmt"># self.subclasses</span>&#x000A;175:     [ <span class="ruby-constant">StateLogDaily</span>, <span class="ruby-constant">CountryLogDaily</span>, <span class="ruby-constant">UserLogDaily</span>, <span class="ruby-constant">AgentLogDaily</span>, <span class="ruby-constant">DataObjectLogDaily</span> ]&#x000A;176:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000399'>
                <a name='M000399'>      </a>
                <div class='synopsis'>
                  <span class='name'>report_name</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  a pretty title / name for the report that this class is associated with
                  (when we fetch <a href="LogDaily.html#M000405">grand_totals</a>) eg.
                  StateLogDaily.report_name => &#8216;States&#8217;
                  </p>
                  <p>
                  TODO make this overridable in classes, set_report_name &#8216;Blah&#8217;
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000399-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000399-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 182</span>&#x000A;182:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">report_name</span>&#x000A;183:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">camelize</span>.<span class="ruby-identifier">pluralize</span>&#x000A;184:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000393'>
                <a name='M000393'>      </a>
                <div class='synopsis'>
                  <span class='name'>set_mine_data_options</span>
                  <span class='arguments'>(options)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000393-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000393-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 100</span>&#x000A;100:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_mine_data_options</span> <span class="ruby-identifier">options</span>&#x000A;101:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">mine_data_options</span> = <span class="ruby-identifier">options</span>&#x000A;102:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000392'>
                <a name='M000392'>      </a>
                <div class='synopsis'>
                  <span class='name'>set_unique_data_column</span>
                  <span class='arguments'>(type, name, options = { :null =&gt; false })</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000392-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000392-source'>    <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 83</span>&#x000A;83:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_unique_data_column</span> <span class="ruby-identifier">type</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = { <span class="ruby-identifier">:null</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span> }&#x000A;84:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_column</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>&#x000A;85:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_column_info</span> = { <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">type</span>, <span class="ruby-identifier">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">:options</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span> }&#x000A;86: &#x000A;87:       <span class="ruby-comment cmt"># we validate the uniqueness of LogDaily objects per a given day, a unique data_type, </span>&#x000A;88:       <span class="ruby-comment cmt"># a unique agent, AND the custom bit of unique_data</span>&#x000A;89:       <span class="ruby-comment cmt">#</span>&#x000A;90:       <span class="ruby-comment cmt"># we stick the scope we're using within a class attribute: uniqueness_scope so </span>&#x000A;91:       <span class="ruby-comment cmt"># we can reuse it elsewhere, if desired</span>&#x000A;92:       <span class="ruby-comment cmt">#</span>&#x000A;93:       <span class="ruby-comment cmt"># actually, i thought i was going to reuse this, but i'm not currently reusing it anywhere, so ...</span>&#x000A;94:       <span class="ruby-comment cmt"># TODO remove uniqueness_scope ?</span>&#x000A;95:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">uniqueness_scope</span> = [ <span class="ruby-identifier">:agent_id</span>, <span class="ruby-identifier">:data_type_id</span> ]&#x000A;96:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">uniqueness_scope</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_column</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">uniqueness_scope</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">unique_data_column</span>.<span class="ruby-identifier">to_sym</span>&#x000A;97: &#x000A;98:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">validates_uniqueness_of</span> <span class="ruby-identifier">:day</span>, <span class="ruby-identifier">:scope</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">uniqueness_scope</span>&#x000A;99:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000396'>
                <a name='M000396'>      </a>
                <div class='synopsis'>
                  <span class='name'>unique_data_name</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  this will be deprecated when we change the way <a
                  href="LogDaily.html#M000394">unique_data</a> works and make it more
                  flexible
                  </p>
                  <p>
                  for now, this merely allow us to give a unique name to our unique data.
                  essentially:
                  </p>
                  <pre>unique_data_name:  the name of the daily log's data&#x000A;unique_data:       the value is unique_data&#x000A;unique_data_to_s:  the value to display is unique_data_to_s</pre>
                  <p>
                  override this in your <a href="LogDaily.html">LogDaily</a> class to return
                  something different
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000396-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000396-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 161</span>&#x000A;161:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_name</span>&#x000A;162:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">report_name</span>.<span class="ruby-identifier">singularize</span>&#x000A;163:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Public instance methods</h2>
              <div class='public-instance method' id='method-M000394'>
                <a name='M000394'>      </a>
                <div class='synopsis'>
                  <span class='name'>unique_data</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  returns the value of this daily&#8217;s unique data column (eg. state_code
                  or user_id)
                  </p>
                  <p>
                  TODO i want to change this to return a <a href="Hash.html">Hash</a> like {
                  :description => &#8216;blah&#8217;, :data_table => &#8216;xxx&#8217; }
                  </p>
                  <pre>and then i can use the keys as table column headers and whatnot ... this also means changing&#x000A;set_unique_data_column to set_unique_data_columns ...&#x000A;if i wanna be really hardcore i might allow a lambda (or something that responds to #call)&#x000A;as the value for the key, so it'll eval ONLY if you #call the value (IF the value responds to #call)&#x000A;... it might help optimize so we're lazily loading some things.  then again, we might want to&#x000A;eagerly load things to optimize as well</pre>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000394-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000394-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 114</span>&#x000A;114:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unique_data</span>&#x000A;115:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attributes</span>[ <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">unique_data_column</span> ]&#x000A;116:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000395'>
                <a name='M000395'>      </a>
                <div class='synopsis'>
                  <span class='name'>unique_data_to_s</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  override this if you want to return something custom (and pretty) when <a
                  href="LogDaily.html#M000394">unique_data</a> is printed out (we call <a
                  href="LogDaily.html#M000395">unique_data_to_s</a> from views which defaults
                  to unique_data.to_s)
                  </p>
                  <p>
                  this will be deprecated when <a
                  href="LogDaily.html#M000394">unique_data</a> becomes a hash
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000395-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000395-source'>     <span class="ruby-comment cmt"># File app/models/logging/log_daily.rb, line 148</span>&#x000A;148:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unique_data_to_s</span>&#x000A;149:     <span class="ruby-identifier">unique_data</span>.<span class="ruby-identifier">to_s</span>&#x000A;150:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
