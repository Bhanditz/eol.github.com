<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><title>Class: DataObject</title><link type="text/css" href=".././rdoc-style.css" media="screen" rel="stylesheet"/><script type="text/javascript">
// Allison template
// Copyright 2007, 2008 Cloudburst, LLC. Licensed under the AFL 3. See the included LICENSE file.

var href_base = '.././rdoc-style.css'.replace(/(.*\/).*/, '$1'); // inline js is good for something  

function $(id) {
    if (document.getElementById)
      elem = document.getElementById(id);
    else if ( document.all )
      elem = eval("document.all." + id);
    else
      return false;
    return elem;
}

  function toggle(id) {
    elem = $(id);
    elemStyle = elem.style;   
    if (elemStyle.display == "block") {
      elemStyle.display = "none"
    } else {
      elemStyle.display = "block"
    }
    return true;
  }

  function toggleText(id) {
    elem = $(id)
    if (m = elem.innerHTML.match(/(Hide)(.*)/)) {
      elem.innerHTML = "Show" + m[2];
    } else if (m = elem.innerHTML.match(/(Show)(.*)/)) {
      elem.innerHTML = "Hide" + m[2];
    }
    return true;
  }

function span(s, klass) {
  return '<span class="' + klass + '">' + s + '</span>';
}
  
function highlightSymbols() {
  pres = document.getElementsByTagName('pre');
  for(var i = 0; i < pres.length; i++) {
    pre = pres[i];
    spans = pre.getElementsByTagName('span');
    for(var k = 0; k < spans.length; k++) {
      span = spans[k];
      if (span.className.match(/ruby-identifier/)) {
        if (span.innerHTML.match(/^:/)) {
          span.className += " ruby-symbol";
        }
      }
    }
  }
}

 function hasClass(obj) {
     var result = false;
     if (obj.getAttributeNode("class") != null) {
         result = obj.getAttributeNode("class").value;
     }
     return result;
  }   

 function stripe() {
    var even = true;
    var color = "#e4ebed";
    var tables = document.getElementsByTagName('table');
    if (tables.length == 0) { return; }
    for (var h = 0; h < tables.length; h++) {
        var trs = tables[h].getElementsByTagName("tr");
        for (var i = 0; i < trs.length; i++) {
          var tds = trs[i].getElementsByTagName("td");
            for (var j = 0; j < tds.length; j++) {       
              if (hasClass(tds[j]) != "first") {                
              var mytd = tds[j];
              if (even) {
                mytd.style.backgroundColor = color;
              }         
            }
          }
          even =  ! even;
      }
    }
  }
  
function ajaxGet(url) {
  url = (href_base + url).replace('/./', '/')
  var req = false;

  if (window.ActiveXObject) {
    try {
      // stupid hack because IE7 disables local Ajax with the native xmlhttprequest object
      // for security purposes. Yet ActiveX still works. Thanks, Microsoft. I hate you. Die.
      req = new ActiveXObject("MSXML2.XMLHTTP.3.0");
    } catch (e) {
      try {
        /* IE 6 and maybe 5, don't know, don't care */
        req = new ActiveXObject("Msxml2.XMLHTTP");
      } catch (e) {
        try {
          req = new ActiveXObject("Microsoft.XMLHTTP");
        } catch (e) {
          req = false;
        }
      }
    }
  }
    
  /* real browsers */
  if (!req && window.XMLHttpRequest) {
    try {
      req = new XMLHttpRequest();
    } catch (e) {
      req = false;
    }
  } 
  
  if (req) {
    req.open('GET', url, false);
    req.send(null);
    return req.responseText;
  } else {
    return "Ajax error";  
  }
}


function addEvent(elm, evType, fn, useCapture) {
	if (elm.addEventListener) {
	  elm.addEventListener(evType, fn, useCapture);  
  	return true;
	} else if (elm.attachEvent) {
  	var r = elm.attachEvent('on' + evType, fn);  
	  return r;  
	} else {
  	elm['on' + evType] = fn;
	}
}

function insertIndices() {
  pages = ["class", "file", "method"]
  for (x in pages) { 
    $(pages[x]).innerHTML += ajaxGet('fr_' + pages[x] + '_index.html').replace(/(href=")/g, '$1' + href_base);
  }
  /* mouseoverify method links */
  links = $('method').getElementsByTagName('a');
  for (var x = 0; x < links.length; x++) {
    if (m = links[x].innerHTML.match(/(.*)\s\((.*)\)/)) {
      links[x].innerHTML = m[1] + '<br>';
      links[x].title = m[2];
    }
  }
  /* this is stupid */
  $('class').style.display = "block";
  $('file').style.display = "block";
  
  /* has to be here because IE7 does not guarantee the onLoad callback order */
  abbreviateIndicesInner(["class", "file"], 25, "a");
  /* same, linkTitle() depends on the class link list */
  linkTitle();
}

function abbreviateIndices() {
  var ids = ["defined_in", "child_of", "includes", "requires", "method", "methods"];
  abbreviateIndicesInner(ids, 25, 'a');
  abbreviateIndicesInner(ids, 25, 'span');
}

function abbreviateIndicesInner(indices, amount, tag) {
  for (var x = 0; x < indices.length; x++) { 
    var the_index = $(indices[x]);
    if (the_index) {
      links = the_index.getElementsByTagName(tag);
      for (var y = 0; y < links.length; y++) {
        var link = links[y];
        if (link.getElementsByTagName('span').length == 0 && link.getElementsByTagName('a').length == 0) {
          // avoid nesting
          link.innerHTML = link.innerHTML.replace(/<br>|\n/gi, '');
          link.title = link.innerHTML;
          link.innerHTML = abbreviate(link.innerHTML, amount) + '<br>';
        }
      }
    }
  }
}

function linkTitle() {
  
  /* grab the correct title element from the index */
  var index_page = ajaxGet('index.html');
  title_text = index_page.match(/<title>(.*)<\/title>/m)[1];
  document.title = title_text + " - " + document.title;
  var p = $('header').getElementsByTagName('p')[0]
  if (p.innerHTML.match(/^\s*$/)) {
    p.innerHTML = title_text;
  } else {
    p.innerHTML = title_text + ": " + p.innerHTML;
  }
  
  /* set the link properly */
  title_link = index_page.match(/<a\s+href="(.*?)"/)[1];
  var element = $('title');
  var item_type = "";
  var item_name = "";
  if (m = element.innerHTML.match(/(Class:|Module:|File:)\s*(.*)/)) {
    item_type = m[1];
    item_name = m[2];
  } else {
    item_name = element.innerHTML;
  }
  element.innerHTML = '<a href="' + href_base + title_link + '">' + item_type + " " + abbreviate(item_name, 45) + '</a>';
  element.getElementsByTagName('a')[0].title = item_name
  
  /* breadcrumb navigation */
  items = item_name.split("::");
  items_new = item_name.split("::");
  file_links = $('class').getElementsByTagName('a');
  for (var x = 0; x < items.length - 1; x++ ){
    var item = items[x];
    link = ("/classes/" + items.slice(0,x).join("/") + "/" + item + ".html").replace('//', '/');
    regex = new RegExp(RegExp.escape(link) + '$');
    for (var y = 0; y < file_links.length; y++) {
      if (file_links[y].href.match(regex)) {
         items_new[x] = '<a href="' + href_base + link + '">' + item + '</a>';
         break;
      }
    }  
  }
  $('item_name').innerHTML = item_type + ' ' + items_new.join(" :: ");
}

function abbreviate(s, size) {
  while (s.length > size) {
    var old_s = s;
    s = s.replace(/\s|\n/mg, '');
    s = s.replace(/([A-Z])[a-z]+/m, '$1');
    if (!s || old_s == s) {
      return "..." + s.substring(s.length - size, s.length);
    }
  }
  return s;
}

function disableSubmit(event) {
  var keyCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
  if (keyCode == 13) {
    return false;
  } else {
    return true;
  }
}
  
function filterList(id, s, event) {
  
  /* some weak escaping */
  s = s.replace(/[^\w\d\.\_\-\/\:\=\[\]\?\!]/g, '');
  s = RegExp.escape(s);
  
  var show_all = false;
  if (s.match(/^\s*$/)) {
    show_all = true;
  }
  
  links = $(id).getElementsByTagName('a')
  regex = new RegExp(s, 'i');
  
  for (var x = 0; x < links.length; x++) {
    var link = links[x];
    if (show_all) {
      link.style.display = 'inline';
    } else {
       if (link.innerHTML.match(regex)) {        
         link.style.display = 'inline';
       } else {
         link.style.display = 'none';
       }
    }
  }
  return true;
}

RegExp.escape = function(text) {
  if (!arguments.callee.sRE) {
    var specials = ['/', '.', '*', '+', '?', '|', '(', ')', '[', ']', '{', '}', '\\'];
    arguments.callee.sRE = new RegExp(
      '(\\' + specials.join('|\\') + ')', 'g'
    );
  }
  return text.replace(arguments.callee.sRE, '\\$1');
}

function hacks() {
  // show the spacer if necessary, 
  divs = document.getElementsByTagName('div');
  for(var x = 0; x < divs.length; x++) {
    if (divs[x].className && divs[x].className.match(/top/)) {
      document.getElementById('spacer').style.display = 'block';
    }
  }
  // remove extra colons from tables
  tds = document.getElementsByTagName('td');
  for(var x = 0; x < tds.length; x++) {
    str = tds[x].innerHTML
    if (str.charAt(str.length - 1) == ":") {
      tds[x].innerHTML = str.slice(0, str.length - 1)
    }
  }
}

addEvent(window, 'load', insertIndices, false);
addEvent(window, 'load', abbreviateIndices, false);
addEvent(window, 'load', stripe, false);
addEvent(window, 'load', highlightSymbols, false);
addEvent(window, 'load', hacks, false);
</script></head><body><div id="container"><div class="curve" id="preheader_curve_0"></div><div class="curve" id="preheader_curve_1"></div><div class="curve" id="preheader_curve_2"></div><div class="curve" id="preheader_curve_3"></div><div class="curve" id="preheader_curve_4"></div><div class="curve" id="preheader_curve_5"></div><div id="header"><p>
</p><span><h1 id="title">
Class: DataObject
</h1></span>
</div><div class="clear"></div><div id="left">
<div class="navigation darker top" id="child_of"><h3>Child of</h3><span>

<a href='SpeciesSchemaModel.html'>
SpeciesSchemaModel
</a>
</span></div>

<div class="navigation darker top" id="defined_in"><h3>Defined in</h3>

<a href="../files/app/models/data_object_rb.html">app/models/data_object.rb</a>

</div>



<div class="navigation top" id="methods"><h3>Methods</h3>


<a href='#M000345'>
attributions<br/>
</a>




<a href='#M000346'>
authors<br/>
</a>




<a href='#M000395'>
build_query<br/>
</a>




<a href='#M000354'>
cache_path<br/>
</a>




<a href='#M000393'>
cached_images_for_taxon<br/>
</a>




<a href='#M000341'>
comment<br/>
</a>




<a href='#M000374'>
curate!<br/>
</a>




<a href='#M000375'>
curated?<br/>
</a>




<a href='#M000344'>
data_supplier_agent<br/>
</a>




<a href='#M000348'>
fake_author<br/>
</a>




<a href='#M000394'>
for_taxon<br/>
</a>




<a href='#M000357'>
has_object_cache_url?<br/>
</a>




<a href='#M000356'>
has_thumbnail_cache?<br/>
</a>




<a href='#M000385'>
hide!<br/>
</a>




<a href='#M000373'>
hierarchy_entries<br/>
</a>




<a href='#M000351'>
image?<br/>
</a>




<a href='#M000355'>
image_cache_path<br/>
</a>




<a href='#M000343'>
images_for_hierarchy_entry<br/>
</a>




<a href='#M000388'>
inappropriate!<br/>
</a>




<a href='#M000378'>
inappropriate?<br/>
</a>




<a href='#M000377'>
invisible?<br/>
</a>




<a href='#M000342'>
is_curatable_by?<br/>
</a>




<a href='#M000382'>
is_vetted?<br/>
</a>




<a href='#M000352'>
map?<br/>
</a>




<a href='#M000363'>
map_image<br/>
</a>




<a href='#M000347'>
photographers<br/>
</a>




<a href='#M000366'>
private_tags<br/>
</a>




<a href='#M000365'>
public_tags<br/>
</a>




<a href='#M000390'>
search_by_tag<br/>
</a>




<a href='#M000391'>
search_by_tags<br/>
</a>




<a href='#M000392'>
search_tags_group<br/>
</a>




<a href='#M000384'>
show!<br/>
</a>




<a href='#M000361'>
smart_image<br/>
</a>




<a href='#M000360'>
smart_medium_thumb<br/>
</a>




<a href='#M000359'>
smart_thumb<br/>
</a>




<a href='#M000349'>
sources<br/>
</a>




<a href='#M000364'>
tag<br/>
</a>




<a href='#M000371'>
tag_keys<br/>
</a>




<a href='#M000370'>
tags_hash<br/>
</a>




<a href='#M000369'>
taxa_names_taxon_concept_ids<br/>
</a>




<a href='#M000372'>
taxon_concepts<br/>
</a>




<a href='#M000353'>
text?<br/>
</a>




<a href='#M000358'>
thumb_or_object<br/>
</a>




<a href='#M000389'>
to_s<br/>
</a>




<a href='#M000383'>
trusted?<br/>
</a>




<a href='#M000380'>
unknown?<br/>
</a>




<a href='#M000379'>
untrusted?<br/>
</a>




<a href='#M000387'>
unvet!<br/>
</a>




<a href='#M000367'>
user_tags<br/>
</a>




<a href='#M000368'>
users_tags<br/>
</a>




<a href='#M000386'>
vet!<br/>
</a>




<a href='#M000381'>
vetted?<br/>
</a>




<a href='#M000362'>
video_url<br/>
</a>




<a href='#M000376'>
visible?<br/>
</a>




<a href='#M000350'>
visible_comments<br/>
</a>


</div>
<div id="spacer"></div><div class="navigation darker index" id="class_wrapper"><div class="list_header"><h3>All classes</h3></div><div class="list_header_link"><a onclick="toggle('class'); toggleText('class_link'); return false;" href="#" id="class_link">Hide...</a></div><div class="clear"></div><div id="class"><form><label for="filter_class">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('class', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_class"></input></form></div></div><div class="navigation darker index" id="file_wrapper"><div class="list_header"><h3>All files</h3></div><div class="list_header_link"><a onclick="toggle('file'); toggleText('file_link'); return false;" href="#" id="file_link">Hide...</a></div><div class="clear"></div><div id="file"><form><label for="filter_file">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('file', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_file"></input></form></div></div><div class="navigation darker index" id="method_wrapper"><div class="list_header"><h3>All methods</h3></div><div class="list_header_link"><a onclick="toggle('method'); toggleText('method_link'); return false;" href="#" id="method_link">Show...</a></div><div class="clear"></div><div id="method"><form><label for="filter_method">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('method', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_method"></input></form></div></div></div><div id="content">
<h1 id="item_name">Class: DataObject</h1>





<p></p>




<h1>Attributes</h1><p><table><tr><th>Name</th><th>Read/write?</th></tr>
<tr>
<td class="highlight">vetted_by</td>




<td class="normal">RW</td>
</tr>
</table></p>


<h1>Public Class Methods</h1>


<a class="small" name="M000395"><br/></a>
<div class="method_block"><h3>
<a href='#M000395'>


build_query

(taxon, type, options)

</a>
</h3>
<p>
TODO - MED PRIORITY - I&#8216;m assuming there&#8216;s one taxa for this
data object, and there could be several. TODO = licenses should simply be
included, and referenced directly where needed.
</p>

<p class="source_link" id="M000395-show-link"><a onclick="toggle('M000395-source'); toggleText('M000395-link'); return false;" href="#" id="M000395-link">Show source...</a></p><div class="source" id="M000395-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 500</span>
500:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">build_query</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">options</span>)
501:     <span class="ruby-identifier">add_toc</span>      = (<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:text</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:toc_id</span>].<span class="ruby-identifier">nil?</span>) <span class="ruby-operator">?</span> <span class="ruby-value str">', toc.*'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">''</span>
502:     <span class="ruby-identifier">join_agents</span>  = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:agent</span>].<span class="ruby-identifier">nil?</span>  <span class="ruby-value">? </span><span class="ruby-value str">''</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">join_agents_clause</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:agent</span>])
503:     <span class="ruby-identifier">join_toc</span>     = <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:text</span>         <span class="ruby-operator">?</span> <span class="ruby-value str">'JOIN data_objects_table_of_contents dotoc ON dotoc.data_object_id = dato.id '</span> <span class="ruby-operator">+</span>
504:                                                  <span class="ruby-value str">'JOIN table_of_contents toc ON toc.id = dotoc.toc_id'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">''</span>
505:     <span class="ruby-identifier">where_toc</span>    = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:toc_id</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">''</span> <span class="ruby-operator">:</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-value str">'AND toc.id = ?'</span>, <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:toc_id</span>]])
506:     <span class="ruby-identifier">sort</span>         = <span class="ruby-value str">'dato.published, dato.vetted_id DESC, dato.data_rating'</span> <span class="ruby-comment cmt"># unpublished first, then by data_rating.</span>
507: 
508:     <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">sanitize_sql</span>([<span class="ruby-value str">&quot;\nSELECT DISTINCT dt.label media_type, dato.*, t.scientific_name, tcn.taxon_concept_id taxon_id,\n       l.description license_text, l.logo_url license_logo, l.source_url license_url \#{add_toc}\n  FROM taxon_concept_names tcn\n    STRAIGHT_JOIN taxa t                ON (tcn.name_id = t.name_id)\n    STRAIGHT_JOIN data_objects_taxa dot ON (t.id = dot.taxon_id)\n    STRAIGHT_JOIN data_objects dato     ON (dot.data_object_id = dato.id)\n    STRAIGHT_JOIN data_types dt         ON (dato.data_type_id = dt.id)\n    \#{join_agents} \#{join_toc}\n    LEFT OUTER JOIN licenses l       ON (dato.license_id = l.id)\n  WHERE tcn.taxon_concept_id = ?\n    AND data_type_id IN (?)\n    \#{DataObject.visibility_clause(options.merge(:taxon =&gt; taxon))}\n    \#{where_toc}\n  ORDER BY \#{sort} # DataObject.for_taxon\n\n&quot;</span>, <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>, <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">get_type_ids</span>(<span class="ruby-identifier">type</span>)])
509: 
510:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000354"><br/></a>
<div class="method_block"><h3>
<a href='#M000354'>


cache_path

(cache_url, subdir = $CONTENT_SERVER_CONTENT_PATH)

</a>
</h3>

<p class="source_link" id="M000354-show-link"><a onclick="toggle('M000354-source'); toggleText('M000354-link'); return false;" href="#" id="M000354-link">Show source...</a></p><div class="source" id="M000354-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 189</span>
189:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cache_path</span>(<span class="ruby-identifier">cache_url</span>, <span class="ruby-identifier">subdir</span> = <span class="ruby-identifier">$CONTENT_SERVER_CONTENT_PATH</span>)
190:     (<span class="ruby-constant">ContentServer</span>.<span class="ruby-identifier">next</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">subdir</span> <span class="ruby-operator">+</span>
191:       <span class="ruby-identifier">cache_url</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/(\d{4})(\d{2})(\d{2})(\d{2})(\d+)/</span>, <span class="ruby-value str">&quot;/\\1/\\2/\\3/\\4/\\5&quot;</span>))
192:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000393"><br/></a>
<div class="method_block"><h3>
<a href='#M000393'>


cached_images_for_taxon

(taxon, options = {})

</a>
</h3>

<p class="source_link" id="M000393-show-link"><a onclick="toggle('M000393-source'); toggleText('M000393-link'); return false;" href="#" id="M000393-link">Show source...</a></p><div class="source" id="M000393-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 447</span>
447:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cached_images_for_taxon</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">options</span> = {})
448:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>] = <span class="ruby-constant">User</span>.<span class="ruby-identifier">create_new</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">nil?</span>
449:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:from</span>].<span class="ruby-identifier">nil?</span>
450:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:from</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">'top_images'</span>
451:     <span class="ruby-keyword kw">else</span>
452:       <span class="ruby-identifier">nested</span> = <span class="ruby-keyword kw">true</span>
453:     <span class="ruby-keyword kw">end</span>
454:     <span class="ruby-identifier">join_agents</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:agent</span>].<span class="ruby-identifier">nil?</span>  <span class="ruby-value">? </span><span class="ruby-value str">''</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">join_agents_clause</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:agent</span>]) <span class="ruby-keyword kw">if</span>
455:         <span class="ruby-identifier">nested</span>
456:     <span class="ruby-comment cmt"># NOTE - left join on the licenses, so they could be NULL.</span>
457:     <span class="ruby-comment cmt"># (But we don't want to miss images with no license!)</span>
458:     
459:     <span class="ruby-comment cmt">#pp options</span>
460:     
461:     <span class="ruby-identifier">result</span>=<span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">find_by_sql</span>([<span class="ruby-node">%Q{SELECT dato.*, l.description license_text, l.logo_url license_logo, l.source_url license_url,
462:                                       (?) taxon_id, t.scientific_name
463:                                 FROM #{options[:from]} ti
464:                                   STRAIGHT_JOIN data_objects dato      ON ti.data_object_id = dato.id
465:                                   STRAIGHT_JOIN data_objects_taxa dot  ON dato.id = dot.data_object_id
466:                                   STRAIGHT_JOIN taxa t                 ON dot.taxon_id = t.id
467:                                   #{join_agents}
468:                                   LEFT JOIN licenses l        ON dato.license_id = l.id 
469:                                 WHERE ti.hierarchy_entry_id IN (?)
470:                                   AND data_type_id IN (?)
471:                                   #{DataObject.visibility_clause(options.merge(:taxon =&gt; taxon))}
472:                                   GROUP BY dato.id
473:                                 ORDER BY dato.vetted_id DESC,dato.data_rating                          # DataObject.cached_images_for_taxon }</span>,
474:                             <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">hierarchy_entries</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">he</span><span class="ruby-operator">|</span> <span class="ruby-identifier">he</span>.<span class="ruby-identifier">id</span> }, <span class="ruby-constant">DataType</span>.<span class="ruby-identifier">image_type_ids</span>])                            
475:     <span class="ruby-comment cmt"># Run a second query if we need unpublished or invisible images (but not if we're already doing it!!!):</span>
476:     <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">nested</span> <span class="ruby-keyword kw">and</span> ((<span class="ruby-keyword kw">not</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:agent</span>].<span class="ruby-identifier">nil?</span>) <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">is_curator?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">is_admin?</span>)
477:       <span class="ruby-identifier">result</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">cached_images_for_taxon</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">:from</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'top_unpublished_images'</span>))
478:     <span class="ruby-keyword kw">end</span>
479:     <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">includes_unvetted</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">vetted_id</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Vetted</span>.<span class="ruby-identifier">trusted</span>.<span class="ruby-identifier">id</span> }
480:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>                            
481:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000394"><br/></a>
<div class="method_block"><h3>
<a href='#M000394'>


for_taxon

(taxon, type, options = {})

</a>
</h3>

<p class="source_link" id="M000394-show-link"><a onclick="toggle('M000394-source'); toggleText('M000394-link'); return false;" href="#" id="M000394-link">Show source...</a></p><div class="source" id="M000394-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 483</span>
483:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">for_taxon</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">options</span> = {})
484:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>] = <span class="ruby-constant">User</span>.<span class="ruby-identifier">create_new</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">nil?</span>
485:     
486:     <span class="ruby-comment cmt"># Just return the (much faster) cached images if there is no need to deal with permissions:</span>
487:     <span class="ruby-comment cmt"># TODO - does this next line need to move to the bottom, to ADD these images?  I think not, but we should check.</span>
488:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">cached_images_for_taxon</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">options</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:image</span>
489:     <span class="ruby-identifier">klass</span> = (<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:text</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:toc_id</span>].<span class="ruby-identifier">nil?</span>) <span class="ruby-operator">?</span> <span class="ruby-constant">TocItem</span> <span class="ruby-operator">:</span> <span class="ruby-constant">DataObject</span>
490:     <span class="ruby-comment cmt"># puts &quot;---- BIG QUERY &quot; + '-' * 40</span>
491:     <span class="ruby-comment cmt"># puts DataObject.build_query(taxon, type, options)</span>
492:     <span class="ruby-comment cmt"># puts '-' * 60</span>
493:     <span class="ruby-identifier">results</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">build_query</span>(<span class="ruby-identifier">taxon</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">options</span>))
494:     <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">includes_unvetted</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">results</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">vetted_id</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Vetted</span>.<span class="ruby-identifier">trusted</span>.<span class="ruby-identifier">id</span> }
495:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">results</span>
496:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000355"><br/></a>
<div class="method_block"><h3>
<a href='#M000355'>


image_cache_path

(cache_url, size = :large, subdir = $CONTENT_SERVER_CONTENT_PATH)

</a>
</h3>

<p class="source_link" id="M000355-show-link"><a onclick="toggle('M000355-source'); toggleText('M000355-link'); return false;" href="#" id="M000355-link">Show source...</a></p><div class="source" id="M000355-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 194</span>
194:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">image_cache_path</span>(<span class="ruby-identifier">cache_url</span>, <span class="ruby-identifier">size</span> = <span class="ruby-identifier">:large</span>, <span class="ruby-identifier">subdir</span> = <span class="ruby-identifier">$CONTENT_SERVER_CONTENT_PATH</span>)
195:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cache_path</span>(<span class="ruby-identifier">cache_url</span>, <span class="ruby-identifier">subdir</span>) <span class="ruby-operator">+</span> <span class="ruby-node">&quot;_#{size}.#{$SPECIES_IMAGE_FORMAT}&quot;</span>
196:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000343"><br/></a>
<div class="method_block"><h3>
<a href='#M000343'>


images_for_hierarchy_entry

(he_id)

</a>
</h3>
<p>
TODO - this is broken, but unused. When we start using it again, it must be
fixed.
</p>

<p class="source_link" id="M000343-show-link"><a onclick="toggle('M000343-source'); toggleText('M000343-link'); return false;" href="#" id="M000343-link">Show source...</a></p><div class="source" id="M000343-source"><pre>    <span class="ruby-comment cmt"># File app/models/data_object.rb, line 50</span>
50:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">images_for_hierarchy_entry</span>(<span class="ruby-identifier">he_id</span>)
51:     <span class="ruby-comment cmt"># NOTE - left join on the licenses, so they could be NULL.</span>
52:     <span class="ruby-comment cmt"># (But we don't want to miss images with no license!)</span>
53:     <span class="ruby-comment cmt"># TODO - MED PRIORITY - I'm assuming there's one HE for this data object, and there could be several.</span>
54:     <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">find_by_sql</span>([<span class="ruby-value str">%q{SELECT DISTINCT do.*, l.description license_text, l.logo_url license_logo, l.source_url license_url,
55:                                       hierarchy_entry_id taxon_id, t.scientific_name
56:                                 FROM top_images ti JOIN hierarchy_entry_names hen USING (hierarchy_entry_id)
57:                                   JOIN data_objects do        ON ti.data_object_id = do.id
58:                                   JOIN data_objects_taxa dot  ON do.id = dot.data_object_id
59:                                   JOIN taxa t                 ON dot.taxon_id = t.id
60:                                   LEFT OUTER JOIN licenses l  ON do.license_id = l.id 
61:                                 WHERE hierarchy_entry_id = ? AND data_type_id IN (?) AND visibility_id = 1
62:                                 ORDER BY ti.view_order     # images_for_hierarchy_entry }</span>,
63:                             <span class="ruby-identifier">he_id</span>, <span class="ruby-constant">DataType</span>.<span class="ruby-identifier">image_type_ids</span>])
64:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000390"><br/></a>
<div class="method_block"><h3>
<a href='#M000390'>


search_by_tag

(key_or_tag, value_or_nil = nil, options = {})

</a>
</h3>
<p>
Find data objects tagged with a particular <a
href="DataObject.html#M000364">tag</a>
</p>
<p>
If no &#8216;value&#8217; is provided for the <a
href="DataObject.html#M000364">tag</a>, it will find all data objects
tagged with <b>any</b> value of the given key (category)
</p>
<p>
Usage:
</p>
<pre>
  DataObject.search_by_tag :color, 'blue'
  DataObject.search_by_tag :color, :blue
  DataObject.search_by_tag &lt;DataObjecTag&gt;
</pre>
<p>
TODO this is starting to get really messy &#8230; extract some of this
outta here into objects &#8230;
</p>
<pre>
     try a named_scope on TopImage and things like that ... move to other models or to other
     DataObject methods
</pre>

<p class="source_link" id="M000390-show-link"><a onclick="toggle('M000390-source'); toggleText('M000390-link'); return false;" href="#" id="M000390-link">Show source...</a></p><div class="source" id="M000390-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 374</span>
374:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">search_by_tag</span> <span class="ruby-identifier">key_or_tag</span>, <span class="ruby-identifier">value_or_nil</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">options</span> = {}
375:     <span class="ruby-identifier">tag</span> = (<span class="ruby-identifier">key_or_tag</span>.<span class="ruby-identifier">is_a?</span><span class="ruby-constant">DataObjectTag</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">key_or_tag</span> <span class="ruby-operator">:</span> <span class="ruby-constant">DataObjectTag</span>[<span class="ruby-identifier">key_or_tag</span>, <span class="ruby-identifier">value_or_nil</span>]
376:     <span class="ruby-identifier">data_object_tags</span> = (<span class="ruby-identifier">tag</span>) <span class="ruby-operator">?</span> <span class="ruby-constant">DataObjectTags</span>.<span class="ruby-identifier">search_by_tag</span>( <span class="ruby-identifier">tag</span> ) <span class="ruby-operator">:</span> []
377:     <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">data_object_tags</span>.<span class="ruby-identifier">empty?</span>
378:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>]
379:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>] = [ <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>] ] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>].<span class="ruby-identifier">is_a?</span><span class="ruby-constant">Array</span>
380:       <span class="ruby-identifier">data_object_ids</span> = <span class="ruby-identifier">data_object_tags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:data_object_id</span>).<span class="ruby-identifier">uniq</span>
381:       <span class="ruby-identifier">clades</span> = <span class="ruby-constant">HierarchyEntry</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>].<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;id = #{id}&quot;</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' OR '</span>)
382:       <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">clades</span>.<span class="ruby-identifier">empty?</span>
383:       <span class="ruby-identifier">sql</span> = <span class="ruby-value str">%[
384:         SELECT DISTINCT top_images.data_object_id
385:         FROM top_images 
386:         JOIN hierarchy_entries ON top_images.hierarchy_entry_id = hierarchy_entries.id
387:         WHERE ]</span>
388:       <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">clades</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">clade</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;(hierarchy_entries.lft &gt;= #{clade.lft} AND hierarchy_entries.lft &lt;= #{clade.rgt})&quot;</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' OR '</span>)
389:       <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-node">%[ AND data_object_id IN (#{data_object_ids.join(',')})]</span>
390:       <span class="ruby-identifier">tagged_images_in_clade</span> = <span class="ruby-constant">TopImage</span>.<span class="ruby-identifier">find_by_sql</span> <span class="ruby-identifier">sql</span>
391:       <span class="ruby-identifier">tagged_images_in_clade</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">img</span><span class="ruby-operator">|</span> <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">img</span>.<span class="ruby-identifier">data_object_id</span>) }.<span class="ruby-identifier">uniq</span>
392:     <span class="ruby-keyword kw">else</span>
393:       <span class="ruby-identifier">data_object_tags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:object</span>).<span class="ruby-identifier">uniq</span>
394:     <span class="ruby-keyword kw">end</span>
395:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000391"><br/></a>
<div class="method_block"><h3>
<a href='#M000391'>


search_by_tags

(tags, options = {})

</a>
</h3>
<p>
Find data objects tagged with certain tags
</p>
<p>
Usage:
</p>
<pre>
  DataObject.search_by_tags [ [&lt;DataObjecTag&gt;], [&lt;DataObjectTag&gt;, &lt;DataObjectTag] ]
  DataObject.search_by_tags [ [[:key1,'value1']], [[:key2,:value2],['key3',:value3]] ]
</pre>
<p>
TODO: Optimization is necessary, the way it is now is quite resource hungry
</p>

<p class="source_link" id="M000391-show-link"><a onclick="toggle('M000391-source'); toggleText('M000391-link'); return false;" href="#" id="M000391-link">Show source...</a></p><div class="source" id="M000391-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 404</span>
404:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">search_by_tags</span> <span class="ruby-identifier">tags</span>, <span class="ruby-identifier">options</span> = {}
405:     <span class="ruby-identifier">t</span> = <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">inject</span>([]) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">res</span>,<span class="ruby-identifier">tags_group</span><span class="ruby-operator">|</span>
406:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tags_group</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DataObjectTag</span>)
407:         <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tags_group</span>
408:       <span class="ruby-keyword kw">else</span>
409:         <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tags_group</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-constant">DataObjectTag</span>[<span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span>]}
410:       <span class="ruby-keyword kw">end</span>
411:     <span class="ruby-keyword kw">end</span>
412:     <span class="ruby-identifier">result</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">res</span>, <span class="ruby-identifier">tags_group</span><span class="ruby-operator">|</span>
413:       <span class="ruby-identifier">search</span> = (<span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">search_tags_group</span>(<span class="ruby-identifier">tags_group</span>, <span class="ruby-identifier">options</span>).<span class="ruby-identifier">to_set</span>)
414:       <span class="ruby-identifier">res</span> = <span class="ruby-identifier">res</span> <span class="ruby-value">? </span><span class="ruby-identifier">search</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">intersection</span>(<span class="ruby-identifier">search</span>)
415:     <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">to_a</span>
416:     <span class="ruby-identifier">result</span>
417:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000392"><br/></a>
<div class="method_block"><h3>
<a href='#M000392'>


search_tags_group

(tags, options)

</a>
</h3>

<p class="source_link" id="M000392-show-link"><a onclick="toggle('M000392-source'); toggleText('M000392-link'); return false;" href="#" id="M000392-link">Show source...</a></p><div class="source" id="M000392-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 419</span>
419:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">search_tags_group</span> <span class="ruby-identifier">tags</span>, <span class="ruby-identifier">options</span>
420:     <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">compact!</span>
421:     <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">empty?</span>
422:     <span class="ruby-identifier">data_object_tags</span> = <span class="ruby-constant">DataObjectTags</span>.<span class="ruby-identifier">search_by_tags_or</span> <span class="ruby-identifier">tags</span>, <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user_id</span>]
423:     <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">data_object_tags</span>.<span class="ruby-identifier">empty?</span>
424: 
425:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>]
426: 
427:       <span class="ruby-comment cmt"># TODO - THIS HAS BEEN COPY/PASTED - ***JUST*** FOR TESTING - NEEDS REFACTORING &amp; TO BE DRY'd UP</span>
428:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>] = [ <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>] ] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>].<span class="ruby-identifier">is_a?</span><span class="ruby-constant">Array</span>
429:       <span class="ruby-identifier">data_object_ids</span> = <span class="ruby-identifier">data_object_tags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:data_object_id</span>).<span class="ruby-identifier">uniq</span>
430:       <span class="ruby-identifier">clades</span> = <span class="ruby-constant">HierarchyEntry</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:clade</span>].<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;id = #{self.id}&quot;</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' OR '</span>)
431:       <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">clades</span>.<span class="ruby-identifier">empty?</span>
432:       <span class="ruby-identifier">sql</span> = <span class="ruby-value str">%[
433:         SELECT DISTINCT top_images.data_object_id
434:         FROM top_images 
435:         JOIN hierarchy_entries ON top_images.hierarchy_entry_id = hierarchy_entries.id
436:         WHERE ]</span>
437:       <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">clades</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">clade</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;(hierarchy_entries.lft &gt;= #{clade.lft} AND hierarchy_entries.lft &lt;= #{clade.rgt})&quot;</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' OR '</span>)
438:       <span class="ruby-identifier">sql</span> <span class="ruby-operator">+=</span> <span class="ruby-node">%[ AND data_object_id IN (#{data_object_ids.join(',')})]</span>
439:       <span class="ruby-identifier">tagged_images_in_clade</span> = <span class="ruby-constant">TopImage</span>.<span class="ruby-identifier">find_by_sql</span> <span class="ruby-identifier">sql</span>
440:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">tagged_images_in_clade</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">img</span><span class="ruby-operator">|</span> <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">img</span>.<span class="ruby-identifier">data_object_id</span>) }.<span class="ruby-identifier">uniq</span>
441: 
442:     <span class="ruby-keyword kw">else</span>
443:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">data_object_tags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:object</span>).<span class="ruby-identifier">uniq</span>
444:     <span class="ruby-keyword kw">end</span>
445:   <span class="ruby-keyword kw">end</span></pre></div>
</div>


<h1>Public Instance Methods</h1>


<a class="small" name="M000345"><br/></a>
<div class="method_block"><h3>
<a href='#M000345'>


attributions

()

</a>
</h3>
<p>
gets agents_data_objects, sorted by <a href="AgentRole.html">AgentRole</a>,
based on this objects&#8217; DataTypes&#8217; <a
href="AgentRole.html">AgentRole</a> attribution priorities
</p>
<p>
we also fetch agents_data_objects, including (eager loading) Agents by
default, assuming we will be using them
</p>
<p>
TODO clean this up. needs to be broken down into different methods. this
was clean until we added abunchof denormalizations
</p>

<p class="source_link" id="M000345-show-link"><a onclick="toggle('M000345-source'); toggleText('M000345-link'); return false;" href="#" id="M000345-link">Show source...</a></p><div class="source" id="M000345-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 75</span>
 75:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">attributions</span>
 76:     <span class="ruby-comment cmt"># for each of the agent roles in the attribution order, go thru agents_data_objects and </span>
 77:     <span class="ruby-comment cmt"># get all of the agents in that role =&gt; [ [role1, role1], nil, [role3], [role4], nil ]</span>
 78:     <span class="ruby-identifier">grouped_by_agent_role</span> = <span class="ruby-identifier">data_type</span>.<span class="ruby-identifier">full_attribution_order</span>.<span class="ruby-identifier">inject</span>([]) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">all</span>, <span class="ruby-identifier">agent_role</span><span class="ruby-operator">|</span>
 79:       <span class="ruby-identifier">all</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">agents_data_objects</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">ado</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ado</span>.<span class="ruby-identifier">agent_role</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">agent_role</span> }
 80:       <span class="ruby-identifier">all</span>
 81:     <span class="ruby-keyword kw">end</span>
 82:     
 83:     <span class="ruby-comment cmt"># get rid of nils and sort the groups by view_order</span>
 84:     <span class="ruby-identifier">grouped_by_agent_role</span>.<span class="ruby-identifier">compact!</span>
 85:     <span class="ruby-identifier">grouped_by_agent_role</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">group</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
 86:       <span class="ruby-identifier">grouped_by_agent_role</span>[<span class="ruby-identifier">i</span>] = <span class="ruby-identifier">group</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">view_order</span> }
 87:     <span class="ruby-keyword kw">end</span>
 88: 
 89:     <span class="ruby-comment cmt"># now, go through and put everything into 1 ordered list, no longer grouped</span>
 90:     <span class="ruby-identifier">grouped_by_agent_role</span> = <span class="ruby-identifier">grouped_by_agent_role</span>.<span class="ruby-identifier">inject</span>([]) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">all</span>, <span class="ruby-identifier">sorted_group</span><span class="ruby-operator">|</span>
 91:       <span class="ruby-identifier">all</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">sorted_group</span>
 92:       <span class="ruby-identifier">all</span>
 93:     <span class="ruby-keyword kw">end</span>
 94: 
 95:     <span class="ruby-comment cmt"># we need to manually add the Data Supplier too ... TODO extract these custom things into the full_attribution_order method (or something?)</span>
 96:     <span class="ruby-identifier">supplier</span> = <span class="ruby-identifier">data_supplier_agent</span>
 97:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">supplier</span>
 98:       <span class="ruby-identifier">index_to_insert_data_supplier</span> = <span class="ruby-value">0</span>
 99:       <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">grouped_by_agent_role</span>[<span class="ruby-identifier">index_to_insert_data_supplier</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">grouped_by_agent_role</span>[<span class="ruby-identifier">index_to_insert_data_supplier</span>].<span class="ruby-identifier">agent_role</span> <span class="ruby-operator">==</span> <span class="ruby-constant">AgentRole</span>[<span class="ruby-identifier">:Author</span>]
100:         <span class="ruby-identifier">index_to_insert_data_supplier</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
101:       <span class="ruby-keyword kw">end</span>
102:       <span class="ruby-identifier">grouped_by_agent_role</span>.<span class="ruby-identifier">insert</span> <span class="ruby-identifier">index_to_insert_data_supplier</span>, <span class="ruby-constant">AgentsDataObject</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">supplier</span>, 
103:                                                               <span class="ruby-identifier">:agent_role</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">AgentRole</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:label</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'Supplier'</span>), <span class="ruby-identifier">:view_order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> )
104:     <span class="ruby-keyword kw">end</span>
105: 
106:     <span class="ruby-comment cmt"># now, we need to go in and put the rights statement ... this is very hacky but the </span>
107:     <span class="ruby-comment cmt"># rights statement is supposed to show up after the Source, but it's not actually an attribution</span>
108:     <span class="ruby-comment cmt"># so ... we have to stick it into the list somehow for it to show up  :/</span>
109:     <span class="ruby-comment cmt"># </span>
110:     <span class="ruby-comment cmt"># it should show up *after* Source, if it exists, else Author, else it should show up first</span>
111:     <span class="ruby-comment cmt">#</span>
112:     <span class="ruby-comment cmt">#</span>
113:     <span class="ruby-comment cmt"># TODO this needs some serious cleanup</span>
114:     <span class="ruby-comment cmt">#</span>
115:     <span class="ruby-identifier">a_license</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">license</span>
116:     <span class="ruby-identifier">a_license</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">License</span>.<span class="ruby-identifier">find_by_title</span>(<span class="ruby-value str">'public domain'</span>) <span class="ruby-comment cmt"># if there's no license, we wanna display the 'No right reserved' license (aka public domain)</span>
117:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">rights_statement</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">a_license</span>.<span class="ruby-identifier">nil?</span>
118:       <span class="ruby-identifier">roles_to_insert_after</span> = <span class="ruby-constant">AgentRole</span>[ <span class="ruby-identifier">:Author</span>, <span class="ruby-identifier">:Source</span> ]
119:       <span class="ruby-identifier">index_to_insert_rights</span> = <span class="ruby-value">0</span>
120:       <span class="ruby-comment cmt"># logo_cache_url isn't working, nor is logo_url  :(</span>
121:       <span class="ruby-identifier">rights_agent</span>  = <span class="ruby-constant">Agent</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:project_name</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">rights_statement</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-identifier">a_license</span>.<span class="ruby-identifier">description</span> <span class="ruby-operator">:</span> <span class="ruby-node">&quot;#{rights_statement} #{a_license.description}&quot;</span>), 
122:                                 <span class="ruby-identifier">:homepage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">a_license</span>.<span class="ruby-identifier">source_url</span>, <span class="ruby-identifier">:logo_url</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">a_license</span>.<span class="ruby-identifier">logo_url</span>, <span class="ruby-identifier">:logo_cache_url</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>, 
123:                                 <span class="ruby-identifier">:logo_file_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">a_license</span>.<span class="ruby-identifier">logo_url</span> <span class="ruby-comment cmt"># &lt;-- check for the presence of logo_file name</span>
124:       <span class="ruby-identifier">rights_object</span> = <span class="ruby-constant">AgentsDataObject</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">rights_agent</span>, <span class="ruby-identifier">:agent_role</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">AgentRole</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:label</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'Copyright'</span>), <span class="ruby-identifier">:view_order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
125:       <span class="ruby-identifier">grouped_by_agent_role</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">group</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
126:         <span class="ruby-identifier">index_to_insert_rights</span> = <span class="ruby-identifier">i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">roles_to_insert_after</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">group</span>.<span class="ruby-identifier">agent_role</span>
127:       <span class="ruby-keyword kw">end</span>
128:       <span class="ruby-identifier">grouped_by_agent_role</span>.<span class="ruby-identifier">insert</span> <span class="ruby-identifier">index_to_insert_rights</span>, <span class="ruby-identifier">rights_object</span>
129:     <span class="ruby-keyword kw">end</span>
130: 
131:     <span class="ruby-comment cmt"># we ALSO need Location</span>
132:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">location</span>.<span class="ruby-identifier">empty?</span>
133:       <span class="ruby-identifier">grouped_by_agent_role</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">AgentsDataObject</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Agent</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:project_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">location</span>), <span class="ruby-identifier">:agent_role</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">AgentRole</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:label</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'Location'</span>), <span class="ruby-identifier">:view_order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> )
134:     <span class="ruby-keyword kw">end</span>
135:     
136:     <span class="ruby-comment cmt"># we ALSO need the source_url</span>
137:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">source_url</span>.<span class="ruby-identifier">empty?</span>
138:       <span class="ruby-identifier">grouped_by_agent_role</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">AgentsDataObject</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Agent</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:project_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'View original data object'</span>, <span class="ruby-identifier">:homepage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">source_url</span>), 
139:                                                     <span class="ruby-identifier">:agent_role</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">AgentRole</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:label</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'Source URL'</span>), <span class="ruby-identifier">:view_order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> )
140:     <span class="ruby-keyword kw">end</span>
141: 
142:     <span class="ruby-comment cmt"># ... bibliographic_citation ...</span>
143:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">bibliographic_citation</span>.<span class="ruby-identifier">empty?</span>
144:       <span class="ruby-identifier">grouped_by_agent_role</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">AgentsDataObject</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Agent</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:project_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">bibliographic_citation</span>), <span class="ruby-identifier">:agent_role</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">AgentRole</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:label</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'Citation'</span>), <span class="ruby-identifier">:view_order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> )
145:     <span class="ruby-keyword kw">end</span>
146: 
147:     <span class="ruby-identifier">grouped_by_agent_role</span>
148:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000346"><br/></a>
<div class="method_block"><h3>
<a href='#M000346'>


authors

()

</a>
</h3>

<p class="source_link" id="M000346-show-link"><a onclick="toggle('M000346-source'); toggleText('M000346-link'); return false;" href="#" id="M000346-link">Show source...</a></p><div class="source" id="M000346-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 150</span>
150:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">authors</span>
151:     <span class="ruby-identifier">default_authors</span> = <span class="ruby-identifier">agents_data_objects</span>.<span class="ruby-identifier">find_all_by_agent_role_id</span>(<span class="ruby-constant">AgentRole</span>.<span class="ruby-identifier">author_id</span>).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">ado</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ado</span>.<span class="ruby-identifier">agent</span> }.<span class="ruby-identifier">compact</span>
152:     <span class="ruby-ivar">@fake_authors</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-identifier">default_authors</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">default_authors</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@fake_authors</span>
153:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000341"><br/></a>
<div class="method_block"><h3>
<a href='#M000341'>


comment

(user, body)

</a>
</h3>
<p>
<a href="DataObject.html#M000341">comment</a> on this
</p>

<p class="source_link" id="M000341-show-link"><a onclick="toggle('M000341-source'); toggleText('M000341-link'); return false;" href="#" id="M000341-link">Show source...</a></p><div class="source" id="M000341-source"><pre>    <span class="ruby-comment cmt"># File app/models/data_object.rb, line 39</span>
39:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">comment</span>(<span class="ruby-identifier">user</span>, <span class="ruby-identifier">body</span>)
40:     <span class="ruby-identifier">comment</span> = <span class="ruby-identifier">comments</span>.<span class="ruby-identifier">create</span> <span class="ruby-identifier">:user_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:body</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">body</span>
41:     <span class="ruby-identifier">user</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">reload</span> <span class="ruby-comment cmt"># be friendly - update the user's comments automatically</span>
42:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">comment</span>
43:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000374"><br/></a>
<div class="method_block"><h3>
<a href='#M000374'>


curate!

(action)

</a>
</h3>

<p class="source_link" id="M000374-show-link"><a onclick="toggle('M000374-source'); toggleText('M000374-link'); return false;" href="#" id="M000374-link">Show source...</a></p><div class="source" id="M000374-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 289</span>
289:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">curate!</span>(<span class="ruby-identifier">action</span>)
290:     <span class="ruby-identifier">activity</span> = <span class="ruby-constant">CuratorActivity</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">action</span>)
291: 
292:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">activity</span>.<span class="ruby-identifier">code</span>[<span class="ruby-regexp re">/^approve$/i</span>]
293:       <span class="ruby-identifier">vet!</span>
294:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">activity</span>.<span class="ruby-identifier">code</span>[<span class="ruby-regexp re">/^disapprove$/i</span>]
295:       <span class="ruby-identifier">unvet!</span>
296:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">activity</span>.<span class="ruby-identifier">code</span>[<span class="ruby-regexp re">/^show$/i</span>]
297:       <span class="ruby-identifier">show!</span>
298:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">activity</span>.<span class="ruby-identifier">code</span>[<span class="ruby-regexp re">/^hide$/i</span>]
299:       <span class="ruby-identifier">hide!</span>
300:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">activity</span>.<span class="ruby-identifier">code</span>[<span class="ruby-regexp re">/^inappropriate$/i</span>]
301:       <span class="ruby-identifier">inappropriate!</span>
302:     <span class="ruby-keyword kw">else</span>
303:       <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Not sure how to #{activity.code} a DataObject&quot;</span>
304:     <span class="ruby-keyword kw">end</span>
305:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000375"><br/></a>
<div class="method_block"><h3>
<a href='#M000375'>


curated?

()

</a>
</h3>

<p class="source_link" id="M000375-show-link"><a onclick="toggle('M000375-source'); toggleText('M000375-link'); return false;" href="#" id="M000375-link">Show source...</a></p><div class="source" id="M000375-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 307</span>
307:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">curated?</span>
308:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">curated</span>
309:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000344"><br/></a>
<div class="method_block"><h3>
<a href='#M000344'>


data_supplier_agent

()

</a>
</h3>

<p class="source_link" id="M000344-show-link"><a onclick="toggle('M000344-source'); toggleText('M000344-link'); return false;" href="#" id="M000344-link">Show source...</a></p><div class="source" id="M000344-source"><pre>    <span class="ruby-comment cmt"># File app/models/data_object.rb, line 66</span>
66:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">data_supplier_agent</span>
67:     <span class="ruby-constant">Agent</span>.<span class="ruby-identifier">find_by_sql</span>([<span class="ruby-value str">&quot;select a.* from data_objects_harvest_events dohe join harvest_events he on (dohe.harvest_event_id=he.id) join agents_resources ar on (he.resource_id=ar.resource_id) join agents a on (ar.agent_id=a.id) where dohe.data_object_id=? and ar.resource_agent_role_id=3&quot;</span>, <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">first</span>
68:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000348"><br/></a>
<div class="method_block"><h3>
<a href='#M000348'>


fake_author

(author_options)

</a>
</h3>

<p class="source_link" id="M000348-show-link"><a onclick="toggle('M000348-source'); toggleText('M000348-link'); return false;" href="#" id="M000348-link">Show source...</a></p><div class="source" id="M000348-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 160</span>
160:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fake_author</span>(<span class="ruby-identifier">author_options</span>)
161:     <span class="ruby-ivar">@fake_authors</span> <span class="ruby-operator">||=</span> []
162:     <span class="ruby-ivar">@fake_authors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Agent</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">author_options</span>)
163:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000357"><br/></a>
<div class="method_block"><h3>
<a href='#M000357'>


has_object_cache_url?

()

</a>
</h3>

<p class="source_link" id="M000357-show-link"><a onclick="toggle('M000357-source'); toggleText('M000357-link'); return false;" href="#" id="M000357-link">Show source...</a></p><div class="source" id="M000357-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 203</span>
203:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_object_cache_url?</span>
204:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">object_cache_url</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">object_cache_url</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
205:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
206:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000356"><br/></a>
<div class="method_block"><h3>
<a href='#M000356'>


has_thumbnail_cache?

()

</a>
</h3>

<p class="source_link" id="M000356-show-link"><a onclick="toggle('M000356-source'); toggleText('M000356-link'); return false;" href="#" id="M000356-link">Show source...</a></p><div class="source" id="M000356-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 198</span>
198:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_thumbnail_cache?</span>
199:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">thumbnail_cache_url</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">thumbnail_cache_url</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
200:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
201:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000385"><br/></a>
<div class="method_block"><h3>
<a href='#M000385'>


hide!

(user = nil)

</a>
</h3>

<p class="source_link" id="M000385-show-link"><a onclick="toggle('M000385-source'); toggleText('M000385-link'); return false;" href="#" id="M000385-link">Show source...</a></p><div class="source" id="M000385-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 339</span>
339:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">hide!</span> <span class="ruby-identifier">user</span> = <span class="ruby-keyword kw">nil</span>
340:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">vetted_by</span> = <span class="ruby-identifier">user</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user</span>
341:     <span class="ruby-identifier">update_attributes</span>({<span class="ruby-identifier">:visibility_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Visibility</span>.<span class="ruby-identifier">invisible</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:curated</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>})
342:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000373"><br/></a>
<div class="method_block"><h3>
<a href='#M000373'>


hierarchy_entries

()

</a>
</h3>
<p>
this is even less efficient than <a
href="DataObject.html#M000372">taxon_concepts</a> - OPTIMIZE!
</p>

<p class="source_link" id="M000373-show-link"><a onclick="toggle('M000373-source'); toggleText('M000373-link'); return false;" href="#" id="M000373-link">Show source...</a></p><div class="source" id="M000373-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 285</span>
285:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">hierarchy_entries</span>
286:     <span class="ruby-ivar">@hierarchy_entries</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">taxon_concepts</span>.<span class="ruby-identifier">inject</span>([]){<span class="ruby-operator">|</span><span class="ruby-identifier">all</span>,<span class="ruby-identifier">concept</span><span class="ruby-operator">|</span> <span class="ruby-identifier">all</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">concept</span>.<span class="ruby-identifier">hierarchy_entries</span>  }.<span class="ruby-identifier">uniq</span>
287:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000351"><br/></a>
<div class="method_block"><h3>
<a href='#M000351'>


image?

()

</a>
</h3>

<p class="source_link" id="M000351-show-link"><a onclick="toggle('M000351-source'); toggleText('M000351-link'); return false;" href="#" id="M000351-link">Show source...</a></p><div class="source" id="M000351-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 177</span>
177:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">image?</span>
178:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">DataType</span>.<span class="ruby-identifier">image_type_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">data_type_id</span>)
179:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000388"><br/></a>
<div class="method_block"><h3>
<a href='#M000388'>


inappropriate!

(user = nil)

</a>
</h3>

<p class="source_link" id="M000388-show-link"><a onclick="toggle('M000388-source'); toggleText('M000388-link'); return false;" href="#" id="M000388-link">Show source...</a></p><div class="source" id="M000388-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 351</span>
351:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">inappropriate!</span> <span class="ruby-identifier">user</span> = <span class="ruby-keyword kw">nil</span>
352:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">vetted_by</span> = <span class="ruby-identifier">user</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user</span>
353:     <span class="ruby-identifier">update_attributes</span>({<span class="ruby-identifier">:visibility_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Visibility</span>.<span class="ruby-identifier">inappropriate</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:curated</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>})
354:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000378"><br/></a>
<div class="method_block"><h3>
<a href='#M000378'>


inappropriate?

()

</a>
</h3>

<p class="source_link" id="M000378-show-link"><a onclick="toggle('M000378-source'); toggleText('M000378-link'); return false;" href="#" id="M000378-link">Show source...</a></p><div class="source" id="M000378-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 317</span>
317:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">inappropriate?</span>
318:     <span class="ruby-identifier">visibility_id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Visibility</span>.<span class="ruby-identifier">inappropriate</span>.<span class="ruby-identifier">id</span>
319:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000377"><br/></a>
<div class="method_block"><h3>
<a href='#M000377'>


invisible?

()

</a>
</h3>

<p class="source_link" id="M000377-show-link"><a onclick="toggle('M000377-source'); toggleText('M000377-link'); return false;" href="#" id="M000377-link">Show source...</a></p><div class="source" id="M000377-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 314</span>
314:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invisible?</span>
315:     <span class="ruby-identifier">visibility_id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Visibility</span>.<span class="ruby-identifier">invisible</span>.<span class="ruby-identifier">id</span>
316:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000342"><br/></a>
<div class="method_block"><h3>
<a href='#M000342'>


is_curatable_by?

(user)

</a>
</h3>

<p class="source_link" id="M000342-show-link"><a onclick="toggle('M000342-source'); toggleText('M000342-link'); return false;" href="#" id="M000342-link">Show source...</a></p><div class="source" id="M000342-source"><pre>    <span class="ruby-comment cmt"># File app/models/data_object.rb, line 45</span>
45:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_curatable_by?</span> <span class="ruby-identifier">user</span>
46:     ( <span class="ruby-identifier">hierarchy_entries</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">can_curate?</span> <span class="ruby-identifier">entry</span> } ).<span class="ruby-identifier">include?</span> <span class="ruby-keyword kw">true</span>
47:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000382"><br/></a>
<div class="method_block"><h3>
<a href='#M000382'>


is_vetted?

()

</a>
</h3>
<p>
Alias for vetted?
</p>

</div>

<a class="small" name="M000352"><br/></a>
<div class="method_block"><h3>
<a href='#M000352'>


map?

()

</a>
</h3>

<p class="source_link" id="M000352-show-link"><a onclick="toggle('M000352-source'); toggleText('M000352-link'); return false;" href="#" id="M000352-link">Show source...</a></p><div class="source" id="M000352-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 181</span>
181:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">map?</span>
182:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">DataType</span>.<span class="ruby-identifier">map_type_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">data_type_id</span>)
183:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000363"><br/></a>
<div class="method_block"><h3>
<a href='#M000363'>


map_image

()

</a>
</h3>

<p class="source_link" id="M000363-show-link"><a onclick="toggle('M000363-source'); toggleText('M000363-link'); return false;" href="#" id="M000363-link">Show source...</a></p><div class="source" id="M000363-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 232</span>
232:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">map_image</span>
233:     <span class="ruby-comment cmt"># Sometimes, we want to serve map images right from the source:</span>
234:     <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">$PREFER_REMOTE_IMAGES</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">object_url</span>.<span class="ruby-identifier">blank?</span>) <span class="ruby-keyword kw">or</span> (<span class="ruby-identifier">object_cache_url</span>.<span class="ruby-identifier">blank?</span>)
235:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">object_url</span>
236:     <span class="ruby-keyword kw">else</span>
237:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">cache_path</span>(<span class="ruby-identifier">object_cache_url</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;_orig.jpg&quot;</span>
238:     <span class="ruby-keyword kw">end</span>
239:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000347"><br/></a>
<div class="method_block"><h3>
<a href='#M000347'>


photographers

()

</a>
</h3>

<p class="source_link" id="M000347-show-link"><a onclick="toggle('M000347-source'); toggleText('M000347-link'); return false;" href="#" id="M000347-link">Show source...</a></p><div class="source" id="M000347-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 155</span>
155:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">photographers</span>
156:     <span class="ruby-identifier">default_photographers</span> = <span class="ruby-identifier">agents_data_objects</span>.<span class="ruby-identifier">find_all_by_agent_role_id</span>(<span class="ruby-constant">AgentRole</span>.<span class="ruby-identifier">photographer_id</span>).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">ado</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ado</span>.<span class="ruby-identifier">agent</span> }.<span class="ruby-identifier">compact</span>
157:     <span class="ruby-ivar">@fake_photographers</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-identifier">default_photographers</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">default_photographers</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@fake_photographers</span>
158:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000366"><br/></a>
<div class="method_block"><h3>
<a href='#M000366'>


private_tags

(user)

</a>
</h3>

<p class="source_link" id="M000366-show-link"><a onclick="toggle('M000366-source'); toggleText('M000366-link'); return false;" href="#" id="M000366-link">Show source...</a></p><div class="source" id="M000366-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 250</span>
250:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">private_tags</span> <span class="ruby-identifier">user</span>
251:     <span class="ruby-constant">DataObjectTags</span>.<span class="ruby-identifier">private_tags</span>.<span class="ruby-identifier">find_all_by_data_object_id_and_user_id</span> <span class="ruby-identifier">id</span>, <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
252:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000365"><br/></a>
<div class="method_block"><h3>
<a href='#M000365'>


public_tags

()

</a>
</h3>

<p class="source_link" id="M000365-show-link"><a onclick="toggle('M000365-source'); toggleText('M000365-link'); return false;" href="#" id="M000365-link">Show source...</a></p><div class="source" id="M000365-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 246</span>
246:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">public_tags</span>
247:     <span class="ruby-constant">DataObjectTags</span>.<span class="ruby-identifier">public_tags_for_data_object</span> <span class="ruby-keyword kw">self</span>
248:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000384"><br/></a>
<div class="method_block"><h3>
<a href='#M000384'>


show!

(user = nil)

</a>
</h3>

<p class="source_link" id="M000384-show-link"><a onclick="toggle('M000384-source'); toggleText('M000384-link'); return false;" href="#" id="M000384-link">Show source...</a></p><div class="source" id="M000384-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 335</span>
335:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show!</span> <span class="ruby-identifier">user</span> = <span class="ruby-keyword kw">nil</span>
336:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">vetted_by</span> = <span class="ruby-identifier">user</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user</span>
337:     <span class="ruby-identifier">update_attributes</span>({<span class="ruby-identifier">:visibility_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Visibility</span>.<span class="ruby-identifier">visible</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:curated</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>})
338:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000361"><br/></a>
<div class="method_block"><h3>
<a href='#M000361'>


smart_image

()

</a>
</h3>

<p class="source_link" id="M000361-show-link"><a onclick="toggle('M000361-source'); toggleText('M000361-link'); return false;" href="#" id="M000361-link">Show source...</a></p><div class="source" id="M000361-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 220</span>
220:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">smart_image</span>
221:     <span class="ruby-identifier">thumb_or_object</span>
222:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000360"><br/></a>
<div class="method_block"><h3>
<a href='#M000360'>


smart_medium_thumb

()

</a>
</h3>

<p class="source_link" id="M000360-show-link"><a onclick="toggle('M000360-source'); toggleText('M000360-link'); return false;" href="#" id="M000360-link">Show source...</a></p><div class="source" id="M000360-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 216</span>
216:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">smart_medium_thumb</span>
217:     <span class="ruby-identifier">thumb_or_object</span>(<span class="ruby-identifier">:medium</span>)
218:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000359"><br/></a>
<div class="method_block"><h3>
<a href='#M000359'>


smart_thumb

()

</a>
</h3>

<p class="source_link" id="M000359-show-link"><a onclick="toggle('M000359-source'); toggleText('M000359-link'); return false;" href="#" id="M000359-link">Show source...</a></p><div class="source" id="M000359-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 212</span>
212:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">smart_thumb</span>
213:     <span class="ruby-identifier">thumb_or_object</span>(<span class="ruby-identifier">:small</span>)
214:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000349"><br/></a>
<div class="method_block"><h3>
<a href='#M000349'>


sources

()

</a>
</h3>

<p class="source_link" id="M000349-show-link"><a onclick="toggle('M000349-source'); toggleText('M000349-link'); return false;" href="#" id="M000349-link">Show source...</a></p><div class="source" id="M000349-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 165</span>
165:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sources</span>
166:     <span class="ruby-identifier">list</span> = <span class="ruby-identifier">agents_data_objects</span>.<span class="ruby-identifier">find_all_by_agent_role_id</span>(<span class="ruby-constant">AgentRole</span>.<span class="ruby-identifier">source_id</span>).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">ado</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ado</span>.<span class="ruby-identifier">agent</span> }.<span class="ruby-identifier">compact</span>
167:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">list</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">list</span>.<span class="ruby-identifier">blank?</span>
168:     <span class="ruby-comment cmt"># I ended up with empty lists in cases where I thought I shouldn't, so tried to defer to authors for those:</span>
169:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">authors</span>
170:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000364"><br/></a>
<div class="method_block"><h3>
<a href='#M000364'>


tag

(key, values, user = nil)

</a>
</h3>
<p>
<a href="DataObject.html#M000364">tag</a> with a <a
href="DataObjectTag.html">DataObjectTag</a>
</p>

<p class="source_link" id="M000364-show-link"><a onclick="toggle('M000364-source'); toggleText('M000364-link'); return false;" href="#" id="M000364-link">Show source...</a></p><div class="source" id="M000364-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 242</span>
242:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tag</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">values</span>, <span class="ruby-identifier">user</span> = <span class="ruby-keyword kw">nil</span>)
243:     <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">tag</span> <span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">key</span>, <span class="ruby-identifier">values</span>, <span class="ruby-identifier">user</span>
244:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000371"><br/></a>
<div class="method_block"><h3>
<a href='#M000371'>


tag_keys

()

</a>
</h3>
<p>
returns an array of all of the keys an object is tagged with
</p>

<p class="source_link" id="M000371-show-link"><a onclick="toggle('M000371-source'); toggleText('M000371-link'); return false;" href="#" id="M000371-link">Show source...</a></p><div class="source" id="M000371-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 274</span>
274:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tag_keys</span>
275:     <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">key</span> }.<span class="ruby-identifier">uniq</span>
276:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000370"><br/></a>
<div class="method_block"><h3>
<a href='#M000370'>


tags_hash

()

</a>
</h3>
<p>
returns a hash in the format { &#8216;tag_key&#8217; =&gt;
[&#8216;value1&#8217;,&#8217;value2&#8217;] }
</p>

<p class="source_link" id="M000370-show-link"><a onclick="toggle('M000370-source'); toggleText('M000370-link'); return false;" href="#" id="M000370-link">Show source...</a></p><div class="source" id="M000370-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 266</span>
266:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tags_hash</span>
267:     <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">all</span>,<span class="ruby-identifier">this</span><span class="ruby-operator">|</span>
268:       <span class="ruby-identifier">all</span>[<span class="ruby-identifier">this</span>.<span class="ruby-identifier">key</span>] = (<span class="ruby-identifier">all</span>[<span class="ruby-identifier">this</span>.<span class="ruby-identifier">key</span>] <span class="ruby-operator">||</span> []) <span class="ruby-operator">+</span> [<span class="ruby-identifier">this</span>.<span class="ruby-identifier">value</span>]
269:       <span class="ruby-identifier">all</span>
270:     <span class="ruby-keyword kw">end</span>
271:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000369"><br/></a>
<div class="method_block"><h3>
<a href='#M000369'>


taxa_names_taxon_concept_ids

()

</a>
</h3>
<p>
Names of taxa associated with this image
</p>

<p class="source_link" id="M000369-show-link"><a onclick="toggle('M000369-source'); toggleText('M000369-link'); return false;" href="#" id="M000369-link">Show source...</a></p><div class="source" id="M000369-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 259</span>
259:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taxa_names_taxon_concept_ids</span>
260:     <span class="ruby-identifier">taxa</span>=<span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;select t.scientific_name as taxon_name, tcn.taxon_concept_id as taxon_concept_id from data_objects_taxa dot join taxa t on (dot.taxon_id=t.id) join taxon_concept_names tcn on (t.name_id=tcn.name_id) where data_object_id=#{self.id} group by t.id&quot;</span>)
261:     <span class="ruby-identifier">taxa</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> {<span class="ruby-identifier">:taxon_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">taxon_name</span>, <span class="ruby-identifier">:taxon_concept_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">taxon_concept_id</span>}}
262:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000372"><br/></a>
<div class="method_block"><h3>
<a href='#M000372'>


taxon_concepts

()

</a>
</h3>
<p>
return all of the taxon concepts associated with this <a
href="DataObject.html">DataObject</a>
</p>

<p class="source_link" id="M000372-show-link"><a onclick="toggle('M000372-source'); toggleText('M000372-link'); return false;" href="#" id="M000372-link">Show source...</a></p><div class="source" id="M000372-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 279</span>
279:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taxon_concepts</span>
280:     <span class="ruby-comment cmt"># need to optimize with eager loading</span>
281:     <span class="ruby-ivar">@taxon_concepts</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">DataObjectsTaxon</span>.<span class="ruby-identifier">find_all_by_data_object_id</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:taxon</span>).<span class="ruby-identifier">inject</span>([]){<span class="ruby-operator">|</span><span class="ruby-identifier">all</span>,<span class="ruby-identifier">this_taxon</span><span class="ruby-operator">|</span> ( <span class="ruby-identifier">all</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">this_taxon</span>.<span class="ruby-identifier">taxon_concepts</span> ) }.<span class="ruby-identifier">uniq</span>
282:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000353"><br/></a>
<div class="method_block"><h3>
<a href='#M000353'>


text?

()

</a>
</h3>

<p class="source_link" id="M000353-show-link"><a onclick="toggle('M000353-source'); toggleText('M000353-link'); return false;" href="#" id="M000353-link">Show source...</a></p><div class="source" id="M000353-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 185</span>
185:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">text?</span>
186:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">DataType</span>.<span class="ruby-identifier">text_type_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">data_type_id</span>)
187:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000358"><br/></a>
<div class="method_block"><h3>
<a href='#M000358'>


thumb_or_object

(size = :large)

</a>
</h3>

<p class="source_link" id="M000358-show-link"><a onclick="toggle('M000358-source'); toggleText('M000358-link'); return false;" href="#" id="M000358-link">Show source...</a></p><div class="source" id="M000358-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 208</span>
208:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">thumb_or_object</span>(<span class="ruby-identifier">size</span> = <span class="ruby-identifier">:large</span>)
209:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">image_cache_path</span>(<span class="ruby-identifier">object_cache_url</span>, <span class="ruby-identifier">size</span>) 
210:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000389"><br/></a>
<div class="method_block"><h3>
<a href='#M000389'>


to_s

()

</a>
</h3>

<p class="source_link" id="M000389-show-link"><a onclick="toggle('M000389-source'); toggleText('M000389-link'); return false;" href="#" id="M000389-link">Show source...</a></p><div class="source" id="M000389-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 356</span>
356:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_s</span>
357:     <span class="ruby-node">&quot;[DataObject id:#{id}]&quot;</span>
358:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000383"><br/></a>
<div class="method_block"><h3>
<a href='#M000383'>


trusted?

()

</a>
</h3>
<p>
Alias for vetted?
</p>

</div>

<a class="small" name="M000380"><br/></a>
<div class="method_block"><h3>
<a href='#M000380'>


unknown?

()

</a>
</h3>

<p class="source_link" id="M000380-show-link"><a onclick="toggle('M000380-source'); toggleText('M000380-link'); return false;" href="#" id="M000380-link">Show source...</a></p><div class="source" id="M000380-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 325</span>
325:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unknown?</span>
326:     <span class="ruby-identifier">vetted_id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Vetted</span>.<span class="ruby-identifier">unknown</span>.<span class="ruby-identifier">id</span>
327:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000379"><br/></a>
<div class="method_block"><h3>
<a href='#M000379'>


untrusted?

()

</a>
</h3>

<p class="source_link" id="M000379-show-link"><a onclick="toggle('M000379-source'); toggleText('M000379-link'); return false;" href="#" id="M000379-link">Show source...</a></p><div class="source" id="M000379-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 321</span>
321:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">untrusted?</span>
322:     <span class="ruby-identifier">vetted_id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Vetted</span>.<span class="ruby-identifier">untrusted</span>.<span class="ruby-identifier">id</span>
323:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000387"><br/></a>
<div class="method_block"><h3>
<a href='#M000387'>


unvet!

(user = nil)

</a>
</h3>

<p class="source_link" id="M000387-show-link"><a onclick="toggle('M000387-source'); toggleText('M000387-link'); return false;" href="#" id="M000387-link">Show source...</a></p><div class="source" id="M000387-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 347</span>
347:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unvet!</span> <span class="ruby-identifier">user</span> = <span class="ruby-keyword kw">nil</span>
348:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">vetted_by</span> = <span class="ruby-identifier">user</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user</span>
349:     <span class="ruby-identifier">update_attributes</span>({<span class="ruby-identifier">:vetted_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Vetted</span>.<span class="ruby-identifier">untrusted</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:curated</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>})
350:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000367"><br/></a>
<div class="method_block"><h3>
<a href='#M000367'>


user_tags

(user)

</a>
</h3>
<p>
Alias for <a href="DataObject.html#M000366">private_tags</a>
</p>

</div>

<a class="small" name="M000368"><br/></a>
<div class="method_block"><h3>
<a href='#M000368'>


users_tags

(user)

</a>
</h3>
<p>
Alias for <a href="DataObject.html#M000366">private_tags</a>
</p>

</div>

<a class="small" name="M000386"><br/></a>
<div class="method_block"><h3>
<a href='#M000386'>


vet!

(user = nil)

</a>
</h3>

<p class="source_link" id="M000386-show-link"><a onclick="toggle('M000386-source'); toggleText('M000386-link'); return false;" href="#" id="M000386-link">Show source...</a></p><div class="source" id="M000386-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 343</span>
343:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">vet!</span> <span class="ruby-identifier">user</span> = <span class="ruby-keyword kw">nil</span>
344:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">vetted_by</span> = <span class="ruby-identifier">user</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user</span>
345:     <span class="ruby-identifier">update_attributes</span>({<span class="ruby-identifier">:vetted_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Vetted</span>.<span class="ruby-identifier">trusted</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:curated</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>})
346:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000381"><br/></a>
<div class="method_block"><h3>
<a href='#M000381'>


vetted?

()

</a>
</h3>

<p class="source_link" id="M000381-show-link"><a onclick="toggle('M000381-source'); toggleText('M000381-link'); return false;" href="#" id="M000381-link">Show source...</a></p><div class="source" id="M000381-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 329</span>
329:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">vetted?</span>
330:     <span class="ruby-identifier">vetted_id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Vetted</span>.<span class="ruby-identifier">trusted</span>.<span class="ruby-identifier">id</span>
331:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000362"><br/></a>
<div class="method_block"><h3>
<a href='#M000362'>


video_url

()

</a>
</h3>

<p class="source_link" id="M000362-show-link"><a onclick="toggle('M000362-source'); toggleText('M000362-link'); return false;" href="#" id="M000362-link">Show source...</a></p><div class="source" id="M000362-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 224</span>
224:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">video_url</span>
225:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">data_type</span>.<span class="ruby-identifier">label</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Flash'</span>
226:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">has_object_cache_url?</span> <span class="ruby-operator">?</span> <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">cache_path</span>(<span class="ruby-identifier">object_cache_url</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">'.flv'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">''</span>
227:     <span class="ruby-keyword kw">else</span>
228:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">object_url</span>
229:     <span class="ruby-keyword kw">end</span>
230:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000376"><br/></a>
<div class="method_block"><h3>
<a href='#M000376'>


visible?

()

</a>
</h3>

<p class="source_link" id="M000376-show-link"><a onclick="toggle('M000376-source'); toggleText('M000376-link'); return false;" href="#" id="M000376-link">Show source...</a></p><div class="source" id="M000376-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 311</span>
311:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">visible?</span>
312:     <span class="ruby-identifier">visibility_id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Visibility</span>.<span class="ruby-identifier">visible</span>.<span class="ruby-identifier">id</span>
313:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000350"><br/></a>
<div class="method_block"><h3>
<a href='#M000350'>


visible_comments

(user = nil)

</a>
</h3>

<p class="source_link" id="M000350-show-link"><a onclick="toggle('M000350-source'); toggleText('M000350-link'); return false;" href="#" id="M000350-link">Show source...</a></p><div class="source" id="M000350-source"><pre>     <span class="ruby-comment cmt"># File app/models/data_object.rb, line 172</span>
172:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">visible_comments</span>(<span class="ruby-identifier">user</span> = <span class="ruby-keyword kw">nil</span>)
173:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">comments</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">not</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">nil?</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_moderator?</span>
174:     <span class="ruby-identifier">comments</span>.<span class="ruby-identifier">find_all</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">comment</span><span class="ruby-operator">|</span> <span class="ruby-identifier">comment</span>.<span class="ruby-identifier">visible?</span> }
175:   <span class="ruby-keyword kw">end</span></pre></div>
</div>





</div><div class="clear" id="footer">Generated on Jan 21, 2008 / Allison 2 &copy; 2007 <a href="http://cloudbur.st">Cloudburst, LLC</a></div></div></body></html>