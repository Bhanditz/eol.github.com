<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>Class: TaxaController [Rails Application Documentation]</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <link href='.././rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Class</span>
          TaxaController
        </h1>
        <ol class='paths'>
          <li>
            <a href="../files/app/controllers/taxa_controller_rb.html">app/controllers/taxa_controller.rb</a>
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong><a href="ApplicationController.html">ApplicationController</a></strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000008">boom</a></li>
              <li><a href="#M000014">citation</a></li>
              <li><a href="#M000016">content</a></li>
              <li><a href="#M000015">endnote</a></li>
              <li><a href="#M000017">image_collection</a></li>
              <li><a href="#M000007">index</a></li>
              <li><a href="#M000012">search</a></li>
              <li><a href="#M000009">search_clicked</a></li>
              <li><a href="#M000013">settings</a></li>
              <li><a href="#M000011">show</a></li>
              <li><a href="#M000019">show_popup</a></li>
              <li><a href="#M000018">show_video</a></li>
              <li><a href="#M000020">survey_response</a></li>
              <li><a href="#M000010">taxa</a></li>
              <li><a href="#M000021">view_object</a></li>
            </ol>
            <h3>protected instance</h3>
            <ol>
              <li><a href="#M000022">set_user_settings</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='methods'>
              <h2>Public instance methods</h2>
              <div class='public-instance method' id='method-M000008'>
                <a name='M000008'>      </a>
                <div class='synopsis'>
                  <span class='name'>boom</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000008-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000008-source'>    <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 40</span>&#x000A;40:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">boom</span>&#x000A;41:     <span class="ruby-comment cmt"># a quick way to test exception notifications, just raise the error!</span>&#x000A;42:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;boom&quot;</span> &#x000A;43:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000014'>
                <a name='M000014'>      </a>
                <div class='synopsis'>
                  <span class='name'>citation</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  AJAX: Render the requested citation into a floating div TODO: Remove if it
                  continues to not be used
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000014-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000014-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 223</span>&#x000A;223:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">citation</span>&#x000A;224:     &#x000A;225:     <span class="ruby-ivar">@taxon_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]  &#x000A;226:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:partial=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'citation'</span>,<span class="ruby-identifier">:layout=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword kw">false</span>&#x000A;227:     &#x000A;228:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000016'>
                <a name='M000016'>      </a>
                <div class='synopsis'>
                  <span class='name'>content</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  AJAX: Render the requested content page
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000016-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000016-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 259</span>&#x000A;259:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">content</span>&#x000A;260: &#x000A;261:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>&#x000A;262:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword kw">true</span>&#x000A;263:       <span class="ruby-keyword kw">return</span>&#x000A;264:     <span class="ruby-keyword kw">end</span>&#x000A;265:         &#x000A;266:     <span class="ruby-ivar">@taxon_id</span>    = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]&#x000A;267:     <span class="ruby-ivar">@taxon</span>       = <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@taxon_id</span>) &#x000A;268:     <span class="ruby-ivar">@category_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:category_id</span>].<span class="ruby-identifier">to_i</span>&#x000A;269:     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_agent</span> = <span class="ruby-identifier">current_agent</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_agent</span>.<span class="ruby-identifier">nil?</span>&#x000A;270:     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">current_user</span>&#x000A;271:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@category_id</span> <span class="ruby-operator">==</span> <span class="ruby-constant">TocItem</span>.<span class="ruby-identifier">search_the_web</span>.<span class="ruby-identifier">id</span>&#x000A;272:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>&#x000A;273:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'center-page-content'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'content_search_the_web.html.erb'</span>&#x000A;274:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;$('current_content').value = '#{@category_id}';&quot;</span>&#x000A;275:         <span class="ruby-identifier">page</span>[<span class="ruby-value str">'center-page-content'</span>].<span class="ruby-identifier">set_style</span> <span class="ruby-identifier">:height</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'auto'</span>&#x000A;276:       <span class="ruby-keyword kw">end</span>&#x000A;277:     <span class="ruby-keyword kw">else</span>&#x000A;278:       <span class="ruby-ivar">@content</span>     = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">content_by_category</span>(<span class="ruby-ivar">@category_id</span>)&#x000A;279:       <span class="ruby-ivar">@ajax_update</span>=<span class="ruby-keyword kw">true</span>&#x000A;280:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@content</span>.<span class="ruby-identifier">nil?</span>&#x000A;281:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'[content missing]'</span>&#x000A;282:       <span class="ruby-keyword kw">else</span>&#x000A;283:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>&#x000A;284:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'center-page-content'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'content.html.erb'</span>&#x000A;285:           <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;$('current_content').value = '#{@category_id}';&quot;</span>&#x000A;286:           <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;Event.addBehavior.reload();&quot;</span>&#x000A;287:           <span class="ruby-identifier">page</span>[<span class="ruby-value str">'center-page-content'</span>].<span class="ruby-identifier">set_style</span> <span class="ruby-identifier">:height</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'auto'</span>&#x000A;288:         <span class="ruby-keyword kw">end</span>&#x000A;289:       <span class="ruby-keyword kw">end</span>&#x000A;290:     <span class="ruby-keyword kw">end</span>&#x000A;291:     &#x000A;292:     <span class="ruby-identifier">log_data_objects_for_taxon_concept</span> <span class="ruby-ivar">@taxon</span>, <span class="ruby-operator">*</span><span class="ruby-ivar">@content</span>[<span class="ruby-identifier">:data_objects</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@content</span>.<span class="ruby-identifier">nil?</span>&#x000A;293:     &#x000A;294:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000015'>
                <a name='M000015'>      </a>
                <div class='synopsis'>
                  <span class='name'>endnote</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  AJAX: Render the requested citation into an endnote file TODO: Remove if it
                  continues to not be used
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000015-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000015-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 232</span>&#x000A;232:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">endnote</span>&#x000A;233:     &#x000A;234:     <span class="ruby-identifier">taxon_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]  &#x000A;235:     <span class="ruby-identifier">taxon</span>    = <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">taxon_id</span>)&#x000A;236: &#x000A;237:     <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">current_user</span>&#x000A;238:     &#x000A;239:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">nil?</span>&#x000A;240:         <span class="ruby-identifier">endnote_citation</span>=<span class="ruby-value str">''</span>&#x000A;241:         <span class="ruby-comment cmt">## TODO: This is obviously hardcoded and would need to be updated with dynamic citation data when we do this</span>&#x000A;242:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%0 Web Page\n&quot;</span>&#x000A;243:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%T Taxonomic and natural history description of FAM: ARANEIDAE, Araneus marmoreus Clerck, 1757\n&quot;</span>&#x000A;244:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%A Shorthouse, David P.\n&quot;</span>&#x000A;245:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%E Shorthouse, David P.\n&quot;</span>&#x000A;246:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%D 2006\n&quot;</span>&#x000A;247:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%W http://www.canadianarachnology.org/data/canada_spiders/\n&quot;</span>&#x000A;248:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%N &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">&quot;%m/%d/%Y %H:%M:%S&quot;</span>) <span class="ruby-operator">+</span><span class="ruby-value str">&quot;\n&quot;</span>&#x000A;249:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%U http://www.canadianarachnology.org/data/spiders/15005\n&quot;</span>&#x000A;250:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%~ The Nearctic Spider Database\n&quot;</span>&#x000A;251:         <span class="ruby-identifier">endnote_citation</span><span class="ruby-operator">+=</span><span class="ruby-value str">&quot;%&gt; http://www.canadianarachnology.org/data/spiderspdf/15005/Araneus%20marmoreus\n&quot;</span>&#x000A;252:         &#x000A;253:         <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">endnote_citation</span>,<span class="ruby-identifier">:filename=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">taxon</span>.<span class="ruby-identifier">title</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">20</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">'.enw'</span>,<span class="ruby-identifier">:type=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'application/x-endnote-refer'</span>,<span class="ruby-identifier">:disposition=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'attachment'</span>)&#x000A;254:     <span class="ruby-keyword kw">end</span>&#x000A;255:     &#x000A;256:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000017'>
                <a name='M000017'>      </a>
                <div class='synopsis'>
                  <span class='name'>image_collection</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  AJAX: Render the requested image collection by taxon_id and page
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000017-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000017-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 297</span>&#x000A;297:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">image_collection</span>&#x000A;298:    &#x000A;299:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>&#x000A;300:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword kw">true</span>&#x000A;301:       <span class="ruby-keyword kw">return</span>&#x000A;302:     <span class="ruby-keyword kw">end</span>  &#x000A;303:     &#x000A;304:     <span class="ruby-ivar">@image_page</span> = (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:image_page</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_i</span>&#x000A;305:     <span class="ruby-ivar">@taxon_id</span>   = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:taxon_id</span>]&#x000A;306:     <span class="ruby-ivar">@taxon</span>      = <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@taxon_id</span>) &#x000A;307:     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">current_user</span>&#x000A;308:     <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_agent</span> = <span class="ruby-identifier">current_agent</span>&#x000A;309:     <span class="ruby-identifier">start</span>       = <span class="ruby-identifier">$MAX_IMAGES_PER_PAGE</span> <span class="ruby-operator">*</span> (<span class="ruby-ivar">@image_page</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)&#x000A;310:     <span class="ruby-identifier">last</span>        = <span class="ruby-identifier">start</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">$MAX_IMAGES_PER_PAGE</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>&#x000A;311:     <span class="ruby-ivar">@images</span>     = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">images</span>[<span class="ruby-identifier">start</span><span class="ruby-operator">..</span><span class="ruby-identifier">last</span>]&#x000A;312: &#x000A;313:     <span class="ruby-ivar">@show_next_image_page_button</span> = (<span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">images</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">last</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>))&#x000A;314:     &#x000A;315:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">nil?</span>&#x000A;316:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword kw">true</span>&#x000A;317:     <span class="ruby-keyword kw">else</span>&#x000A;318:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>&#x000A;319:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'image-collection'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'image_collection'</span> &#x000A;320:       <span class="ruby-keyword kw">end</span>&#x000A;321:     <span class="ruby-keyword kw">end</span>&#x000A;322:     &#x000A;323:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000007'>
                <a name='M000007'>      </a>
                <div class='synopsis'>
                  <span class='name'>index</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000007-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000007-source'>    <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 11</span>&#x000A;11:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>&#x000A;12:     <span class="ruby-comment cmt">#this is cheating because of mixing taxon and taxon concept use of the controller</span>&#x000A;13:     &#x000A;14:     <span class="ruby-comment cmt"># you need to be a content partner and logged in to get here</span>&#x000A;15:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_agent</span>.<span class="ruby-identifier">nil?</span>&#x000A;16:       <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">home_page_url</span>)&#x000A;17:       <span class="ruby-keyword kw">return</span>&#x000A;18:     <span class="ruby-keyword kw">end</span>&#x000A;19:     &#x000A;20:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:harvest_event_id</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:harvest_event_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>&#x000A;21:       <span class="ruby-identifier">page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:page</span>] <span class="ruby-operator">||</span> <span class="ruby-value">1</span>&#x000A;22:       <span class="ruby-ivar">@harvest_event</span> = <span class="ruby-constant">HarvestEvent</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:harvest_event_id</span>])&#x000A;23:       <span class="ruby-ivar">@taxa</span> = <span class="ruby-constant">Taxon</span>.<span class="ruby-identifier">paginate_by_sql</span>(<span class="ruby-node">&quot;&#x000A;24:         select t.*, he.taxon_concept_id&#x000A;25:         from harvest_events h &#x000A;26:           join harvest_events_taxa ht &#x000A;27:             on h.id = ht.harvest_event_id &#x000A;28:           join taxa t &#x000A;29:             on t.id = ht.taxon_id &#x000A;30:           join hierarchy_entries he &#x000A;31:             on he.id = t.hierarchy_entry_id &#x000A;32:         where h.id=#{params[:harvest_event_id].to_i} &#x000A;33:         order by t.scientific_name&quot;</span> , <span class="ruby-identifier">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">page</span>)&#x000A;34:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:html</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'content_partner'</span>&#x000A;35:     <span class="ruby-keyword kw">else</span>&#x000A;36:       <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">:action=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">:show</span>, <span class="ruby-identifier">:id=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])&#x000A;37:     <span class="ruby-keyword kw">end</span>&#x000A;38:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000012'>
                <a name='M000012'>      </a>
                <div class='synopsis'>
                  <span class='name'>search</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  execute search and show results
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000012-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000012-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 149</span>&#x000A;149:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">search</span>&#x000A;150:     &#x000A;151:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">content_level</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:content_level</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:content_level</span>].<span class="ruby-identifier">nil?</span>&#x000A;152:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search_language</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">'*'</span>&#x000A;153:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search_type</span>] = <span class="ruby-constant">EOLConvert</span>.<span class="ruby-identifier">get_search_type</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search_type</span>])&#x000A;154:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:content_level</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">'1'</span>&#x000A;155:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:q</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">''</span>&#x000A;156:     &#x000A;157:     <span class="ruby-identifier">last_published</span>=<span class="ruby-constant">HarvestEvent</span>.<span class="ruby-identifier">last_published</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search_type</span>].<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'text'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">allow_page_to_be_cached?</span>&#x000A;158:     <span class="ruby-ivar">@last_harvest_event_id</span>=(<span class="ruby-identifier">last_published</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;0&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">last_published</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>)&#x000A;159:     &#x000A;160:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search_type</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'text'</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">allow_page_to_be_cached?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">read_fragment</span>(<span class="ruby-identifier">:controller=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'taxa'</span>,<span class="ruby-identifier">:part=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'search_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search_language</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">'_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:q</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">'_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">vetted</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'_'</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@last_harvest_event_id</span>))           &#x000A;161:       &#x000A;162:       <span class="ruby-ivar">@search</span> = <span class="ruby-constant">Search</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">request</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">current_agent</span>)  <span class="ruby-comment cmt"># this is a non-cached text search      </span>&#x000A;163:       <span class="ruby-ivar">@cached</span> = <span class="ruby-keyword kw">false</span>&#x000A;164:         &#x000A;165:       <span class="ruby-comment cmt"># TODO - There is a much better way to do this, please clean me - it is also duplicated in search.rb model  </span>&#x000A;166:       <span class="ruby-comment cmt"># if we have only one result, go straight to that page</span>&#x000A;167:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">search_returned</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">total_search_results</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>&#x000A;168:         <span class="ruby-comment cmt">#taxon_id = (@search.common_name_results[0][0] || @search.scientific_name_results[0][0] || @search.tag_results[0][0].id)</span>&#x000A;169:         <span class="ruby-identifier">taxon_id</span> = <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">common_results</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">common_results</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">:id</span>]&#x000A;170:         <span class="ruby-identifier">taxon_id</span> = <span class="ruby-identifier">taxon_id</span> <span class="ruby-value">? </span><span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">:</span> (<span class="ruby-ivar">@search</span>.<span class="ruby-identifier">scientific_results</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">scientific_results</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">:id</span>])&#x000A;171:         <span class="ruby-identifier">taxon_id</span> = <span class="ruby-identifier">taxon_id</span> <span class="ruby-value">? </span><span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">:</span> (<span class="ruby-ivar">@search</span>.<span class="ruby-identifier">tag_results</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">tag_results</span>[<span class="ruby-value">0</span>][<span class="ruby-value">0</span>].<span class="ruby-identifier">id</span>)&#x000A;172:         <span class="ruby-identifier">taxon_id</span> = <span class="ruby-identifier">taxon_id</span> <span class="ruby-value">? </span><span class="ruby-identifier">taxon_id</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@search</span>.<span class="ruby-identifier">suggested_searches</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">taxon_id</span>&#x000A;173:         <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'taxa'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'show'</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">taxon_id</span>&#x000A;174:       <span class="ruby-keyword kw">end</span>&#x000A;175:       &#x000A;176:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search_type</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'text'</span> <span class="ruby-comment cmt"># this is a cached text search</span>&#x000A;177:       &#x000A;178:       <span class="ruby-ivar">@search</span> = <span class="ruby-constant">Search</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>,<span class="ruby-identifier">request</span>,<span class="ruby-identifier">current_user</span>,<span class="ruby-identifier">current_agent</span>,<span class="ruby-keyword kw">false</span>) <span class="ruby-comment cmt"># set up some variables needed on the page, but don't actually execute the search</span>&#x000A;179:       <span class="ruby-ivar">@cached</span> = <span class="ruby-keyword kw">true</span>&#x000A;180:       &#x000A;181:     <span class="ruby-keyword kw">else</span> <span class="ruby-comment cmt"># this is a tag search (which is never cached)</span>&#x000A;182:       &#x000A;183:       <span class="ruby-ivar">@search</span> = <span class="ruby-constant">Search</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>,<span class="ruby-identifier">request</span>,<span class="ruby-identifier">current_user</span>,<span class="ruby-identifier">current_agent</span>)&#x000A;184:       <span class="ruby-ivar">@cached</span> = <span class="ruby-keyword kw">false</span>&#x000A;185:       &#x000A;186:     <span class="ruby-keyword kw">end</span>&#x000A;187:     &#x000A;188:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000009'>
                <a name='M000009'>      </a>
                <div class='synopsis'>
                  <span class='name'>search_clicked</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000009-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000009-source'>    <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 45</span>&#x000A;45:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">search_clicked</span>&#x000A;46:     &#x000A;47:     <span class="ruby-comment cmt"># update the search log if we are coming from the search page, to indicate the user got here from a search</span>&#x000A;48:     <span class="ruby-identifier">update_logged_search</span> <span class="ruby-identifier">:id=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search_id</span>],<span class="ruby-identifier">:taxon_concept_id=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">key?</span> <span class="ruby-identifier">:search_id</span> &#x000A;49:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">taxon_url</span>, <span class="ruby-identifier">:id=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]&#x000A;50:   &#x000A;51:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000013'>
                <a name='M000013'>      </a>
                <div class='synopsis'>
                  <span class='name'>settings</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  page that will allows a non-logged in user to change content settings
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000013-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000013-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 191</span>&#x000A;191:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">settings</span>&#x000A;192: &#x000A;193:     <span class="ruby-identifier">store_location</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:return_to</span>]) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:return_to</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">get?</span> <span class="ruby-comment cmt"># store the page we came from so we can return there if it's passed in the URL</span>&#x000A;194: &#x000A;195:     <span class="ruby-comment cmt"># if the user is logged in, they should be at the profile page</span>&#x000A;196:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logged_in?</span>&#x000A;197:       <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">profile_url</span>)&#x000A;198:       <span class="ruby-keyword kw">return</span>&#x000A;199:     <span class="ruby-keyword kw">end</span>&#x000A;200:     &#x000A;201:     <span class="ruby-comment cmt"># grab logged in user</span>&#x000A;202:     <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">current_user</span>&#x000A;203:             &#x000A;204:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">post?</span> <span class="ruby-comment cmt"># first time on page, get current settings</span>&#x000A;205:       <span class="ruby-comment cmt"># set expertise to a string so it will be picked up in web page controls</span>&#x000A;206:       <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">expertise</span>=<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">expertise</span>.<span class="ruby-identifier">to_s</span>&#x000A;207:       <span class="ruby-keyword kw">return</span>&#x000A;208:     <span class="ruby-keyword kw">end</span>&#x000A;209:              &#x000A;210:     <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">attributes</span>=<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:user</span>]&#x000A;211:     <span class="ruby-identifier">set_current_user</span>(<span class="ruby-ivar">@user</span>)&#x000A;212:     <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">&quot;Your preferences have been updated.&quot;</span>[<span class="ruby-identifier">:your_preferences_have_been_updated</span>]&#x000A;213:     <span class="ruby-identifier">redirect_back_or_default</span>&#x000A;214:        &#x000A;215:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000011'>
                <a name='M000011'>      </a>
                <div class='synopsis'>
                  <span class='name'>show</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  Main taxon viewmysql
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000011-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000011-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 61</span>&#x000A; 61:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show</span>&#x000A; 62:     <span class="ruby-comment cmt"># set default taxa id if one is not supplied in querystring</span>&#x000A; 63:     <span class="ruby-ivar">@taxon_id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]&#x000A; 64: &#x000A; 65:     <span class="ruby-ivar">@specify_category_id</span>=<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:category_id</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'default'</span>&#x000A; 66: &#x000A; 67:     <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;taxa id not supplied&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@taxon_id</span>.<span class="ruby-identifier">nil?</span> &#x000A; 68:     &#x000A; 69:     <span class="ruby-comment cmt"># reset the content level if it is in the querystring NOTE the expertise level is set by pre filter set_user_settings()</span>&#x000A; 70:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">content_level</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:content_level</span>] <span class="ruby-keyword kw">if</span> [<span class="ruby-value str">'1'</span>,<span class="ruby-value str">'2'</span>,<span class="ruby-value str">'3'</span>,<span class="ruby-value str">'4'</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:content_level</span>])&#x000A; 71:     &#x000A; 72:     <span class="ruby-keyword kw">begin</span>&#x000A; 73:       <span class="ruby-ivar">@taxon</span> = <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@taxon_id</span>)&#x000A; 74:       <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">current_user</span>&#x000A; 75:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>&#x000A; 76:       <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;taxa does not exist&quot;</span>  &#x000A; 77:     <span class="ruby-keyword kw">end</span>&#x000A; 78:         &#x000A; 79:     <span class="ruby-comment cmt"># run all the queries if the page cannot be cached or the fragment is not found</span>&#x000A; 80:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">allow_page_to_be_cached?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@specify_category_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">'default'</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">read_fragment</span>(<span class="ruby-identifier">:controller=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'taxa'</span>,<span class="ruby-identifier">:part=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'page_'</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@taxon_id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">language_abbr</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">expertise</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">vetted</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">default_taxonomic_browser</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can_curate?</span>(<span class="ruby-ivar">@taxon</span>).<span class="ruby-identifier">to_s</span>)    &#x000A; 81:       &#x000A; 82:       <span class="ruby-ivar">@cached</span>=<span class="ruby-keyword kw">false</span>&#x000A; 83:       &#x000A; 84:       <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_user</span> = <span class="ruby-identifier">current_user</span>&#x000A; 85: &#x000A; 86:       <span class="ruby-comment cmt"># get available media types</span>&#x000A; 87:       <span class="ruby-ivar">@available_media</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">available_media</span>&#x000A; 88:         &#x000A; 89:       <span class="ruby-comment cmt"># TODO - all these @taxon.map/videos/images don't need to be full-class @variables.... just use taxon!</span>&#x000A; 90:       <span class="ruby-comment cmt"># get distribution map information</span>&#x000A; 91:       <span class="ruby-ivar">@map</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@available_media</span>[<span class="ruby-identifier">:map</span>]&#x000A; 92:     &#x000A; 93:       <span class="ruby-comment cmt"># get videos for this taxon</span>&#x000A; 94:       <span class="ruby-ivar">@videos</span>=<span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">videos</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@available_media</span>[<span class="ruby-identifier">:video</span>]&#x000A; 95:               &#x000A; 96:       <span class="ruby-comment cmt"># get first set of images and if more images are available (for paging)</span>&#x000A; 97:       <span class="ruby-comment cmt"># TODO - this (image_page) is broken.  Can we remove it?</span>&#x000A; 98:       <span class="ruby-ivar">@image_page</span> = (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:image_page</span>] <span class="ruby-operator">||</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_i</span>&#x000A; 99:       <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">current_agent</span> = <span class="ruby-identifier">current_agent</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_agent</span>.<span class="ruby-identifier">nil?</span>&#x000A;100:       <span class="ruby-ivar">@images</span>     = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">images</span>&#x000A;101:       <span class="ruby-ivar">@show_next_image_page_button</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">more_images</span> <span class="ruby-comment cmt"># indicates if more images are available</span>&#x000A;102:       <span class="ruby-ivar">@default_image</span> = <span class="ruby-ivar">@images</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">smart_image</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">blank?</span>&#x000A;103:            &#x000A;104:       <span class="ruby-comment cmt"># find first valid content area to use</span>&#x000A;105:       <span class="ruby-identifier">first_content_item</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">table_of_contents</span>(<span class="ruby-identifier">:vetted_only=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">vetted</span>).<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">has_content?</span> }&#x000A;106:       <span class="ruby-ivar">@category_id</span> = <span class="ruby-identifier">first_content_item</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">first_content_item</span>.<span class="ruby-identifier">id</span> &#x000A;107:       <span class="ruby-ivar">@category_id</span> = <span class="ruby-ivar">@specify_category_id</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@specify_category_id</span><span class="ruby-operator">==</span><span class="ruby-value str">'default'</span>&#x000A;108:       &#x000A;109:       <span class="ruby-comment cmt"># default to regular page separator if we can't find a specific kingdom</span>&#x000A;110:       <span class="ruby-ivar">@page_separator</span>=<span class="ruby-value str">&quot;page-separator-general&quot;</span>&#x000A;111:       <span class="ruby-ivar">@page_separator</span>=<span class="ruby-node">&quot;page-separator-#{@taxon.kingdom.id}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">kingdom</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">$KINGDOM_IDs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">kingdom</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) &#x000A;112:        &#x000A;113:       <span class="ruby-ivar">@content</span>     = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">content_by_category</span>(<span class="ruby-ivar">@category_id</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@category_id</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">table_of_contents</span>(<span class="ruby-identifier">:vetted_only=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">vetted</span>).<span class="ruby-identifier">blank?</span>&#x000A;114:       <span class="ruby-ivar">@random_taxa</span> = <span class="ruby-constant">RandomTaxon</span>.<span class="ruby-identifier">random_set</span>(<span class="ruby-value">5</span>)&#x000A;115: &#x000A;116:       <span class="ruby-ivar">@ping_host_urls</span> = <span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">ping_host_urls</span>&#x000A;117:      &#x000A;118:       <span class="ruby-comment cmt"># just grab the first rank name (will be &quot;taxon&quot; if no rank available)</span>&#x000A;119:       <span class="ruby-ivar">@rank</span>=<span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">hierarchy_entries</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">rank_label</span>.<span class="ruby-identifier">capitalize</span>&#x000A;120:       &#x000A;121:       <span class="ruby-comment cmt"># log data objects shown and build an array of data_object_ids to log, so we can stick this info in the cached page and when the page comes from the cache, we can log on the server side</span>&#x000A;122:       <span class="ruby-ivar">@data_object_ids_to_log</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>&#x000A;123:       <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">blank?</span>&#x000A;124:         <span class="ruby-identifier">log_data_objects_for_taxon_concept</span> <span class="ruby-ivar">@taxon</span>, <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">first</span> &#x000A;125:         <span class="ruby-ivar">@data_object_ids_to_log</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">id</span>&#x000A;126:       <span class="ruby-keyword kw">end</span>&#x000A;127:       <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@content</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@content</span>[<span class="ruby-identifier">:data_objects</span>].<span class="ruby-identifier">blank?</span>&#x000A;128:         <span class="ruby-identifier">log_data_objects_for_taxon_concept</span> <span class="ruby-ivar">@taxon</span>, <span class="ruby-operator">*</span><span class="ruby-ivar">@content</span>[<span class="ruby-identifier">:data_objects</span>]&#x000A;129:         <span class="ruby-ivar">@content</span>[<span class="ruby-identifier">:data_objects</span>].<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">data_object</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@data_object_ids_to_log</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data_object</span>.<span class="ruby-identifier">id</span> }&#x000A;130:       <span class="ruby-keyword kw">end</span>&#x000A;131:       <span class="ruby-ivar">@data_object_ids_to_log</span>.<span class="ruby-identifier">compact!</span>&#x000A;132:       &#x000A;133:       <span class="ruby-ivar">@contains_unvetted_objects</span> = <span class="ruby-keyword kw">false</span> <span class="ruby-comment cmt"># per request by Jim Edwards on 11/5/2008 in Mexico, we should *not* show the top banner indicating there are unvetted objects on a page</span>&#x000A;134:       <span class="ruby-comment cmt">#@contains_unvetted_objects=((!current_user.vetted &amp;&amp; @taxon.includes_unvetted) ? true : false)  # uncomment this line to show unvetted warning on page with those objects</span>&#x000A;135:     &#x000A;136:     <span class="ruby-keyword kw">else</span>&#x000A;137:       &#x000A;138:       <span class="ruby-ivar">@cached</span>=<span class="ruby-keyword kw">true</span>&#x000A;139:         &#x000A;140:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># end get full page since we couldn't read from cache</span>&#x000A;141:    &#x000A;142:     <span class="ruby-ivar">@taxon_page_title</span>=<span class="ruby-identifier">remove_html</span>(<span class="ruby-ivar">@taxon</span>.<span class="ruby-identifier">title</span>) <span class="ruby-comment cmt"># we always need the title</span>&#x000A;143:         &#x000A;144:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:template=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'/taxa/show_cached'</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">allow_page_to_be_cached?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@specify_category_id</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'default'</span> <span class="ruby-comment cmt"># if caching is allowed, see if fragment exists using this template</span>&#x000A;145:     &#x000A;146:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000019'>
                <a name='M000019'>      </a>
                <div class='synopsis'>
                  <span class='name'>show_popup</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  AJAX: used to show a pop-up in a floating div, all views are in the
                  &#8220;popups&#8221; subfolder
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000019-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000019-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 343</span>&#x000A;343:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show_popup</span>&#x000A;344:     &#x000A;345:      <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:name</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>&#x000A;346:        <span class="ruby-identifier">template</span>=<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:name</span>]&#x000A;347:        <span class="ruby-ivar">@taxon_name</span>=<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:taxon_name</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;this taxon&quot;</span>&#x000A;348:        <span class="ruby-identifier">render</span> <span class="ruby-identifier">:layout=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:template=</span><span class="ruby-operator">&gt;</span><span class="ruby-value str">'popups/'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">template</span>&#x000A;349:      <span class="ruby-keyword kw">else</span>&#x000A;350:        <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword kw">true</span>&#x000A;351:      <span class="ruby-keyword kw">end</span>&#x000A;352:    &#x000A;353:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000018'>
                <a name='M000018'>      </a>
                <div class='synopsis'>
                  <span class='name'>show_video</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  AJAX: show the requested video
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000018-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000018-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 326</span>&#x000A;326:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show_video</span>&#x000A;327: &#x000A;328:    <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>&#x000A;329:      <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword kw">true</span>&#x000A;330:      <span class="ruby-keyword kw">return</span>&#x000A;331:    <span class="ruby-keyword kw">end</span>&#x000A;332:        &#x000A;333:     <span class="ruby-ivar">@video_url</span>=<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:video_url</span>]&#x000A;334:     <span class="ruby-identifier">video_type</span>=<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:video_type</span>].<span class="ruby-identifier">downcase</span>&#x000A;335:          &#x000A;336:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>&#x000A;337:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'video-player'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'video_'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">video_type</span>&#x000A;338:     <span class="ruby-keyword kw">end</span>&#x000A;339:     &#x000A;340:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000020'>
                <a name='M000020'>      </a>
                <div class='synopsis'>
                  <span class='name'>survey_response</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  AJAX: used to record the response that the user sends to the survey
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000020-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000020-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 356</span>&#x000A;356:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">survey_response</span>&#x000A;357:     &#x000A;358:     <span class="ruby-identifier">user_response</span>=<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:user_response</span>]&#x000A;359:     &#x000A;360:     <span class="ruby-constant">SurveyResponse</span>.<span class="ruby-identifier">create</span>(&#x000A;361:       <span class="ruby-identifier">:taxon_id=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:taxon_id</span>],&#x000A;362:       <span class="ruby-identifier">:ip_address=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">request</span>.<span class="ruby-identifier">remote_ip</span>,&#x000A;363:       <span class="ruby-identifier">:user_agent=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">request</span>.<span class="ruby-identifier">user_agent</span>,&#x000A;364:       <span class="ruby-identifier">:user_id=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>,&#x000A;365:       <span class="ruby-identifier">:user_response=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">user_response</span>&#x000A;366:       )     &#x000A;367:     &#x000A;368:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>&#x000A;369:     &#x000A;370:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000010'>
                <a name='M000010'>      </a>
                <div class='synopsis'>
                  <span class='name'>taxa</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  a permanent redirect to the new taxon page
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000010-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000010-source'>    <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 54</span>&#x000A;54:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taxa</span>&#x000A;55:   <span class="ruby-comment cmt">#  pp params</span>&#x000A;56:     <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;Status&quot;</span>] = <span class="ruby-value str">&quot;301 Moved Permanently&quot;</span>&#x000A;57:     <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">params</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'taxa'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'show'</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">HierarchyEntry</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]).<span class="ruby-identifier">taxon_concept_id</span>))&#x000A;58:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000021'>
                <a name='M000021'>      </a>
                <div class='synopsis'>
                  <span class='name'>view_object</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  AJAX: used to log when an object is viewed
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000021-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000021-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 373</span>&#x000A;373:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">view_object</span>&#x000A;374:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">post?</span>  &#x000A;375:       <span class="ruby-identifier">taxon</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:taxon_concept_id</span>].<span class="ruby-identifier">to_i</span>&#x000A;376:       <span class="ruby-comment cmt"># log each data object ID specified (separate multiple with commas)</span>&#x000A;377:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;,&quot;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">log_data_objects_for_taxon_concept</span> <span class="ruby-identifier">taxon</span>, <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>) }&#x000A;378:     <span class="ruby-keyword kw">end</span>&#x000A;379:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>&#x000A;380:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Protected instance methods</h2>
              <div class='protected-instance method' id='method-M000022'>
                <a name='M000022'>      </a>
                <div class='synopsis'>
                  <span class='name'>set_user_settings</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  Set the page expertise and vetted defaults, get from querystring, update
                  the session with this value if found
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000022-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000022-source'>     <span class="ruby-comment cmt"># File app/controllers/taxa_controller.rb, line 386</span>&#x000A;386:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_user_settings</span>&#x000A;387: &#x000A;388:       <span class="ruby-identifier">expertise</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:expertise</span>].<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword kw">if</span> [<span class="ruby-value str">'novice'</span>,<span class="ruby-value str">'middle'</span>,<span class="ruby-value str">'expert'</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:expertise</span>])&#x000A;389:       <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">expertise</span>=<span class="ruby-identifier">expertise</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">expertise</span>.<span class="ruby-identifier">nil?</span>&#x000A;390: &#x000A;391:       <span class="ruby-identifier">vetted</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:vetted</span>]&#x000A;392:       <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">vetted</span>=<span class="ruby-constant">EOLConvert</span>.<span class="ruby-identifier">to_boolean</span>(<span class="ruby-identifier">vetted</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">vetted</span>.<span class="ruby-identifier">blank?</span> &#x000A;393:       &#x000A;394:       <span class="ruby-comment cmt"># save user in database if they are logged in</span>&#x000A;395:       <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">save</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logged_in?</span>&#x000A;396:       &#x000A;397:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
