<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><title>Class: TaxonConcept</title><link type="text/css" href=".././rdoc-style.css" media="screen" rel="stylesheet"/><script type="text/javascript">
// Allison template
// Copyright 2007, 2008 Cloudburst, LLC. Licensed under the AFL 3. See the included LICENSE file.

var href_base = '.././rdoc-style.css'.replace(/(.*\/).*/, '$1'); // inline js is good for something  

function $(id) {
    if (document.getElementById)
      elem = document.getElementById(id);
    else if ( document.all )
      elem = eval("document.all." + id);
    else
      return false;
    return elem;
}

  function toggle(id) {
    elem = $(id);
    elemStyle = elem.style;   
    if (elemStyle.display == "block") {
      elemStyle.display = "none"
    } else {
      elemStyle.display = "block"
    }
    return true;
  }

  function toggleText(id) {
    elem = $(id)
    if (m = elem.innerHTML.match(/(Hide)(.*)/)) {
      elem.innerHTML = "Show" + m[2];
    } else if (m = elem.innerHTML.match(/(Show)(.*)/)) {
      elem.innerHTML = "Hide" + m[2];
    }
    return true;
  }

function span(s, klass) {
  return '<span class="' + klass + '">' + s + '</span>';
}
  
function highlightSymbols() {
  pres = document.getElementsByTagName('pre');
  for(var i = 0; i < pres.length; i++) {
    pre = pres[i];
    spans = pre.getElementsByTagName('span');
    for(var k = 0; k < spans.length; k++) {
      span = spans[k];
      if (span.className.match(/ruby-identifier/)) {
        if (span.innerHTML.match(/^:/)) {
          span.className += " ruby-symbol";
        }
      }
    }
  }
}

 function hasClass(obj) {
     var result = false;
     if (obj.getAttributeNode("class") != null) {
         result = obj.getAttributeNode("class").value;
     }
     return result;
  }   

 function stripe() {
    var even = true;
    var color = "#e4ebed";
    var tables = document.getElementsByTagName('table');
    if (tables.length == 0) { return; }
    for (var h = 0; h < tables.length; h++) {
        var trs = tables[h].getElementsByTagName("tr");
        for (var i = 0; i < trs.length; i++) {
          var tds = trs[i].getElementsByTagName("td");
            for (var j = 0; j < tds.length; j++) {       
              if (hasClass(tds[j]) != "first") {                
              var mytd = tds[j];
              if (even) {
                mytd.style.backgroundColor = color;
              }         
            }
          }
          even =  ! even;
      }
    }
  }
  
function ajaxGet(url) {
  url = (href_base + url).replace('/./', '/')
  var req = false;

  if (window.ActiveXObject) {
    try {
      // stupid hack because IE7 disables local Ajax with the native xmlhttprequest object
      // for security purposes. Yet ActiveX still works. Thanks, Microsoft. I hate you. Die.
      req = new ActiveXObject("MSXML2.XMLHTTP.3.0");
    } catch (e) {
      try {
        /* IE 6 and maybe 5, don't know, don't care */
        req = new ActiveXObject("Msxml2.XMLHTTP");
      } catch (e) {
        try {
          req = new ActiveXObject("Microsoft.XMLHTTP");
        } catch (e) {
          req = false;
        }
      }
    }
  }
    
  /* real browsers */
  if (!req && window.XMLHttpRequest) {
    try {
      req = new XMLHttpRequest();
    } catch (e) {
      req = false;
    }
  } 
  
  if (req) {
    req.open('GET', url, false);
    req.send(null);
    return req.responseText;
  } else {
    return "Ajax error";  
  }
}


function addEvent(elm, evType, fn, useCapture) {
	if (elm.addEventListener) {
	  elm.addEventListener(evType, fn, useCapture);  
  	return true;
	} else if (elm.attachEvent) {
  	var r = elm.attachEvent('on' + evType, fn);  
	  return r;  
	} else {
  	elm['on' + evType] = fn;
	}
}

function insertIndices() {
  pages = ["class", "file", "method"]
  for (x in pages) { 
    $(pages[x]).innerHTML += ajaxGet('fr_' + pages[x] + '_index.html').replace(/(href=")/g, '$1' + href_base);
  }
  /* mouseoverify method links */
  links = $('method').getElementsByTagName('a');
  for (var x = 0; x < links.length; x++) {
    if (m = links[x].innerHTML.match(/(.*)\s\((.*)\)/)) {
      links[x].innerHTML = m[1] + '<br>';
      links[x].title = m[2];
    }
  }
  /* this is stupid */
  $('class').style.display = "block";
  $('file').style.display = "block";
  
  /* has to be here because IE7 does not guarantee the onLoad callback order */
  abbreviateIndicesInner(["class", "file"], 25, "a");
  /* same, linkTitle() depends on the class link list */
  linkTitle();
}

function abbreviateIndices() {
  var ids = ["defined_in", "child_of", "includes", "requires", "method", "methods"];
  abbreviateIndicesInner(ids, 25, 'a');
  abbreviateIndicesInner(ids, 25, 'span');
}

function abbreviateIndicesInner(indices, amount, tag) {
  for (var x = 0; x < indices.length; x++) { 
    var the_index = $(indices[x]);
    if (the_index) {
      links = the_index.getElementsByTagName(tag);
      for (var y = 0; y < links.length; y++) {
        var link = links[y];
        if (link.getElementsByTagName('span').length == 0 && link.getElementsByTagName('a').length == 0) {
          // avoid nesting
          link.innerHTML = link.innerHTML.replace(/<br>|\n/gi, '');
          link.title = link.innerHTML;
          link.innerHTML = abbreviate(link.innerHTML, amount) + '<br>';
        }
      }
    }
  }
}

function linkTitle() {
  
  /* grab the correct title element from the index */
  var index_page = ajaxGet('index.html');
  title_text = index_page.match(/<title>(.*)<\/title>/m)[1];
  document.title = title_text + " - " + document.title;
  var p = $('header').getElementsByTagName('p')[0]
  if (p.innerHTML.match(/^\s*$/)) {
    p.innerHTML = title_text;
  } else {
    p.innerHTML = title_text + ": " + p.innerHTML;
  }
  
  /* set the link properly */
  title_link = index_page.match(/<a\s+href="(.*?)"/)[1];
  var element = $('title');
  var item_type = "";
  var item_name = "";
  if (m = element.innerHTML.match(/(Class:|Module:|File:)\s*(.*)/)) {
    item_type = m[1];
    item_name = m[2];
  } else {
    item_name = element.innerHTML;
  }
  element.innerHTML = '<a href="' + href_base + title_link + '">' + item_type + " " + abbreviate(item_name, 45) + '</a>';
  element.getElementsByTagName('a')[0].title = item_name
  
  /* breadcrumb navigation */
  items = item_name.split("::");
  items_new = item_name.split("::");
  file_links = $('class').getElementsByTagName('a');
  for (var x = 0; x < items.length - 1; x++ ){
    var item = items[x];
    link = ("/classes/" + items.slice(0,x).join("/") + "/" + item + ".html").replace('//', '/');
    regex = new RegExp(RegExp.escape(link) + '$');
    for (var y = 0; y < file_links.length; y++) {
      if (file_links[y].href.match(regex)) {
         items_new[x] = '<a href="' + href_base + link + '">' + item + '</a>';
         break;
      }
    }  
  }
  $('item_name').innerHTML = item_type + ' ' + items_new.join(" :: ");
}

function abbreviate(s, size) {
  while (s.length > size) {
    var old_s = s;
    s = s.replace(/\s|\n/mg, '');
    s = s.replace(/([A-Z])[a-z]+/m, '$1');
    if (!s || old_s == s) {
      return "..." + s.substring(s.length - size, s.length);
    }
  }
  return s;
}

function disableSubmit(event) {
  var keyCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
  if (keyCode == 13) {
    return false;
  } else {
    return true;
  }
}
  
function filterList(id, s, event) {
  
  /* some weak escaping */
  s = s.replace(/[^\w\d\.\_\-\/\:\=\[\]\?\!]/g, '');
  s = RegExp.escape(s);
  
  var show_all = false;
  if (s.match(/^\s*$/)) {
    show_all = true;
  }
  
  links = $(id).getElementsByTagName('a')
  regex = new RegExp(s, 'i');
  
  for (var x = 0; x < links.length; x++) {
    var link = links[x];
    if (show_all) {
      link.style.display = 'inline';
    } else {
       if (link.innerHTML.match(regex)) {        
         link.style.display = 'inline';
       } else {
         link.style.display = 'none';
       }
    }
  }
  return true;
}

RegExp.escape = function(text) {
  if (!arguments.callee.sRE) {
    var specials = ['/', '.', '*', '+', '?', '|', '(', ')', '[', ']', '{', '}', '\\'];
    arguments.callee.sRE = new RegExp(
      '(\\' + specials.join('|\\') + ')', 'g'
    );
  }
  return text.replace(arguments.callee.sRE, '\\$1');
}

function hacks() {
  // show the spacer if necessary, 
  divs = document.getElementsByTagName('div');
  for(var x = 0; x < divs.length; x++) {
    if (divs[x].className && divs[x].className.match(/top/)) {
      document.getElementById('spacer').style.display = 'block';
    }
  }
  // remove extra colons from tables
  tds = document.getElementsByTagName('td');
  for(var x = 0; x < tds.length; x++) {
    str = tds[x].innerHTML
    if (str.charAt(str.length - 1) == ":") {
      tds[x].innerHTML = str.slice(0, str.length - 1)
    }
  }
}

addEvent(window, 'load', insertIndices, false);
addEvent(window, 'load', abbreviateIndices, false);
addEvent(window, 'load', stripe, false);
addEvent(window, 'load', highlightSymbols, false);
addEvent(window, 'load', hacks, false);
</script></head><body><div id="container"><div class="curve" id="preheader_curve_0"></div><div class="curve" id="preheader_curve_1"></div><div class="curve" id="preheader_curve_2"></div><div class="curve" id="preheader_curve_3"></div><div class="curve" id="preheader_curve_4"></div><div class="curve" id="preheader_curve_5"></div><div id="header"><p>
</p><span><h1 id="title">
Class: TaxonConcept
</h1></span>
</div><div class="clear"></div><div id="left">
<div class="navigation darker top" id="child_of"><h3>Child of</h3><span>

<a href='SpeciesSchemaModel.html'>
SpeciesSchemaModel
</a>
</span></div>

<div class="navigation darker top" id="defined_in"><h3>Defined in</h3>

<a href="../files/app/models/taxon_concept_rb.html">app/models/taxon_concept.rb</a>

</div>



<div class="navigation top" id="methods"><h3>Methods</h3>


<a href='#M000494'>
&lt;=&gt;<br/>
</a>




<a href='#M000484'>
agent_url<br/>
</a>




<a href='#M000448'>
alternate_classification_name<br/>
</a>




<a href='#M000476'>
ancestry<br/>
</a>




<a href='#M000452'>
approved_curators<br/>
</a>




<a href='#M000464'>
available_media<br/>
</a>




<a href='#M000468'>
canonical_form<br/>
</a>




<a href='#M000447'>
canonical_form_object<br/>
</a>




<a href='#M000477'>
classification_attribution<br/>
</a>




<a href='#M000461'>
col_entry<br/>
</a>




<a href='#M000488'>
comment<br/>
</a>




<a href='#M000466'>
common_name<br/>
</a>




<a href='#M000479'>
content_by_category<br/>
</a>




<a href='#M000489'>
content_level<br/>
</a>




<a href='#M000463'>
current_agent=<br/>
</a>




<a href='#M000475'>
current_node<br/>
</a>




<a href='#M000462'>
current_user=<br/>
</a>




<a href='#M000490'>
direct_ancestors<br/>
</a>




<a href='#M000460'>
entry<br/>
</a>




<a href='#M000492'>
exemplars<br/>
</a>




<a href='#M000471'>
find_with_supercedure<br/>
</a>




<a href='#M000455'>
has_citation?<br/>
</a>




<a href='#M000465'>
has_name?<br/>
</a>




<a href='#M000454'>
hierarchy_entries_with_ancestors<br/>
</a>




<a href='#M000453'>
hierarchy_entries_with_parents<br/>
</a>




<a href='#M000480'>
images<br/>
</a>




<a href='#M000449'>
in_hierarchy<br/>
</a>




<a href='#M000491'>
is_curatable_by?<br/>
</a>




<a href='#M000483'>
iucn<br/>
</a>




<a href='#M000473'>
iucn_conservation_status<br/>
</a>




<a href='#M000474'>
iucn_conservation_status_url<br/>
</a>




<a href='#M000459'>
map<br/>
</a>




<a href='#M000450'>
mappings<br/>
</a>




<a href='#M000456'>
more_images<br/>
</a>




<a href='#M000457'>
more_videos<br/>
</a>




<a href='#M000446'>
name<br/>
</a>




<a href='#M000451'>
ping_host_urls<br/>
</a>




<a href='#M000469'>
quick_common_name<br/>
</a>




<a href='#M000470'>
quick_scientific_name<br/>
</a>




<a href='#M000472'>
quick_search<br/>
</a>




<a href='#M000467'>
scientific_name<br/>
</a>




<a href='#M000493'>
search<br/>
</a>




<a href='#M000487'>
smart_image<br/>
</a>




<a href='#M000486'>
smart_medium_thumb<br/>
</a>




<a href='#M000485'>
smart_thumb<br/>
</a>




<a href='#M000482'>
subtitle<br/>
</a>




<a href='#M000478'>
table_of_contents<br/>
</a>




<a href='#M000481'>
title<br/>
</a>




<a href='#M000458'>
videos<br/>
</a>




<a href='#M000495'>
visible_comments<br/>
</a>


</div>
<div id="spacer"></div><div class="navigation darker index" id="class_wrapper"><div class="list_header"><h3>All classes</h3></div><div class="list_header_link"><a onclick="toggle('class'); toggleText('class_link'); return false;" href="#" id="class_link">Hide...</a></div><div class="clear"></div><div id="class"><form><label for="filter_class">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('class', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_class"></input></form></div></div><div class="navigation darker index" id="file_wrapper"><div class="list_header"><h3>All files</h3></div><div class="list_header_link"><a onclick="toggle('file'); toggleText('file_link'); return false;" href="#" id="file_link">Hide...</a></div><div class="clear"></div><div id="file"><form><label for="filter_file">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('file', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_file"></input></form></div></div><div class="navigation darker index" id="method_wrapper"><div class="list_header"><h3>All methods</h3></div><div class="list_header_link"><a onclick="toggle('method'); toggleText('method_link'); return false;" href="#" id="method_link">Show...</a></div><div class="clear"></div><div id="method"><form><label for="filter_method">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('method', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_method"></input></form></div></div></div><div id="content">
<h1 id="item_name">Class: TaxonConcept</h1>

<div id="description"><p>
Represents the vague idea of a <a href="Taxon.html">Taxon</a>.
</p>
<p>
We get different interpretations of taxa from our partners (<a
href="ContentPartner.html">ContentPartner</a>), often differing slightly
and referring to basically the same thing, so <a
href="TaxonConcept.html">TaxonConcept</a> was created as a means to
reconcile the variant definitions of what are essentially the same <a
href="Taxon.html">Taxon</a>. We currently store basic <a
href="Taxon.html">Taxon</a> we receive from data imports in the
<tt>taxa</tt> table and we also store taxonomic hierarchies (<a
href="HierarchyEntry.html">HierarchyEntry</a>) in the
<tt>hierarchy_entries</tt> table. Currently <a
href="TaxonConcept.html">TaxonConcept</a> are groups of one or many <a
href="HierarchyEntry.html">HierarchyEntry</a>. We will eventually create
hierarchy_entries for each <a href="TaxonConcept.html#M000460">entry</a> in
the taxa table (<a href="Taxon.html">Taxon</a>).
</p>
<p>
It is worth mentioning that the &quot;eol.org/page/nnnn&quot; route is a
misnomer. Those IDs are, for the time-being, pointing to TaxonConcepts.
</p>
<p>
See the comments at the top of the <a href="Taxon.html">Taxon</a> for more
information on this. I include there a basic biological definition of what
a <a href="Taxon.html">Taxon</a> is.
</p>
</div>




<p></p>




<h1>Attributes</h1><p><table><tr><th>Name</th><th>Read/write?</th></tr>
<tr>
<td class="highlight">includes_unvetted</td>




<td class="normal">RW</td>
</tr>
</table></p>


<h1>Public Class Methods</h1>


<a class="small" name="M000490"><br/></a>
<div class="method_block"><h3>
<a href='#M000490'>


direct_ancestors

(tc)

</a>
</h3>

<p class="source_link" id="M000490-show-link"><a onclick="toggle('M000490-source'); toggleText('M000490-link'); return false;" href="#" id="M000490-link">Show source...</a></p><div class="source" id="M000490-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 420</span>
420:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">direct_ancestors</span>(<span class="ruby-identifier">tc</span>)
421:     <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tc</span>.<span class="ruby-identifier">nil?</span>
422:     <span class="ruby-identifier">he_all</span> = []
423:     <span class="ruby-identifier">tc</span>.<span class="ruby-identifier">hierarchy_entries</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">he</span><span class="ruby-operator">|</span>
424:       <span class="ruby-identifier">he_all</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">he</span>
425:       <span class="ruby-identifier">parent</span> = <span class="ruby-identifier">he</span>.<span class="ruby-identifier">parent</span>
426:       <span class="ruby-keyword kw">until</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">nil?</span>
427:         <span class="ruby-identifier">he_all</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">parent</span>
428:         <span class="ruby-identifier">parent</span> = <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">parent</span>
429:       <span class="ruby-keyword kw">end</span>
430:     <span class="ruby-keyword kw">end</span>
431:     <span class="ruby-identifier">he_all</span>
432:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000492"><br/></a>
<div class="method_block"><h3>
<a href='#M000492'>


exemplars

()

</a>
</h3>

<p class="source_link" id="M000492-show-link"><a onclick="toggle('M000492-source'); toggleText('M000492-link'); return false;" href="#" id="M000492-link">Show source...</a></p><div class="source" id="M000492-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 442</span>
442:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">exemplars</span>
443:     <span class="ruby-comment cmt"># TODO - this is now taxon-concept centric, so IDs will have to change.</span>
444:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@exemplars</span>.<span class="ruby-identifier">nil?</span>
445:       <span class="ruby-identifier">list</span> = [<span class="ruby-value">910093</span>, <span class="ruby-value">1009706</span>, <span class="ruby-value">912371</span>, <span class="ruby-value">976559</span>, <span class="ruby-value">597748</span>, <span class="ruby-value">1061748</span>, <span class="ruby-value">373667</span>, <span class="ruby-value">482935</span>, <span class="ruby-value">392557</span>, <span class="ruby-value">484592</span>, <span class="ruby-value">581125</span>, <span class="ruby-value">467045</span>, <span class="ruby-value">593213</span>, <span class="ruby-value">209984</span>, <span class="ruby-value">795869</span>, <span class="ruby-value">1049164</span>, <span class="ruby-value">604595</span>, <span class="ruby-value">983558</span>, <span class="ruby-value">253397</span>, <span class="ruby-value">740699</span>, <span class="ruby-value">1044544</span>, <span class="ruby-value">802455</span>, <span class="ruby-value">1194666</span>, <span class="ruby-value">2485151</span>]
446:     <span class="ruby-keyword kw">end</span>
447:     
448:     <span class="ruby-ivar">@@exemplars</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'id IN (?)'</span>, <span class="ruby-identifier">list</span>])
449: 
450:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000471"><br/></a>
<div class="method_block"><h3>
<a href='#M000471'>


find_with_supercedure

(*args)

</a>
</h3>
<p>
Some TaxonConcepts are &quot;superceded&quot; by others, and we need to
follow the chain as far as we can (up to a sane limit):
</p>

<p class="source_link" id="M000471-show-link"><a onclick="toggle('M000471-source'); toggleText('M000471-link'); return false;" href="#" id="M000471-link">Show source...</a></p><div class="source" id="M000471-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 212</span>
212:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_with_supercedure</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
213:     <span class="ruby-identifier">concept</span> = <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">find_without_supercedure</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
214:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">concept</span>.<span class="ruby-identifier">nil?</span>
215:     <span class="ruby-identifier">id</span> = <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>]
216:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">concept</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^\d+$/</span>
217:     <span class="ruby-identifier">attempts</span> = <span class="ruby-value">6</span>
218:     <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">concept</span>.<span class="ruby-identifier">supercedure_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">attempts</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">6</span>
219:       <span class="ruby-identifier">concept</span> = <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">find_without_supercedure</span>(<span class="ruby-identifier">concept</span>.<span class="ruby-identifier">supercedure_id</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
220:       <span class="ruby-identifier">attempts</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
221:     <span class="ruby-keyword kw">end</span>
222:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">concept</span>
223:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000472"><br/></a>
<div class="method_block"><h3>
<a href='#M000472'>


quick_search

(search_string, options = {})

</a>
</h3>

<p class="source_link" id="M000472-show-link"><a onclick="toggle('M000472-source'); toggleText('M000472-link'); return false;" href="#" id="M000472-link">Show source...</a></p><div class="source" id="M000472-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 226</span>
226:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">quick_search</span>(<span class="ruby-identifier">search_string</span>, <span class="ruby-identifier">options</span> = {})
227:     <span class="ruby-comment cmt"># TODO - we have qualifier, scope, and search_lang diabled for now, so I am ignoring them entirely.</span>
228:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:qualifier</span>]       <span class="ruby-operator">||=</span> <span class="ruby-value str">'contains'</span>
229:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:scope</span>]           <span class="ruby-operator">||=</span> <span class="ruby-value str">'all'</span>
230:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:search_language</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">'all'</span>
231:     
232:     <span class="ruby-comment cmt"># TODO - insert into search terms, popular searches, and the like.</span>
233:     
234:     <span class="ruby-comment cmt"># TODO - I'm not sure this is really what we want to be doing, here: I simply reproduced Patrick's code (for the most part).</span>
235:     <span class="ruby-identifier">search_terms</span> = <span class="ruby-identifier">search_string</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\s+/</span>, <span class="ruby-value str">' '</span>).<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/[ -&amp;:\\'?;]+| and /</span>)
236:     
237:     <span class="ruby-identifier">sci_concepts</span>  = []
238:     <span class="ruby-identifier">com_concepts</span>  = []
239:     <span class="ruby-identifier">errors</span>       = <span class="ruby-keyword kw">nil</span>
240:     <span class="ruby-identifier">num_matches</span>  = {}
241:     
242:     
243:     <span class="ruby-identifier">modified_search_terms</span> = []
244:     <span class="ruby-identifier">search_terms</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">orig_term</span><span class="ruby-operator">|</span>
245:       <span class="ruby-identifier">term</span> = <span class="ruby-identifier">orig_term</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\*/</span>, <span class="ruby-value str">'EOL_WILDCARD'</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[\W\-]/</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">'EOL_WILDCARD'</span>, <span class="ruby-value str">'%'</span>)
246:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">term</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">'%'</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span>
247:         <span class="ruby-identifier">errors</span> <span class="ruby-operator">||=</span> []
248:         <span class="ruby-identifier">errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;All search terms must contain at least three characters. '#{orig_term}' is too short.&quot;</span>
249:       <span class="ruby-keyword kw">end</span>
250:       
251:       <span class="ruby-identifier">search_type</span> = <span class="ruby-identifier">term</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp re">/%/</span>) <span class="ruby-operator">?</span> <span class="ruby-value str">'LIKE'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">'='</span>
252:       
253:       <span class="ruby-identifier">modified_search_terms</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;nn.name_part #{search_type} '#{term}'&quot;</span>
254:     <span class="ruby-keyword kw">end</span>
255:     
256:     
257:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">modified_search_terms</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> 
258:       <span class="ruby-keyword kw">return</span> {<span class="ruby-identifier">:common</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">com_concepts</span>,
259:               <span class="ruby-identifier">:scientific</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sci_concepts</span>,
260:               <span class="ruby-identifier">:errors</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">errors</span>}
261:     <span class="ruby-keyword kw">end</span>
262:     
263:     <span class="ruby-identifier">name_ids</span> = <span class="ruby-constant">SpeciesSchemaModel</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_values</span>(<span class="ruby-node">&quot;SELECT name_id, count(*) FROM normalized_names nn STRAIGHT_JOIN normalized_links nl ON (nn.id=nl.normalized_name_id) WHERE (#{modified_search_terms.join(' OR ')}) AND nl.normalized_qualifier_id=1 GROUP BY name_id HAVING count(*)&gt;=#{modified_search_terms.length}&quot;</span>)
264:     
265:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">name_ids</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> 
266:       <span class="ruby-keyword kw">return</span> {<span class="ruby-identifier">:common</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">com_concepts</span>,
267:               <span class="ruby-identifier">:scientific</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sci_concepts</span>,
268:               <span class="ruby-identifier">:errors</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">errors</span>}
269:     <span class="ruby-keyword kw">end</span>
270:     
271:     
272:     <span class="ruby-identifier">agent_clause</span> = <span class="ruby-value str">''</span>
273:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:agent</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">is_admin?</span>)
274:       <span class="ruby-identifier">agent_clause</span> = <span class="ruby-node">&quot;LEFT JOIN (agents_resources ar JOIN hierarchies_resources hr ON (ar.resource_id=hr.resource_id AND ar.resource_agent_role_id = #{ResourceAgentRole.content_partner_upload_role.id}) JOIN hierarchy_entries he2 ON (hr.hierarchy_id=he2.hierarchy_id)) ON (he2.taxon_concept_id=tc.id)&quot;</span>
275:     <span class="ruby-keyword kw">end</span>
276:     
277:     <span class="ruby-identifier">vetted_condition</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">vetted</span> <span class="ruby-value">? </span><span class="ruby-node">&quot;(published=1 AND tc.vetted_id=#{Vetted.trusted.id})&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;published=1&quot;</span>
278:     <span class="ruby-identifier">agent_condition</span> =  <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:agent</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">''</span> <span class="ruby-operator">:</span> <span class="ruby-node">&quot;OR ar.agent_id=#{options[:agent].id}&quot;</span>
279:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:user</span>].<span class="ruby-identifier">is_admin?</span>
280:       <span class="ruby-identifier">agent_condition</span> = <span class="ruby-value str">&quot;OR ar.agent_id IS NOT NULL&quot;</span>
281:     <span class="ruby-keyword kw">end</span>
282:     
283:     <span class="ruby-identifier">taxon_concept_ids</span> = <span class="ruby-constant">SpeciesSchemaModel</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;SELECT tcn.taxon_concept_id id, tcn.vern is_vern, tcn.preferred preferred, tcc.content_level content_level, n.string matching_string, n.italicized matching_italicized_string, he.hierarchy_id hierarchy_id FROM taxon_concept_names tcn STRAIGHT_JOIN names n ON (tcn.name_id=n.id) STRAIGHT_JOIN taxon_concepts tc ON (tc.id = tcn.taxon_concept_id) LEFT JOIN taxon_concept_content tcc ON (tcn.taxon_concept_id=tcc.taxon_concept_id) LEFT JOIN hierarchy_entries he ON (tcn.source_hierarchy_entry_id=he.id) #{agent_clause} WHERE tcn.name_id IN (#{name_ids.join(',')}) AND (#{vetted_condition} #{agent_condition}) ORDER BY preferred DESC&quot;</span>).<span class="ruby-identifier">all_hashes</span>
284:     
285:     <span class="ruby-identifier">used_concept_ids</span> = []
286:     <span class="ruby-identifier">sci_concepts</span> = []
287:     <span class="ruby-identifier">com_concepts</span> = []
288:     
289:     <span class="ruby-identifier">taxon_concept_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">result</span><span class="ruby-operator">|</span>
290:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">used_concept_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">result</span>[<span class="ruby-value str">'id'</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">result</span>[<span class="ruby-value str">'hierarchy_id'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Hierarchy</span>.<span class="ruby-identifier">default</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>[<span class="ruby-value str">'preferred'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
291:         
292:         <span class="ruby-comment cmt"># Remove existing concept representative if we have one from default hierarchy</span>
293:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>[<span class="ruby-value str">'hierarchy_id'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Hierarchy</span>.<span class="ruby-identifier">default</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>[<span class="ruby-value str">'preferred'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
294:           <span class="ruby-identifier">sci_concepts</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">concept</span><span class="ruby-operator">|</span> <span class="ruby-identifier">concept</span>[<span class="ruby-value str">'id'</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">result</span>[<span class="ruby-value str">'id'</span>] }
295:           <span class="ruby-identifier">com_concepts</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">concept</span><span class="ruby-operator">|</span> <span class="ruby-identifier">concept</span>[<span class="ruby-value str">'id'</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">result</span>[<span class="ruby-value str">'id'</span>] }
296:         <span class="ruby-keyword kw">end</span>
297:         
298:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>[<span class="ruby-value str">'is_vern'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
299:           <span class="ruby-identifier">sci_concepts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">result</span>
300:         <span class="ruby-keyword kw">else</span>
301:           <span class="ruby-identifier">com_concepts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">result</span>
302:         <span class="ruby-keyword kw">end</span>
303:         
304:         <span class="ruby-identifier">used_concept_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">result</span>[<span class="ruby-value str">'id'</span>].<span class="ruby-identifier">to_i</span>
305:       <span class="ruby-keyword kw">end</span>
306:     <span class="ruby-keyword kw">end</span>
307: 
308:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">taxon_concept_ids</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
309:       <span class="ruby-identifier">errors</span> <span class="ruby-operator">||=</span> []
310:       <span class="ruby-identifier">errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;There were no matches for the search term #{search_string}&quot;</span>
311:     <span class="ruby-keyword kw">end</span>
312:     
313:     <span class="ruby-keyword kw">return</span> {<span class="ruby-identifier">:common</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">com_concepts</span>,
314:             <span class="ruby-identifier">:scientific</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sci_concepts</span>,
315:             <span class="ruby-identifier">:errors</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">errors</span>}
316: 
317:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000493"><br/></a>
<div class="method_block"><h3>
<a href='#M000493'>


search

(search_string, options = {})

</a>
</h3>

<p class="source_link" id="M000493-show-link"><a onclick="toggle('M000493-source'); toggleText('M000493-link'); return false;" href="#" id="M000493-link">Show source...</a></p><div class="source" id="M000493-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 452</span>
452:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">search</span>(<span class="ruby-identifier">search_string</span>, <span class="ruby-identifier">options</span> = {})
453:     <span class="ruby-comment cmt"># TODO - we have qualifier, scope, and search_lang diabled for now, so I am ignoring them entirely.</span>
454:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:qualifier</span>]       <span class="ruby-operator">||=</span> <span class="ruby-value str">'contains'</span>
455:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:scope</span>]           <span class="ruby-operator">||=</span> <span class="ruby-value str">'all'</span>
456:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:search_language</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">'all'</span>
457: 
458:     <span class="ruby-comment cmt"># TODO - insert into search terms, popular searches, and the like.</span>
459: 
460:     <span class="ruby-comment cmt"># TODO - I'm not sure this is really what we want to be doing, here: I simply reproduced Patrick's code (for the most part).</span>
461:     <span class="ruby-identifier">search_terms</span> = <span class="ruby-identifier">search_string</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\s+/</span>, <span class="ruby-value str">' '</span>).<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/[ -&amp;:\\'?;]+| and /</span>)
462: 
463:     <span class="ruby-identifier">sci_concepts</span>  = []
464:     <span class="ruby-identifier">com_concepts</span>  = []
465:     <span class="ruby-identifier">errors</span>       = <span class="ruby-keyword kw">nil</span>
466:     <span class="ruby-identifier">num_matches</span>  = {}
467: 
468:     <span class="ruby-identifier">search_terms</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">orig_term</span><span class="ruby-operator">|</span>
469:       <span class="ruby-identifier">term</span> = <span class="ruby-identifier">orig_term</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\*/</span>, <span class="ruby-value str">'EOL_WILDCARD'</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[\W\-]/</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">'EOL_WILDCARD'</span>, <span class="ruby-value str">'%'</span>)
470:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">term</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">'%'</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span>
471:         <span class="ruby-identifier">errors</span> <span class="ruby-operator">||=</span> []
472:         <span class="ruby-identifier">errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;All search terms must contain at least three characters. '#{orig_term}' is too short.&quot;</span>
473:       <span class="ruby-keyword kw">end</span>
474:       <span class="ruby-comment cmt"># I was going to make everything wildcarded, but....  term = &quot;%#{term}%&quot;.gsub('%+', '%')</span>
475:       <span class="ruby-identifier">search_type</span> = <span class="ruby-identifier">term</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp re">/%/</span>) <span class="ruby-operator">?</span> <span class="ruby-value str">'LIKE'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">'='</span>
476: 
477:       <span class="ruby-comment cmt"># TODO - this will only search names (not authors or years), thanks to the hard-coded &quot;1&quot; below.</span>
478: <span class="ruby-comment cmt">#       concepts = TaxonConcept.find_by_sql([&lt;&lt;EO_FIND_NAMES, term])</span>
479: <span class="ruby-comment cmt">#   SELECT DISTINCT tc.id, tcn.vern vern</span>
480: <span class="ruby-comment cmt">#     FROM taxon_concepts tc</span>
481: <span class="ruby-comment cmt">#       JOIN taxon_concept_names tcn ON (tcn.taxon_concept_id = tc.id)</span>
482: <span class="ruby-comment cmt">#       JOIN normalized_links nl ON (nl.name_id = tcn.name_id)</span>
483: <span class="ruby-comment cmt">#       JOIN normalized_names nn ON (nn.id = nl.normalized_name_id)</span>
484: <span class="ruby-comment cmt">#     WHERE nn.name_part #{search_type} ?</span>
485: <span class="ruby-comment cmt">#       AND nl.normalized_qualifier_id = 1 # TaxonConcept.search</span>
486: <span class="ruby-comment cmt"># EO_FIND_NAMES</span>
487: 
488:       <span class="ruby-identifier">concepts</span> = <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">find_by_sql</span>([<span class="ruby-value str">&quot;  SELECT DISTINCT tcn.taxon_concept_id id, tcn.vern vern\n  FROM normalized_names nn\n  STRAIGHT_JOIN normalized_links nl ON (nn.id=nl.normalized_name_id)\n  STRAIGHT_JOIN taxon_concept_names tcn ON (nl.name_id=tcn.name_id)\n  WHERE nn.name_part \#{search_type} ?\n  AND nl.normalized_qualifier_id = 1 # TaxonConcept.search\n&quot;</span>, <span class="ruby-identifier">term</span>])
489: 
490:       <span class="ruby-comment cmt"># NOTE: For whatever reason, Rails makes TINYINTs into strings.  Thus the to_i.</span>
491:       <span class="ruby-identifier">sci_concepts</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">concepts</span>.<span class="ruby-identifier">find_all</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">concept</span><span class="ruby-operator">|</span> <span class="ruby-identifier">concept</span>.<span class="ruby-identifier">vern</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> }
492:       <span class="ruby-identifier">com_concepts</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">concepts</span>.<span class="ruby-identifier">find_all</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">concept</span><span class="ruby-operator">|</span> <span class="ruby-identifier">concept</span>.<span class="ruby-identifier">vern</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> }
493:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">concepts</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
494:         <span class="ruby-identifier">errors</span> <span class="ruby-operator">||=</span> []
495:         <span class="ruby-identifier">errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;There were no matches for the search term #{orig_term}&quot;</span>
496:       <span class="ruby-keyword kw">end</span>
497: 
498:     <span class="ruby-keyword kw">end</span>
499: 
500:     <span class="ruby-keyword kw">return</span> {<span class="ruby-identifier">:common</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">com_concepts</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>,
501:             <span class="ruby-identifier">:scientific</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sci_concepts</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>,
502:             <span class="ruby-identifier">:errors</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">errors</span>}
503: 
504:   <span class="ruby-keyword kw">end</span></pre></div>
</div>


<h1>Public Instance Methods</h1>


<a class="small" name="M000494"><br/></a>
<div class="method_block"><h3>
<a href='#M000494'>


&lt;=&gt;

(other)

</a>
</h3>
<p>
This could use <a href="TaxonConcept.html#M000446">name</a>&#8230; but I
only need it for searches, and ID is all that matters, there.
</p>

<p class="source_link" id="M000494-show-link"><a onclick="toggle('M000494-source'); toggleText('M000494-link'); return false;" href="#" id="M000494-link">Show source...</a></p><div class="source" id="M000494-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 515</span>
515:   <span class="ruby-keyword kw">def</span> <span class="ruby-operator">&lt;=&gt;</span>(<span class="ruby-identifier">other</span>)
516:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">id</span>
517:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000484"><br/></a>
<div class="method_block"><h3>
<a href='#M000484'>


agent_url

()

</a>
</h3>

<p class="source_link" id="M000484-show-link"><a onclick="toggle('M000484-source'); toggleText('M000484-link'); return false;" href="#" id="M000484-link">Show source...</a></p><div class="source" id="M000484-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 393</span>
393:                               <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">agent_url</span>; <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Agent</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">homepage</span>; <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000448"><br/></a>
<div class="method_block"><h3>
<a href='#M000448'>


alternate_classification_name

(detail_level = :middle, language = Language.english, context = nil)

</a>
</h3>

<p class="source_link" id="M000448-show-link"><a onclick="toggle('M000448-source'); toggleText('M000448-link'); return false;" href="#" id="M000448-link">Show source...</a></p><div class="source" id="M000448-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 54</span>
54:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">alternate_classification_name</span>(<span class="ruby-identifier">detail_level</span> = <span class="ruby-identifier">:middle</span>, <span class="ruby-identifier">language</span> = <span class="ruby-constant">Language</span>.<span class="ruby-identifier">english</span>, <span class="ruby-identifier">context</span> = <span class="ruby-keyword kw">nil</span>)
55:     <span class="ruby-comment cmt">#return col_he.nil? ? alternate_classification_name(detail_level, language, context) : col_he.name(detail_level, language, context)</span>
56:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">hierarchy_entries</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">name</span>(<span class="ruby-identifier">detail_level</span>, <span class="ruby-identifier">language</span>, <span class="ruby-identifier">context</span>).<span class="ruby-identifier">firstcap</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-value str">'?-?'</span>
57:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000476"><br/></a>
<div class="method_block"><h3>
<a href='#M000476'>


ancestry

(hierarchy_id = nil)

</a>
</h3>

<p class="source_link" id="M000476-show-link"><a onclick="toggle('M000476-source'); toggleText('M000476-link'); return false;" href="#" id="M000476-link">Show source...</a></p><div class="source" id="M000476-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 331</span>
331:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ancestry</span>(<span class="ruby-identifier">hierarchy_id</span> = <span class="ruby-keyword kw">nil</span>)
332:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">entry</span>(<span class="ruby-identifier">hierarchy_id</span>).<span class="ruby-identifier">ancestors</span>
333:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000452"><br/></a>
<div class="method_block"><h3>
<a href='#M000452'>


approved_curators

()

</a>
</h3>

<p class="source_link" id="M000452-show-link"><a onclick="toggle('M000452-source'); toggleText('M000452-link'); return false;" href="#" id="M000452-link">Show source...</a></p><div class="source" id="M000452-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 81</span>
81:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">approved_curators</span>
82:     <span class="ruby-identifier">approved</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>
83:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">hierarchy_entries</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">he</span><span class="ruby-operator">|</span>
84:       <span class="ruby-identifier">approved</span>.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">he</span>.<span class="ruby-identifier">approved_curators</span>
85:     <span class="ruby-keyword kw">end</span>
86:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">approved</span>
87:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000464"><br/></a>
<div class="method_block"><h3>
<a href='#M000464'>


available_media

()

</a>
</h3>

<p class="source_link" id="M000464-show-link"><a onclick="toggle('M000464-source'); toggleText('M000464-link'); return false;" href="#" id="M000464-link">Show source...</a></p><div class="source" id="M000464-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 142</span>
142:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">available_media</span>
143:     <span class="ruby-identifier">images</span> = <span class="ruby-identifier">video</span> = <span class="ruby-identifier">map</span> = <span class="ruby-keyword kw">false</span>
144:     <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">entry</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">hierarchy_entries</span>
145:       <span class="ruby-identifier">images</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">hierarchies_content</span>.<span class="ruby-identifier">image</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">hierarchies_content</span>.<span class="ruby-identifier">child_image</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-identifier">images</span>
146:       <span class="ruby-identifier">video</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">hierarchies_content</span>.<span class="ruby-identifier">flash</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">hierarchies_content</span>.<span class="ruby-identifier">youtube</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-identifier">video</span>
147:       <span class="ruby-identifier">map</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">hierarchies_content</span>.<span class="ruby-identifier">gbif_image</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-identifier">map</span>
148:     <span class="ruby-keyword kw">end</span>
149:     
150:     {<span class="ruby-identifier">:images</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">images</span>,
151:      <span class="ruby-identifier">:video</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">video</span>,
152:      <span class="ruby-identifier">:map</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">map</span> }
153:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000468"><br/></a>
<div class="method_block"><h3>
<a href='#M000468'>


canonical_form

()

</a>
</h3>

<p class="source_link" id="M000468-show-link"><a onclick="toggle('M000468-source'); toggleText('M000468-link'); return false;" href="#" id="M000468-link">Show source...</a></p><div class="source" id="M000468-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 176</span>
176:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">canonical_form</span>
177:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">name</span>(<span class="ruby-identifier">:canonical</span>)
178:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000447"><br/></a>
<div class="method_block"><h3>
<a href='#M000447'>


canonical_form_object

()

</a>
</h3>

<p class="source_link" id="M000447-show-link"><a onclick="toggle('M000447-source'); toggleText('M000447-link'); return false;" href="#" id="M000447-link">Show source...</a></p><div class="source" id="M000447-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 49</span>
49:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">canonical_form_object</span>
50:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">canonical_form</span>
51:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000477"><br/></a>
<div class="method_block"><h3>
<a href='#M000477'>


classification_attribution

()

</a>
</h3>

<p class="source_link" id="M000477-show-link"><a onclick="toggle('M000477-source'); toggleText('M000477-link'); return false;" href="#" id="M000477-link">Show source...</a></p><div class="source" id="M000477-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 335</span>
335:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">classification_attribution</span>
336:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">classification_attribution</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-value str">&quot;&quot;</span>
337:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000461"><br/></a>
<div class="method_block"><h3>
<a href='#M000461'>


col_entry

()

</a>
</h3>
<p>
We do have some content that is specific to COL, so we need a method that
will ALWAYS reference it:
</p>

<p class="source_link" id="M000461-show-link"><a onclick="toggle('M000461-source'); toggleText('M000461-link'); return false;" href="#" id="M000461-link">Show source...</a></p><div class="source" id="M000461-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 128</span>
128:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">col_entry</span>
129:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@col_entry</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@col_entry</span>.<span class="ruby-identifier">nil?</span>
130:     <span class="ruby-identifier">hierarchy_id</span> = <span class="ruby-constant">Hierarchy</span>.<span class="ruby-identifier">default</span>.<span class="ruby-identifier">id</span>
131:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@col_entry</span> = <span class="ruby-identifier">hierarchy_entries</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">he</span><span class="ruby-operator">|</span> <span class="ruby-identifier">he</span>.<span class="ruby-identifier">hierarchy_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hierarchy_id</span> }
132:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000488"><br/></a>
<div class="method_block"><h3>
<a href='#M000488'>


comment

(user, body)

</a>
</h3>
<p>
<a href="TaxonConcept.html#M000488">comment</a> on this
</p>

<p class="source_link" id="M000488-show-link"><a onclick="toggle('M000488-source'); toggleText('M000488-link'); return false;" href="#" id="M000488-link">Show source...</a></p><div class="source" id="M000488-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 410</span>
410:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">comment</span> <span class="ruby-identifier">user</span>, <span class="ruby-identifier">body</span>
411:     <span class="ruby-identifier">comment</span> = <span class="ruby-identifier">comments</span>.<span class="ruby-identifier">create</span> <span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">user</span>, <span class="ruby-identifier">:body</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">body</span>
412:     <span class="ruby-identifier">user</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">reload</span> <span class="ruby-comment cmt"># be friendly - update the user's comments automatically</span>
413:     <span class="ruby-identifier">comment</span>
414:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000466"><br/></a>
<div class="method_block"><h3>
<a href='#M000466'>


common_name

()

</a>
</h3>
<p>
TODO - stop calling these.
</p>

<p class="source_link" id="M000466-show-link"><a onclick="toggle('M000466-source'); toggleText('M000466-link'); return false;" href="#" id="M000466-link">Show source...</a></p><div class="source" id="M000466-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 168</span>
168:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">common_name</span>
169:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">name</span>(<span class="ruby-identifier">:middle</span>)
170:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000479"><br/></a>
<div class="method_block"><h3>
<a href='#M000479'>


content_by_category

(category_id, options = {})

</a>
</h3>
<p>
pull content type by given category for taxa id
</p>

<p class="source_link" id="M000479-show-link"><a onclick="toggle('M000479-source'); toggleText('M000479-link'); return false;" href="#" id="M000479-link">Show source...</a></p><div class="source" id="M000479-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 346</span>
346:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">content_by_category</span>(<span class="ruby-identifier">category_id</span>, <span class="ruby-identifier">options</span> = {})
347:     <span class="ruby-identifier">toc_item</span> = <span class="ruby-constant">TocItem</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">category_id</span>)
348:     <span class="ruby-identifier">sub_name</span> = <span class="ruby-identifier">toc_item</span>.<span class="ruby-identifier">label</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\W/</span>, <span class="ruby-value str">'_'</span>).<span class="ruby-identifier">downcase</span>
349:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">sub_name</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">private_methods</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">sub_name</span>)
350:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">get_default_content</span>(<span class="ruby-identifier">category_id</span>, <span class="ruby-identifier">options</span>)
351:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000489"><br/></a>
<div class="method_block"><h3>
<a href='#M000489'>


content_level

()

</a>
</h3>

<p class="source_link" id="M000489-show-link"><a onclick="toggle('M000489-source'); toggleText('M000489-link'); return false;" href="#" id="M000489-link">Show source...</a></p><div class="source" id="M000489-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 416</span>
416:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">content_level</span>
417:     <span class="ruby-identifier">taxon_concept_content</span>.<span class="ruby-identifier">content_level</span>
418:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000463"><br/></a>
<div class="method_block"><h3>
<a href='#M000463'>


current_agent=

(agent)

</a>
</h3>

<p class="source_link" id="M000463-show-link"><a onclick="toggle('M000463-source'); toggleText('M000463-link'); return false;" href="#" id="M000463-link">Show source...</a></p><div class="source" id="M000463-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 138</span>
138:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">current_agent=</span>(<span class="ruby-identifier">agent</span>)
139:     <span class="ruby-ivar">@current_agent</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">agent</span>
140:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000475"><br/></a>
<div class="method_block"><h3>
<a href='#M000475'>


current_node

(hierarchy_id = nil)

</a>
</h3>
<p>
TODO - find refs to these and make them grab a hierarchy&#8230;
</p>

<p class="source_link" id="M000475-show-link"><a onclick="toggle('M000475-source'); toggleText('M000475-link'); return false;" href="#" id="M000475-link">Show source...</a></p><div class="source" id="M000475-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 328</span>
328:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">current_node</span>(<span class="ruby-identifier">hierarchy_id</span> = <span class="ruby-keyword kw">nil</span>)
329:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">entry</span>(<span class="ruby-identifier">hierarchy_id</span>)
330:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000462"><br/></a>
<div class="method_block"><h3>
<a href='#M000462'>


current_user=

(user)

</a>
</h3>

<p class="source_link" id="M000462-show-link"><a onclick="toggle('M000462-source'); toggleText('M000462-link'); return false;" href="#" id="M000462-link">Show source...</a></p><div class="source" id="M000462-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 134</span>
134:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">current_user=</span>(<span class="ruby-identifier">user</span>)
135:     <span class="ruby-ivar">@current_user</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">user</span>
136:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000460"><br/></a>
<div class="method_block"><h3>
<a href='#M000460'>


entry

(hierarchy = Hierarchy.default)

</a>
</h3>
<p>
Singleton method to fetch the <a href="Hierarchy.html">Hierarchy</a> Entry,
used for taxonomic relationships
</p>

<p class="source_link" id="M000460-show-link"><a onclick="toggle('M000460-source'); toggleText('M000460-link'); return false;" href="#" id="M000460-link">Show source...</a></p><div class="source" id="M000460-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 122</span>
122:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">entry</span>(<span class="ruby-identifier">hierarchy</span> = <span class="ruby-constant">Hierarchy</span>.<span class="ruby-identifier">default</span>)
123:     <span class="ruby-identifier">hierarchy_id</span> = <span class="ruby-identifier">hierarchy</span>.<span class="ruby-identifier">id</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
124:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">hierarchy_entries</span>.<span class="ruby-identifier">detect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">he</span><span class="ruby-operator">|</span> <span class="ruby-identifier">he</span>.<span class="ruby-identifier">hierarchy_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hierarchy_id</span> } <span class="ruby-operator">||</span> <span class="ruby-identifier">hierarchy_entries</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">raise</span>(<span class="ruby-constant">Exception</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;Taxon concept must have at least one hierarchy entry&quot;</span>))
125:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000455"><br/></a>
<div class="method_block"><h3>
<a href='#M000455'>


has_citation?

()

</a>
</h3>

<p class="source_link" id="M000455-show-link"><a onclick="toggle('M000455-source'); toggleText('M000455-link'); return false;" href="#" id="M000455-link">Show source...</a></p><div class="source" id="M000455-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 94</span>
94:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_citation?</span>
95:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
96:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000465"><br/></a>
<div class="method_block"><h3>
<a href='#M000465'>


has_name?

()

</a>
</h3>
<p>
def <a href="TaxonConcept.html#M000464">available_media</a>
</p>
<pre>
  {:images =&gt; hierarchies_content.image != 0 || hierarchies_content.child_image  != 0,
   :video  =&gt; hierarchies_content.flash != 0 || hierarchies_content.youtube != 0,
   :map    =&gt; hierarchies_content.gbif_image != 0}

  #return entry.media
</pre>
<p>
end
</p>

<p class="source_link" id="M000465-show-link"><a onclick="toggle('M000465-source'); toggleText('M000465-link'); return false;" href="#" id="M000465-link">Show source...</a></p><div class="source" id="M000465-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 163</span>
163:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_name?</span>
164:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">content_level</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
165:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000454"><br/></a>
<div class="method_block"><h3>
<a href='#M000454'>


hierarchy_entries_with_ancestors

()

</a>
</h3>
<p>
Alias for <a
href="TaxonConcept.html#M000453">hierarchy_entries_with_parents</a>
</p>

</div>

<a class="small" name="M000453"><br/></a>
<div class="method_block"><h3>
<a href='#M000453'>


hierarchy_entries_with_parents

()

</a>
</h3>

<p class="source_link" id="M000453-show-link"><a onclick="toggle('M000453-source'); toggleText('M000453-link'); return false;" href="#" id="M000453-link">Show source...</a></p><div class="source" id="M000453-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 89</span>
89:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">hierarchy_entries_with_parents</span>
90:     <span class="ruby-constant">HierarchyEntry</span>.<span class="ruby-identifier">with_parents</span> <span class="ruby-keyword kw">self</span>
91:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000480"><br/></a>
<div class="method_block"><h3>
<a href='#M000480'>


images

(options = {})

</a>
</h3>
<p>
This used to be singleton, but now we&#8216;re changing the views (based on
permissions) a lot, so I removed it.
</p>

<p class="source_link" id="M000480-show-link"><a onclick="toggle('M000480-source'); toggleText('M000480-link'); return false;" href="#" id="M000480-link">Show source...</a></p><div class="source" id="M000480-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 354</span>
354:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">images</span>(<span class="ruby-identifier">options</span> = {})
355:     <span class="ruby-identifier">images</span> = <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">for_taxon</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:image</span>, <span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_user</span>, <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_agent</span>)
356:     <span class="ruby-ivar">@length_of_images</span> = <span class="ruby-identifier">images</span>.<span class="ruby-identifier">length</span> <span class="ruby-comment cmt"># Caching this because the call to #images is expensive and we don't want to do it twice.</span>
357:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">images</span>
358:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000449"><br/></a>
<div class="method_block"><h3>
<a href='#M000449'>


in_hierarchy

(search_hierarchy_id = 0)

</a>
</h3>

<p class="source_link" id="M000449-show-link"><a onclick="toggle('M000449-source'); toggleText('M000449-link'); return false;" href="#" id="M000449-link">Show source...</a></p><div class="source" id="M000449-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 59</span>
59:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">in_hierarchy</span>(<span class="ruby-identifier">search_hierarchy_id</span> = <span class="ruby-value">0</span>)
60:     <span class="ruby-identifier">enries</span> = <span class="ruby-identifier">hierarchy_entries</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">he</span><span class="ruby-operator">|</span> <span class="ruby-identifier">he</span>.<span class="ruby-identifier">hierarchy_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">search_hierarchy_id</span> }
61:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">enries</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">false</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">true</span>
62:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000491"><br/></a>
<div class="method_block"><h3>
<a href='#M000491'>


is_curatable_by?

(user)

</a>
</h3>

<p class="source_link" id="M000491-show-link"><a onclick="toggle('M000491-source'); toggleText('M000491-link'); return false;" href="#" id="M000491-link">Show source...</a></p><div class="source" id="M000491-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 434</span>
434:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_curatable_by?</span> <span class="ruby-identifier">user</span>
435:     <span class="ruby-identifier">he_all</span> = <span class="ruby-constant">TaxonConcept</span>.<span class="ruby-identifier">direct_ancestors</span>(<span class="ruby-keyword kw">self</span>)
436:     <span class="ruby-comment cmt"># hierarchy_entries_with_parents_above_clade = hierarchy_entries_with_parents</span>
437:     <span class="ruby-comment cmt"># hierarchy_entries_with_parents_above_clade</span>
438:     <span class="ruby-identifier">permitted</span> = <span class="ruby-identifier">he_all</span>.<span class="ruby-identifier">find</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">curator_hierarchy_entry_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">id</span> }
439:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">permitted</span> <span class="ruby-keyword kw">then</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">else</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">end</span>
440:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000483"><br/></a>
<div class="method_block"><h3>
<a href='#M000483'>


iucn

()

</a>
</h3>

<p class="source_link" id="M000483-show-link"><a onclick="toggle('M000483-source'); toggleText('M000483-link'); return false;" href="#" id="M000483-link">Show source...</a></p><div class="source" id="M000483-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 375</span>
375:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">iucn</span>
376:     <span class="ruby-comment cmt"># Notice that we use find_by, not find_all_by.  We require that only one match (or no match) is found.</span>
377:     <span class="ruby-identifier">my_iucn</span> = <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">find_by_sql</span>([<span class="ruby-value str">&quot;\n    SELECT distinct do.*\n      FROM taxon_concept_names tcn\n        JOIN taxa t ON (tcn.name_id=t.name_id)\n        JOIN harvest_events_taxa het ON (t.id=het.taxon_id)\n        JOIN harvest_events he ON (het.harvest_event_id=he.id)\n        JOIN data_objects_taxa dot ON (t.id=dot.taxon_id)\n        JOIN data_objects do ON (dot.data_object_id=do.id)\n      WHERE tcn.taxon_concept_id = ?\n        AND he.resource_id = 3 \n      LIMIT 1 # TaxonConcept.iucn\n\n&quot;</span>, <span class="ruby-identifier">id</span>])[<span class="ruby-value">0</span>]
378:     <span class="ruby-identifier">temp_iucn</span> = <span class="ruby-identifier">my_iucn</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:source_url</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'http://www.iucnredlist.org/'</span>, <span class="ruby-identifier">:description</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'NOT EVALUATED'</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">my_iucn</span>
379:     <span class="ruby-identifier">temp_iucn</span>.<span class="ruby-identifier">instance_eval</span> { <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">agent_url</span>; <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Agent</span>.<span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">homepage</span>; <span class="ruby-keyword kw">end</span> }
380:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">temp_iucn</span>
381:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000473"><br/></a>
<div class="method_block"><h3>
<a href='#M000473'>


iucn_conservation_status

()

</a>
</h3>

<p class="source_link" id="M000473-show-link"><a onclick="toggle('M000473-source'); toggleText('M000473-link'); return false;" href="#" id="M000473-link">Show source...</a></p><div class="source" id="M000473-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 319</span>
319:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">iucn_conservation_status</span>
320:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">description</span>
321:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000474"><br/></a>
<div class="method_block"><h3>
<a href='#M000474'>


iucn_conservation_status_url

()

</a>
</h3>

<p class="source_link" id="M000474-show-link"><a onclick="toggle('M000474-source'); toggleText('M000474-link'); return false;" href="#" id="M000474-link">Show source...</a></p><div class="source" id="M000474-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 323</span>
323:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">iucn_conservation_status_url</span>
324:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:agent_url</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">agent_url</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">iucn</span>.<span class="ruby-identifier">source_url</span>
325:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000459"><br/></a>
<div class="method_block"><h3>
<a href='#M000459'>


map

()

</a>
</h3>

<p class="source_link" id="M000459-show-link"><a onclick="toggle('M000459-source'); toggleText('M000459-link'); return false;" href="#" id="M000459-link">Show source...</a></p><div class="source" id="M000459-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 116</span>
116:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">map</span>
117:     <span class="ruby-comment cmt"># NOTE: there may be more than one map, but we only need one.</span>
118:     <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">for_taxon</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:map</span>, <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_agent</span>, <span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_user</span>)[<span class="ruby-value">0</span>]
119:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000450"><br/></a>
<div class="method_block"><h3>
<a href='#M000450'>


mappings

()

</a>
</h3>
<p>
Because nested has_many_through won&#8216;t work with CPKs: Also, so we can
include collection.
</p>

<p class="source_link" id="M000450-show-link"><a onclick="toggle('M000450-source'); toggleText('M000450-link'); return false;" href="#" id="M000450-link">Show source...</a></p><div class="source" id="M000450-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 66</span>
66:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">mappings</span>
67:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@mappings</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@mappings</span>.<span class="ruby-identifier">nil?</span>
68:     <span class="ruby-ivar">@mappings</span> = <span class="ruby-constant">Mapping</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;SELECT DISTINCT m.id, m.collection_id, m.name_id, m.foreign_key FROM taxon_concept_names tcn JOIN mappings m ON (tcn.name_id=m.name_id) JOIN collections c ON (m.collection_id=c.id) JOIN agents a ON (c.agent_id=a.id) WHERE tcn.taxon_concept_id = #{id} GROUP BY c.id&quot;</span>)
69:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@mappings</span> = <span class="ruby-ivar">@mappings</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">uniq</span>
70:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000456"><br/></a>
<div class="method_block"><h3>
<a href='#M000456'>


more_images

()

</a>
</h3>
<p>
TODO - I believe these methods are obsolete (the more_* methods) TODO =
$MAX_IMAGES_PER_PAGE really should BE an int.
</p>

<p class="source_link" id="M000456-show-link"><a onclick="toggle('M000456-source'); toggleText('M000456-link'); return false;" href="#" id="M000456-link">Show source...</a></p><div class="source" id="M000456-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 100</span>
100:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">more_images</span>
101:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@length_of_images</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">$MAX_IMAGES_PER_PAGE</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@length_of_images</span>
102:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">images</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">$MAX_IMAGES_PER_PAGE</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-comment cmt"># This is expensive.  I hope you called #images first!</span>
103:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000457"><br/></a>
<div class="method_block"><h3>
<a href='#M000457'>


more_videos

()

</a>
</h3>

<p class="source_link" id="M000457-show-link"><a onclick="toggle('M000457-source'); toggleText('M000457-link'); return false;" href="#" id="M000457-link">Show source...</a></p><div class="source" id="M000457-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 105</span>
105:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">more_videos</span> 
106:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@length_of_videos</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">$MAX_IMAGES_PER_PAGE</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@length_of_videos</span>
107:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">videos</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">$MAX_IMAGES_PER_PAGE</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-comment cmt"># This is expensive.  I hope you called #videos first!</span>
108:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000446"><br/></a>
<div class="method_block"><h3>
<a href='#M000446'>


name

(detail_level = :middle, language = Language.english, context = nil)

</a>
</h3>

<p class="source_link" id="M000446-show-link"><a onclick="toggle('M000446-source'); toggleText('M000446-link'); return false;" href="#" id="M000446-link">Show source...</a></p><div class="source" id="M000446-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 43</span>
43:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">name</span>(<span class="ruby-identifier">detail_level</span> = <span class="ruby-identifier">:middle</span>, <span class="ruby-identifier">language</span> = <span class="ruby-constant">Language</span>.<span class="ruby-identifier">english</span>, <span class="ruby-identifier">context</span> = <span class="ruby-keyword kw">nil</span>)
44:     <span class="ruby-identifier">default_hierarchy_id</span> = <span class="ruby-constant">Hierarchy</span>.<span class="ruby-identifier">default</span>.<span class="ruby-identifier">id</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
45:     <span class="ruby-identifier">col_he</span> = <span class="ruby-identifier">hierarchy_entries</span>.<span class="ruby-identifier">detect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">he</span><span class="ruby-operator">|</span> <span class="ruby-identifier">he</span>.<span class="ruby-identifier">hierarchy_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">default_hierarchy_id</span> }
46:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">col_he</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-identifier">alternate_classification_name</span>(<span class="ruby-identifier">detail_level</span>, <span class="ruby-identifier">language</span>, <span class="ruby-identifier">context</span>).<span class="ruby-identifier">firstcap</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">col_he</span>.<span class="ruby-identifier">name</span>(<span class="ruby-identifier">detail_level</span>, <span class="ruby-identifier">language</span>, <span class="ruby-identifier">context</span>).<span class="ruby-identifier">firstcap</span>
47:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000451"><br/></a>
<div class="method_block"><h3>
<a href='#M000451'>


ping_host_urls

()

</a>
</h3>
<p>
I chose not to make this singleton since it should really only ever get
called once:
</p>

<p class="source_link" id="M000451-show-link"><a onclick="toggle('M000451-source'); toggleText('M000451-link'); return false;" href="#" id="M000451-link">Show source...</a></p><div class="source" id="M000451-source"><pre>    <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 73</span>
73:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ping_host_urls</span>
74:     <span class="ruby-identifier">host_urls</span> = []
75:     <span class="ruby-identifier">mappings</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">mapping</span><span class="ruby-operator">|</span>
76:       <span class="ruby-identifier">host_urls</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">mapping</span>.<span class="ruby-identifier">ping_host_url</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">mapping</span>.<span class="ruby-identifier">collection</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">mapping</span>.<span class="ruby-identifier">ping_host?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">false</span> 
77:     <span class="ruby-keyword kw">end</span>
78:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">host_urls</span>
79:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000469"><br/></a>
<div class="method_block"><h3>
<a href='#M000469'>


quick_common_name

(language = nil)

</a>
</h3>

<p class="source_link" id="M000469-show-link"><a onclick="toggle('M000469-source'); toggleText('M000469-link'); return false;" href="#" id="M000469-link">Show source...</a></p><div class="source" id="M000469-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 180</span>
180:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">quick_common_name</span>(<span class="ruby-identifier">language</span> = <span class="ruby-keyword kw">nil</span>)
181:     <span class="ruby-identifier">language</span> <span class="ruby-operator">||=</span> (<span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-constant">Language</span>.<span class="ruby-identifier">english</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">language</span>) <span class="ruby-operator">||</span> <span class="ruby-constant">Language</span>.<span class="ruby-identifier">english</span>
182:     <span class="ruby-identifier">common_name_results</span> = <span class="ruby-constant">SpeciesSchemaModel</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">select_values</span>(<span class="ruby-node">&quot;SELECT n.string FROM taxon_concept_names tcn JOIN names n ON (tcn.name_id=n.id) WHERE tcn.taxon_concept_id=#{id} AND language_id=#{language.id} AND preferred=1 LIMIT 1&quot;</span>)
183:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">common_name_results</span>.<span class="ruby-identifier">empty?</span>
184:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;&quot;</span>
185:     <span class="ruby-keyword kw">end</span>
186:     
187:     <span class="ruby-identifier">common_name_results</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">firstcap</span>
188:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000470"><br/></a>
<div class="method_block"><h3>
<a href='#M000470'>


quick_scientific_name

(type = :normal)

</a>
</h3>

<p class="source_link" id="M000470-show-link"><a onclick="toggle('M000470-source'); toggleText('M000470-link'); return false;" href="#" id="M000470-link">Show source...</a></p><div class="source" id="M000470-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 190</span>
190:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">quick_scientific_name</span>(<span class="ruby-identifier">type</span> = <span class="ruby-identifier">:normal</span>)
191:     <span class="ruby-identifier">scientific_name_results</span> = []
192:     <span class="ruby-comment cmt"># TODO - refactor this.  Duplication where italicized, but I think all four queries could be generalized.</span>
193:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">type</span>
194:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:normal</span>      <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">scientific_name_results</span> = <span class="ruby-constant">SpeciesSchemaModel</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;SELECT n.string name, he.hierarchy_id source_hierarchy_id FROM taxon_concept_names tcn JOIN names n ON (tcn.name_id=n.id) LEFT JOIN hierarchy_entries he ON (tcn.source_hierarchy_entry_id=he.id) WHERE tcn.taxon_concept_id=#{id} AND vern=0 AND preferred=1&quot;</span>).<span class="ruby-identifier">all_hashes</span>
195:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:italicized</span>  <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">scientific_name_results</span> = <span class="ruby-constant">SpeciesSchemaModel</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;SELECT n.italicized name, he.hierarchy_id source_hierarchy_id FROM taxon_concept_names tcn JOIN names n ON (tcn.name_id=n.id) LEFT JOIN hierarchy_entries he ON (tcn.source_hierarchy_entry_id=he.id) WHERE tcn.taxon_concept_id=#{id} AND vern=0 AND preferred=1&quot;</span>).<span class="ruby-identifier">all_hashes</span>
196:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:canonical</span>   <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">scientific_name_results</span> = <span class="ruby-constant">SpeciesSchemaModel</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-node">&quot;SELECT cf.string name, he.hierarchy_id source_hierarchy_id FROM taxon_concept_names tcn JOIN names n ON (tcn.name_id=n.id) JOIN canonical_forms cf ON (n.canonical_form_id=cf.id) LEFT JOIN hierarchy_entries he ON (tcn.source_hierarchy_entry_id=he.id) WHERE tcn.taxon_concept_id=#{id} AND vern=0 AND preferred=1&quot;</span>).<span class="ruby-identifier">all_hashes</span>
197:     <span class="ruby-keyword kw">end</span>
198:     
199:     <span class="ruby-identifier">scientific_name</span> = <span class="ruby-value str">&quot;&quot;</span>
200:     
201:     <span class="ruby-comment cmt"># This loop is to check to make sure the default hierarchy's preferred name takes precedence over other hierarchy's preferred names </span>
202:     <span class="ruby-identifier">scientific_name_results</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">result</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
203:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scientific_name</span><span class="ruby-operator">==</span><span class="ruby-value str">&quot;&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">result</span>[<span class="ruby-value str">'source_hierarchy_id'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Hierarchy</span>.<span class="ruby-identifier">default</span>.<span class="ruby-identifier">id</span>
204:         <span class="ruby-identifier">scientific_name</span> = <span class="ruby-identifier">result</span>[<span class="ruby-value str">'name'</span>].<span class="ruby-identifier">firstcap</span>
205:       <span class="ruby-keyword kw">end</span>
206:     <span class="ruby-keyword kw">end</span>
207:     
208:     <span class="ruby-identifier">scientific_name</span>
209:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000467"><br/></a>
<div class="method_block"><h3>
<a href='#M000467'>


scientific_name

()

</a>
</h3>

<p class="source_link" id="M000467-show-link"><a onclick="toggle('M000467-source'); toggleText('M000467-link'); return false;" href="#" id="M000467-link">Show source...</a></p><div class="source" id="M000467-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 171</span>
171:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">scientific_name</span>
172:     <span class="ruby-identifier">tcn</span> = <span class="ruby-identifier">taxon_concept_names</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">vern</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">preferred</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">n</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">nil?</span> }.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">source_hierarchy_entry_id</span> = <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">id</span> }
173:     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;TCN name id: #{tcn.name_id}&quot;</span>
174:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">tcn</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-identifier">name</span>(<span class="ruby-identifier">:expert</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">tcn</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">string</span>
175:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000487"><br/></a>
<div class="method_block"><h3>
<a href='#M000487'>


smart_image

()

</a>
</h3>

<p class="source_link" id="M000487-show-link"><a onclick="toggle('M000487-source'); toggleText('M000487-link'); return false;" href="#" id="M000487-link">Show source...</a></p><div class="source" id="M000487-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 405</span>
405:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">smart_image</span>
406:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">images</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">images</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">smart_image</span>
407:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000486"><br/></a>
<div class="method_block"><h3>
<a href='#M000486'>


smart_medium_thumb

()

</a>
</h3>

<p class="source_link" id="M000486-show-link"><a onclick="toggle('M000486-source'); toggleText('M000486-link'); return false;" href="#" id="M000486-link">Show source...</a></p><div class="source" id="M000486-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 401</span>
401:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">smart_medium_thumb</span>
402:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">images</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">images</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">smart_medium_thumb</span>
403:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000485"><br/></a>
<div class="method_block"><h3>
<a href='#M000485'>


smart_thumb

()

</a>
</h3>

<p class="source_link" id="M000485-show-link"><a onclick="toggle('M000485-source'); toggleText('M000485-link'); return false;" href="#" id="M000485-link">Show source...</a></p><div class="source" id="M000485-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 397</span>
397:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">smart_thumb</span>
398:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">images</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">images</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">smart_thumb</span>
399:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000482"><br/></a>
<div class="method_block"><h3>
<a href='#M000482'>


subtitle

()

</a>
</h3>

<p class="source_link" id="M000482-show-link"><a onclick="toggle('M000482-source'); toggleText('M000482-link'); return false;" href="#" id="M000482-link">Show source...</a></p><div class="source" id="M000482-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 367</span>
367:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">subtitle</span>
368:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@subtitle</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@subtitle</span>.<span class="ruby-identifier">nil?</span>
369:     <span class="ruby-identifier">subtitle</span> = <span class="ruby-identifier">quick_common_name</span>()
370:     <span class="ruby-identifier">subtitle</span> = <span class="ruby-identifier">quick_scientific_name</span>(<span class="ruby-identifier">:canonical</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">subtitle</span>.<span class="ruby-identifier">empty?</span>
371:     <span class="ruby-identifier">subtitle</span> = <span class="ruby-node">&quot;&lt;i&gt;#{subtitle}&lt;/i&gt;&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">subtitle</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">subtitle</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/&lt;i&gt;/</span>
372:     <span class="ruby-ivar">@subtitle</span> = <span class="ruby-identifier">subtitle</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-identifier">name</span>() <span class="ruby-operator">:</span> <span class="ruby-identifier">subtitle</span>
373:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000478"><br/></a>
<div class="method_block"><h3>
<a href='#M000478'>


table_of_contents

(options = {})

</a>
</h3>
<p>
pull list of categories for given taxa id
</p>

<p class="source_link" id="M000478-show-link"><a onclick="toggle('M000478-source'); toggleText('M000478-link'); return false;" href="#" id="M000478-link">Show source...</a></p><div class="source" id="M000478-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 340</span>
340:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">table_of_contents</span>(<span class="ruby-identifier">options</span> = {})
341:     <span class="ruby-comment cmt">#options = options.merge(:agent_id =&gt; @current_agent.id) unless @current_agent.nil?</span>
342:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@table_of_contents</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TocItem</span>.<span class="ruby-identifier">toc_for</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_agent</span>, <span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_user</span>)
343:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000481"><br/></a>
<div class="method_block"><h3>
<a href='#M000481'>


title

()

</a>
</h3>
<p>
<a href="TaxonConcept.html#M000481">title</a> and sub-<a
href="TaxonConcept.html#M000481">title</a> depend on expertise level of the
user that is passed in (default to novice if none specified)
</p>

<p class="source_link" id="M000481-show-link"><a onclick="toggle('M000481-source'); toggleText('M000481-link'); return false;" href="#" id="M000481-link">Show source...</a></p><div class="source" id="M000481-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 361</span>
361:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">title</span>
362:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@title</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@title</span>.<span class="ruby-identifier">nil?</span>
363:     <span class="ruby-identifier">title</span> = <span class="ruby-identifier">quick_scientific_name</span>(<span class="ruby-identifier">:italicized</span>)
364:     <span class="ruby-ivar">@title</span> = <span class="ruby-identifier">title</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-identifier">name</span>(<span class="ruby-identifier">:scientific</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">title</span>
365:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000458"><br/></a>
<div class="method_block"><h3>
<a href='#M000458'>


videos

()

</a>
</h3>

<p class="source_link" id="M000458-show-link"><a onclick="toggle('M000458-source'); toggleText('M000458-link'); return false;" href="#" id="M000458-link">Show source...</a></p><div class="source" id="M000458-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 110</span>
110:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">videos</span>
111:     <span class="ruby-identifier">videos</span> = <span class="ruby-constant">DataObject</span>.<span class="ruby-identifier">for_taxon</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:video</span>, <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_agent</span>, <span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_user</span>)
112:     <span class="ruby-ivar">@length_of_videos</span> = <span class="ruby-identifier">videos</span>.<span class="ruby-identifier">length</span> <span class="ruby-comment cmt"># cached, so we don't have to query this again.</span>
113:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">videos</span>
114:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000495"><br/></a>
<div class="method_block"><h3>
<a href='#M000495'>


visible_comments

(user = @current_user)

</a>
</h3>

<p class="source_link" id="M000495-show-link"><a onclick="toggle('M000495-source'); toggleText('M000495-link'); return false;" href="#" id="M000495-link">Show source...</a></p><div class="source" id="M000495-source"><pre>     <span class="ruby-comment cmt"># File app/models/taxon_concept.rb, line 519</span>
519:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">visible_comments</span>(<span class="ruby-identifier">user</span> = <span class="ruby-ivar">@current_user</span>)
520:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">comments</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">not</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">nil?</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">is_moderator?</span>
521:     <span class="ruby-identifier">comments</span>.<span class="ruby-identifier">find_all</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">comment</span><span class="ruby-operator">|</span> <span class="ruby-identifier">comment</span>.<span class="ruby-identifier">visible?</span> }
522:   <span class="ruby-keyword kw">end</span></pre></div>
</div>





</div><div class="clear" id="footer">Generated on Jan 21, 2008 / Allison 2 &copy; 2007 <a href="http://cloudbur.st">Cloudburst, LLC</a></div></div></body></html>