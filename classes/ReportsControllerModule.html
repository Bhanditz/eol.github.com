<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>Module: ReportsControllerModule [Rails Application Documentation]</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <link href='.././rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Module</span>
          ReportsControllerModule
        </h1>
        <ol class='paths'>
          <li>
            <a href="../files/lib/reports_controller_module_rb.html">lib/reports_controller_module.rb</a>
          </li>
        </ol>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            <p>
            Because ContentPartner::ReportsController and <a
            href="Administrator/ReportsController.html">Administrator::ReportsController</a>
            are the same, except they&#8217;re in different namespaces / sections of
            the site and have different filters / authentication / etc, we put all of
            the actual logic in this module and simply include it within the 2
            controllers
            </p>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public class</h3>
            <ol>
              <li><a href="#M000755">included</a></li>
            </ol>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000757">catch_all</a></li>
              <li><a href="#M000756">index</a></li>
            </ol>
            <h3>protected instance</h3>
            <ol>
              <li><a href="#M000759">chart_data</a></li>
              <li><a href="#M000760">chart_settings</a></li>
              <li><a href="#M000758">report</a></li>
            </ol>
          </div>
          <div id='context'>
            <div id='includes'>
              <h2>Included modules</h2>
              <ol>
                <li>GeoKit::Geocoders</li>
              </ol>
            </div>
          </div>
          <div id='section'>
            <div id='methods'>
              <h2>Public class methods</h2>
              <div class='public-class method' id='method-M000755'>
                <a name='M000755'>      </a>
                <div class='synopsis'>
                  <span class='name'>included</span>
                  <span class='arguments'>(base)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000755-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000755-source'>    <span class="ruby-comment cmt"># File lib/reports_controller_module.rb, line 8</span>&#x000A; 8:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">included</span> <span class="ruby-identifier">base</span>&#x000A; 9:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'csv'</span>&#x000A;10:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'geo_kit/geocoders'</span>&#x000A;11:     <span class="ruby-identifier">base</span>.<span class="ruby-identifier">instance_eval</span> {&#x000A;12:       <span class="ruby-identifier">include</span> <span class="ruby-constant">GeoKit</span><span class="ruby-operator">::</span><span class="ruby-constant">Geocoders</span>&#x000A;13:       <span class="ruby-identifier">before_filter</span> <span class="ruby-identifier">:set_report</span>&#x000A;14:       <span class="ruby-identifier">before_filter</span> <span class="ruby-identifier">:enable_amcharts</span>, <span class="ruby-identifier">:set_date_range</span>, <span class="ruby-identifier">:set_show_other</span>, <span class="ruby-identifier">:if</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:valid_report?</span>&#x000A;15:     }&#x000A;16:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Public instance methods</h2>
              <div class='public-instance method' id='method-M000757'>
                <a name='M000757'>      </a>
                <div class='synopsis'>
                  <span class='name'>catch_all</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  this is the only public method on this controller (except index). ALL calls
                  go through this method (except index). see config/routes.rb
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000757-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000757-source'>    <span class="ruby-comment cmt"># File lib/reports_controller_module.rb, line 25</span>&#x000A;25:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">catch_all</span>&#x000A;26:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">valid_report?</span>&#x000A;27:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;Report not found for #{ params[:report] }&quot;</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">404</span>&#x000A;28:       <span class="ruby-keyword kw">return</span>&#x000A;29:     <span class="ruby-keyword kw">end</span>&#x000A;30:     &#x000A;31:     <span class="ruby-ivar">@admin_header</span>=<span class="ruby-node">&quot;Data Usage Reports - #{params[:report].capitalize.gsub('_',' ')}&quot;</span>&#x000A;32:     <span class="ruby-ivar">@this_month_start_date</span>=<span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">day</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>&#x000A;33:     <span class="ruby-ivar">@this_month_end_date</span>=<span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>&#x000A;34:     <span class="ruby-ivar">@last_month_start_date</span>=(<span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">day</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)<span class="ruby-operator">-</span><span class="ruby-value">1</span>.<span class="ruby-identifier">month</span>&#x000A;35:     <span class="ruby-ivar">@last_month_end_date</span>=<span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">day</span>&#x000A;36:     <span class="ruby-ivar">@this_year_start_date</span>=<span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-value str">'-01-01'</span>&#x000A;37:     <span class="ruby-ivar">@this_year_end_date</span>=<span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>&#x000A;38:     &#x000A;39:     <span class="ruby-comment cmt"># throwing this here for now ...</span>&#x000A;40:     <span class="ruby-ivar">@show_agent</span> = <span class="ruby-identifier">current_agent</span>.<span class="ruby-identifier">nil?</span>&#x000A;41:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">RAILS_ENV</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'development'</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-regexp re">/\/mine!$/</span>]&#x000A;42:       <span class="ruby-ivar">@log_daily_class</span>.<span class="ruby-identifier">delete_all</span>&#x000A;43:       <span class="ruby-ivar">@log_daily_class</span>.<span class="ruby-identifier">mine</span> &#x000A;44:     <span class="ruby-keyword kw">end</span>&#x000A;45:     <span class="ruby-ivar">@totals</span> = <span class="ruby-ivar">@log_daily_class</span>.<span class="ruby-identifier">grand_totals</span> <span class="ruby-ivar">@start_date</span><span class="ruby-operator">..</span><span class="ruby-ivar">@end_date</span>, <span class="ruby-identifier">:agent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_agent</span>, <span class="ruby-identifier">:include_percentage</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>, &#x000A;46:                                  <span class="ruby-identifier">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:page</span>], <span class="ruby-identifier">:per_page</span> =<span class="ruby-operator">&gt;</span> ( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:per_page</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">LogDaily</span><span class="ruby-operator">::</span><span class="ruby-constant">DEFAULT_PER_PAGE</span> )&#x000A;47:     <span class="ruby-identifier">calculate_percentages</span>&#x000A;48: &#x000A;49:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-regexp re">/_settings$/</span>]&#x000A;50:       <span class="ruby-identifier">chart_settings</span>&#x000A;51:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-regexp re">/_data$/</span>]&#x000A;52:       <span class="ruby-identifier">chart_data</span>&#x000A;53:     <span class="ruby-keyword kw">else</span>&#x000A;54:       <span class="ruby-identifier">report</span>&#x000A;55:     <span class="ruby-keyword kw">end</span>&#x000A;56:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000756'>
                <a name='M000756'>      </a>
                <div class='synopsis'>
                  <span class='name'>index</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000756-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000756-source'>    <span class="ruby-comment cmt"># File lib/reports_controller_module.rb, line 18</span>&#x000A;18:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>&#x000A;19:     <span class="ruby-ivar">@admin_header</span>=<span class="ruby-value str">&quot;Data Usage Reports&quot;</span>&#x000A;20:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:template</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'reports/index'</span>&#x000A;21:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Protected instance methods</h2>
              <div class='protected-instance method' id='method-M000759'>
                <a name='M000759'>      </a>
                <div class='synopsis'>
                  <span class='name'>chart_data</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000759-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000759-source'>    <span class="ruby-comment cmt"># File lib/reports_controller_module.rb, line 76</span>&#x000A;76:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">chart_data</span>&#x000A;77:       <span class="ruby-identifier">chart</span> = <span class="ruby-constant">Ambling</span><span class="ruby-operator">::</span><span class="ruby-constant">Data</span><span class="ruby-operator">::</span><span class="ruby-constant">Pie</span>.<span class="ruby-identifier">new</span>()&#x000A;78:       <span class="ruby-ivar">@totals</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>&#x000A;79:         <span class="ruby-identifier">chart</span>.<span class="ruby-identifier">slices</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Ambling</span><span class="ruby-operator">::</span><span class="ruby-constant">Data</span><span class="ruby-operator">::</span><span class="ruby-constant">Slice</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">round_to_2_decimal_places</span>(<span class="ruby-identifier">n</span>.<span class="ruby-identifier">percentage</span>), <span class="ruby-identifier">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">unique_data_to_s</span> )&#x000A;80:       <span class="ruby-keyword kw">end</span>&#x000A;81:       <span class="ruby-identifier">chart</span>.<span class="ruby-identifier">slices</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Ambling</span><span class="ruby-operator">::</span><span class="ruby-constant">Data</span><span class="ruby-operator">::</span><span class="ruby-constant">Slice</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">round_to_2_decimal_places</span>(<span class="ruby-ivar">@other_percentage</span>), <span class="ruby-identifier">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;Other&quot;</span> ) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@show_other</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@others_to_show</span>&#x000A;82:       <span class="ruby-identifier">xml</span> = <span class="ruby-identifier">chart</span>.<span class="ruby-identifier">to_xml</span>&#x000A;83:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">xml</span>&#x000A;84:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='protected-instance method' id='method-M000760'>
                <a name='M000760'>      </a>
                <div class='synopsis'>
                  <span class='name'>chart_settings</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000760-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000760-source'>    <span class="ruby-comment cmt"># File lib/reports_controller_module.rb, line 86</span>&#x000A;86:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">chart_settings</span>&#x000A;87:     <span class="ruby-identifier">settings</span> = <span class="ruby-identifier">default_pie_chart_settings</span>(<span class="ruby-value str">'Stuff'</span>)&#x000A;88:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">settings</span>.<span class="ruby-identifier">to_xml</span>&#x000A;89:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='protected-instance method' id='method-M000758'>
                <a name='M000758'>      </a>
                <div class='synopsis'>
                  <span class='name'>report</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  here be the &#8216;actions&#8217;
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000758-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000758-source'>    <span class="ruby-comment cmt"># File lib/reports_controller_module.rb, line 61</span>&#x000A;61:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">report</span>&#x000A;62:     <span class="ruby-comment cmt"># because of our abnormal path handling, respond_to doesn't seem to work here ...</span>&#x000A;63:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-regexp re">/\.xml$/</span>]&#x000A;64:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@totals</span>.<span class="ruby-identifier">to_xml</span>&#x000A;65: &#x000A;66:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:report</span>][<span class="ruby-regexp re">/\.csv$/</span>]&#x000A;67:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@totals</span>.<span class="ruby-identifier">to_csv</span>(<span class="ruby-identifier">:except</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:data_type_id</span>, <span class="ruby-identifier">:day</span>])&#x000A;68:       <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Content-Type'</span>] = <span class="ruby-value str">'text/csv; charset=iso-8859-1; header=present'</span>&#x000A;69:       <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Content-Disposition'</span>] = <span class="ruby-node">&quot;attachment; filename=#{@report}_#{Time.now.strftime(&quot;%m-%d-%Y&quot;)}.csv&quot;</span>&#x000A;70: &#x000A;71:     <span class="ruby-keyword kw">else</span>&#x000A;72:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:template</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'reports/generic'</span>&#x000A;73:     <span class="ruby-keyword kw">end</span>&#x000A;74:   <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
